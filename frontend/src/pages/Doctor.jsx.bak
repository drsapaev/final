import React, { useEffect, useMemo, useState } from "react";
import Nav from "../components/Nav.jsx";
import RoleGate from "../components/RoleGate.jsx";
import { api } from "../api/client.js";

function todayStr() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${dd}`;
}

/**
 * Р­РєСЂР°РЅ РІСЂР°С‡Р°: СЃРїРёСЃРѕРє РІРёР·РёС‚РѕРІ Р·Р° РґРµРЅСЊ (С‚РѕР»СЊРєРѕ С‡С‚РµРЅРёРµ).
 * РњРёРЅРёРјР°Р»СЊРЅС‹Рµ Р·Р°РІРёСЃРёРјРѕСЃС‚Рё РѕС‚ API: GET /visits?d=YYYY-MM-DD&limit=... (РёР»Рё РїСЂРѕСЃС‚Рѕ /visits).
 */
export default function Doctor() {
  const [page, setPage] = useState("Doctor");
  const [date, setDate] = useState(todayStr());
  const [rows, setRows] = useState([]);
  const [q, setQ] = useState("");
  const [busy, setBusy] = useState(false);
  const [err, setErr] = useState("");

  async function load() {
    setBusy(true);
    setErr("");
    try {
      // РџР°СЂР°РјРµС‚СЂС‹ РјР°РєСЃРёРјР°Р»СЊРЅРѕ РЅРµР№С‚СЂР°Р»СЊРЅС‹Рµ: РµСЃР»Рё backend РЅРµ РїРѕРЅРёРјР°РµС‚ d, РїСЂРѕСЃС‚Рѕ РІРµСЂРЅС‘С‚ РІСЃРµ.
      const res = await api.get("/visits", { params: { d: date, limit: 100 } });
      const items = Array.isArray(res?.items) ? res.items : Array.isArray(res) ? res : [];
      setRows(items);
    } catch (e) {
      setErr(e?.data?.detail || e?.message || "РћС€РёР±РєР° Р·Р°РіСЂСѓР·РєРё СЃРїРёСЃРєР° РІРёР·РёС‚РѕРІ");
    } finally {
      setBusy(false);
    }
  }

  useEffect(() => { load(); }, [date]);

  const filtered = useMemo(() => {
    if (!q) return rows;
    const qq = q.toLowerCase();
    return rows.filter(v =>
      String(v.patient_name || v.patient?.full_name || v.patient?.name || "")
        .toLowerCase().includes(qq) ||
      String(v.id || "").toLowerCase().includes(qq) ||
      String(v.status || "").toLowerCase().includes(qq)
    );
  }, [q, rows]);

  return (
    <div>
      <Nav active={page} onNavigate={setPage} />
      <RoleGate roles={["Admin", "Doctor"]}>
        <div style={{ padding: 16, display: "grid", gap: 12 }}>
          <h2 style={{ margin: 0 }}>Р’СЂР°С‡</h2>

          <div style={panel}>
            <label>
              Р”Р°С‚Р°:&nbsp;
              <input type="date" value={date} onChange={(e)=>setDate(e.target.value)} style={inp}/>
            </label>
            <input placeholder="РџРѕРёСЃРє РїРѕ РїР°С†РёРµРЅС‚Сѓ/СЃС‚Р°С‚СѓСЃСѓ/ID" value={q} onChange={(e)=>setQ(e.target.value)} style={{...inp, minWidth: 240}}/>
            <button onClick={load} disabled={busy} style={btn}>
              {busy ? "Р—Р°РіСЂСѓР·РєР°" : "РћР±РЅРѕРІРёС‚СЊ"}
            </button>
          </div>

          {err && <div style={errBox}>{String(err)}</div>}

          <div style={{ overflow: "auto", border: "1px solid #eee", borderRadius: 12, background: "#fff" }}>
            <table style={{ width: "100%", borderCollapse: "collapse" }}>
              <thead>
                <tr>
                  <th style={th}>ID</th>
                  <th style={th}>РџР°С†РёРµРЅС‚</th>
                  <th style={th}>РЈСЃР»СѓРіРё</th>
                  <th style={th}>РЎС‚Р°С‚СѓСЃ</th>
                  <th style={th}>Р’СЂРµРјСЏ</th>
                </tr>
              </thead>
              <tbody>
                {filtered.map(v => (
                  <tr key={v.id}>
                    <td style={td}>{v.id}</td>
                    <td style={td}>{v.patient_name || v.patient?.full_name || v.patient?.name || "вЂ”"}</td>
                    <td style={td}>
                      {(v.services || v.items || []).map((s, i) => (
                        <span key={s.id || i}>
                          {s.name || s.title || s.code || "СѓСЃР»."}{i < (v.services||v.items||[]).length-1 ? ", " : ""}
                        </span>
                      ))}
                    </td>
                    <td style={td}>{v.status || "вЂ”"}</td>
                    <td style={td}>{v.created_at || v.started_at || "вЂ”"}</td>
                  </tr>
                ))}
                {filtered.length === 0 && (
                  <tr>
                    <td style={td} colSpan={5}>РќРµС‚ Р·Р°РїРёСЃРµР№</td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      </RoleGate>
    </div>
  );
}

const panel = { display: "flex", gap: 12, alignItems: "center", flexWrap: "wrap", border: "1px solid #eee", borderRadius: 12, padding: 12, background: "#fff" };
const inp = { padding: "6px 10px", border: "1px solid #ddd", borderRadius: 8, background: "#fff" };
const btn = { padding: "6px 10px", borderRadius: 8, border: "1px solid #ddd", background: "#fff", cursor: "pointer" };
const th = { textAlign: "left", padding: 10, borderBottom: "1px solid #eee", fontWeight: 700, whiteSpace: "nowrap" };
const td = { padding: 10, borderBottom: "1px solid #f3f4f6", verticalAlign: "top" };
const errBox = { color: "#7f1d1d", background: "#fee2e2", border: "1px solid #fecaca", borderRadius: 8, padding: 8 };
