# ๐ฑ ะัะบะพะฒะพะดััะฒะพ ะฟะพ ัะธััะตะผะต QR ะพัะตัะตะดะตะน

## ะะฑะทะพั ัะธััะตะผั

ะกะธััะตะผะฐ ะพะฝะปะฐะนะฝ-ะพัะตัะตะดะธ ะฟะพะทะฒะพะปัะตั ะฟะฐัะธะตะฝัะฐะผ ะทะฐะฟะธััะฒะฐัััั ะบ ะฒัะฐัั ัะตัะตะท QR ะบะพะด ั ัะพะฑะปัะดะตะฝะธะตะผ ะฒัะตะผะตะฝะฝัั ะพะณัะฐะฝะธัะตะฝะธะน ะธ ะฟัะฐะฒะธะป ะฑะธะทะฝะตั-ะปะพะณะธะบะธ ะบะปะธะฝะธะบะธ.

## ะััะธัะตะบัััะฐ

### Backend Endpoints

1. **ะะตะฝะตัะฐัะธั QR ัะพะบะตะฝะฐ** (ะดะปั ัะตะณะธัััะฐัะพัะฐ/ะฐะดะผะธะฝะธัััะฐัะพัะฐ)
   ```
   POST /api/v1/queue/qrcode?day=YYYY-MM-DD&specialist_id={id}
   Authorization: Bearer {token}
   ```
   
   ะัะฒะตั:
   ```json
   {
     "token": "uuid-token",
     "qr_url": "/queue/join?token=...",
     "expires_at": "2025-10-05T23:59:59",
     "specialist_name": "ะะพะบัะพั ะะฒะฐะฝะพะฒ",
     "day": "2025-10-05"
   }
   ```

2. **ะัััะฟะปะตะฝะธะต ะฒ ะพัะตัะตะดั** (ะฟัะฑะปะธัะฝัะน endpoint)
   ```
   POST /api/v1/queue/join
   {
     "token": "uuid-token",
     "phone": "+998901234567",
     "patient_name": "ะะฒะฐะฝ ะะฒะฐะฝะพะฒ"
   }
   ```

3. **ะกัะฐััั ะพัะตัะตะดะธ** (ะดะปั ัะตะณะธัััะฐัะพัะฐ/ะฒัะฐัะฐ)
   ```
   GET /api/v1/queue/status/{specialist_id}?target_date=YYYY-MM-DD
   Authorization: Bearer {token}
   ```

### Frontend Components

1. **ModernQueueManager** (`frontend/src/components/queue/ModernQueueManager.jsx`)
   - ะะตะฝะตัะฐัะธั QR ะบะพะดะพะฒ
   - ะัะพัะผะพัั ัะตะบััะตะน ะพัะตัะตะดะธ
   - ะฃะฟัะฐะฒะปะตะฝะธะต ะฟัะธัะผะพะผ
   - ะัะทะพะฒ ะฟะฐัะธะตะฝัะพะฒ

2. **OnlineQueueManager** (`frontend/src/components/queue/OnlineQueueManager.jsx`)
   - ะะพะปะฝะพััะฝะบัะธะพะฝะฐะปัะฝัะน UI ั Material-UI
   - ะัะฟะพะปัะทัะตั ััะบ `useQueueManager`

3. **QRTokenManager** (`frontend/src/components/admin/QRTokenManager.jsx`)
   - ะฃะฟัะฐะฒะปะตะฝะธะต ะฐะบัะธะฒะฝัะผะธ QR ัะพะบะตะฝะฐะผะธ
   - ะะตะฐะบัะธะฒะฐัะธั ัะพะบะตะฝะพะฒ
   - ะกัะฐัะธััะธะบะฐ ะธัะฟะพะปัะทะพะฒะฐะฝะธั

## ะะธะทะฝะตั-ะฟัะฐะฒะธะปะฐ

### ะัะตะผะตะฝะฝัะต ะพะณัะฐะฝะธัะตะฝะธั

1. **ะะบะฝะพ ะพะฝะปะฐะนะฝ-ะทะฐะฟะธัะธ**: 07:00 - 09:00
   - ะะฐัะธะตะฝัั ะผะพะณัั ะทะฐะฟะธัะฐัััั ะฒ ะพัะตัะตะดั ัะพะปัะบะพ ะฒ ััะพ ะฒัะตะผั
   - ะะพัะปะต 09:00 ะธะปะธ ะพัะบัััะธั ะฟัะธัะผะฐ ัะตะณะธัััะฐัะพัะพะผ ะทะฐะฟะธัั ะทะฐะบััะฒะฐะตััั

2. **ะกัะพะบ ะดะตะนััะฒะธั ัะพะบะตะฝะฐ**: ะะพ ะบะพะฝัะฐ ะดะฝั
   - QR ัะพะบะตะฝ ะณะตะฝะตัะธััะตััั ะฝะฐ ะบะพะฝะบัะตัะฝัั ะดะฐัั
   - ะะตะนััะฒัะตั ะดะพ 23:59:59 ััะพะน ะดะฐัั

3. **ะะฐะบัััะธะต ะพะฝะปะฐะนะฝ-ะทะฐะฟะธัะธ**:
   - ะะฒัะพะผะฐัะธัะตัะบะธ ะฟัะธ ะพัะบัััะธะธ ะฟัะธัะผะฐ ะฒ ัะตะณะธัััะฐัััะต
   - ะะพัะปะต ะพะบะพะฝัะฐะฝะธั ะฒัะตะผะตะฝะธ ะพะฝะปะฐะนะฝ-ะทะฐะฟะธัะธ (09:00)

### ะะพะณะธะบะฐ ัะฐะฑะพัั

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  1. ะะะะะกะขะะะขะะ ะณะตะฝะตัะธััะตั QR ะบะพะด                       โ
โ     - ะัะฑะธัะฐะตั ัะฟะตัะธะฐะปะธััะฐ                              โ
โ     - ะัะฑะธัะฐะตั ะดะฐัั (ัะตะณะพะดะฝั ะธะปะธ ะฑัะดััะฐั)               โ
โ     - ะกะธััะตะผะฐ ัะพะทะดะฐะตั ัะพะบะตะฝ                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
                          โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  2. ะะะฆะะะะข ัะบะฐะฝะธััะตั QR ะบะพะด                            โ
โ     - ะัะบััะฒะฐะตััั ัััะฐะฝะธัะฐ /queue/join?token=...        โ
โ     - ะัะพะฒะตััะตััั ะฒัะตะผะตะฝะฝะพะต ะพะบะฝะพ (07:00-09:00)          โ
โ     - ะัะพะฒะตััะตััั ััะพ ะฟัะธัะผ ะฝะต ะพัะบััั                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
                          โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  3. ะะะฆะะะะข ะฟะพะปััะฐะตั ะฝะพะผะตั ะฒ ะพัะตัะตะดะธ                    โ
โ     - ะะพะผะตั ะทะฐะฒะธัะธั ะพั ัะฟะตัะธะฐะปัะฝะพััะธ                    โ
โ     - ะะฐัะดะธะพะปะพะณะธั: 100+                                 โ
โ     - ะะตัะผะฐัะพะปะพะณะธั: 200+                                โ
โ     - ะกัะพะผะฐัะพะปะพะณะธั: 300+                                โ
โ     - ะะฑัะธะต: 1+                                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
                          โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  4. ะะะะะกะขะะะขะะ ะพัะบััะฒะฐะตั ะฟัะธัะผ                         โ
โ     - ะะฝะปะฐะนะฝ-ะทะฐะฟะธัั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะทะฐะบััะฒะฐะตััั           โ
โ     - ะะฐัะธะตะฝัั ะฒัะทัะฒะฐัััั ะฟะพ ะฟะพััะดะบั                    โ
โ     - ะัะฐั ะฒะธะดะธั ะพัะตัะตะดั ะฒ ัะฒะพัะผ ะธะฝัะตััะตะนัะต             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ะัะพะฒะตัะบะธ ะธ ะพะณัะฐะฝะธัะตะฝะธั

### ะัะธ ะณะตะฝะตัะฐัะธะธ QR

```javascript
// backend/app/api/v1/endpoints/queue.py
1. ะัะพะฒะตัะบะฐ ะฟัะฐะฒ (Admin ะธะปะธ Registrar)
2. ะัะพะฒะตัะบะฐ ัััะตััะฒะพะฒะฐะฝะธั ัะฟะตัะธะฐะปะธััะฐ
3. ะัะพะฒะตัะบะฐ ะดะฐัั (ะฝะต ะฒ ะฟัะพัะปะพะผ)
4. ะกะพะทะดะฐะฝะธะต/ะฟะพะปััะตะฝะธะต DailyQueue
5. ะะตะฝะตัะฐัะธั ัะฝะธะบะฐะปัะฝะพะณะพ ัะพะบะตะฝะฐ
```

### ะัะธ ะฒัััะฟะปะตะฝะธะธ ะฒ ะพัะตัะตะดั

```javascript
// backend/app/crud/online_queue.py
1. ะัะพะฒะตัะบะฐ ัะพะบะตะฝะฐ (ัััะตััะฒัะตั ะธ ะฐะบัะธะฒะตะฝ)
2. ะัะพะฒะตัะบะฐ ััะพะบะฐ ะดะตะนััะฒะธั ัะพะบะตะฝะฐ
3. ะัะพะฒะตัะบะฐ ััะพ ะพัะตัะตะดั ะฝะต ะพัะบัััะฐ (opened_at == None)
4. ะัะพะฒะตัะบะฐ ะฒัะตะผะตะฝะฝะพะณะพ ะพะบะฝะฐ (07:00-09:00)
5. ะัะพะฒะตัะบะฐ ะปะธะผะธัะฐ ะทะฐะฟะธัะตะน ะฝะฐ ะดะตะฝั
6. ะัะตะดะพัะฒัะฐัะตะฝะธะต ะดัะฑะปะธะบะฐัะพะฒ ะฟะพ ัะตะปะตัะพะฝั
```

## ะะฝัะตะณัะฐัะธั ะฒ RegistrarPanel

```jsx
import ModernQueueManager from './components/queue/ModernQueueManager';

// ะ RegistrarPanel.jsx
<ModernQueueManager
  selectedDate={selectedDate}
  selectedDoctor={selectedDoctor}
  doctors={doctors}
  onQueueUpdate={() => loadAppointments()}
/>
```

## API Endpoints Reference

### ะัะฝะพะฒะฝัะต endpoints

| ะะตัะพะด | Endpoint | ะะฟะธัะฐะฝะธะต | ะะพะปั |
|-------|----------|----------|------|
| POST | `/api/v1/queue/qrcode` | ะะตะฝะตัะฐัะธั QR ัะพะบะตะฝะฐ | Admin, Registrar |
| POST | `/api/v1/queue/join` | ะัััะฟะปะตะฝะธะต ะฒ ะพัะตัะตะดั | ะัะฑะปะธัะฝัะน |
| GET | `/api/v1/queue/status/{id}` | ะกัะฐััั ะพัะตัะตะดะธ | Admin, Registrar, Doctor |
| POST | `/api/v1/queue/open` | ะัะบัััะธะต ะฟัะธัะผะฐ | Admin, Registrar |
| POST | `/api/v1/queue/{id}/call-next` | ะัะทะฒะฐัั ัะปะตะดัััะตะณะพ | Admin, Registrar, Doctor |

### Legacy endpoints (ะดะปั ัะพะฒะผะตััะธะผะพััะธ)

| ะะตัะพะด | Endpoint | ะะฟะธัะฐะฝะธะต |
|-------|----------|----------|
| POST | `/api/v1/online-queue/qrcode` | Legacy ะณะตะฝะตัะฐัะธั QR |
| POST | `/api/v1/registrar/generate-qr` | ะะตะฝะตัะฐัะธั ะธะท ัะตะณะธัััะฐัััั |

## ะะพะดะตะปะธ ะดะฐะฝะฝัั

### DailyQueue
```python
day: date                    # ะะฐัะฐ ะฟัะธัะผะฐ
specialist_id: int           # ID ะฒัะฐัะฐ
active: bool                 # ะะบัะธะฒะฝะฐ ะปะธ ะพัะตัะตะดั
opened_at: datetime          # ะะพะณะดะฐ ะพัะบััั ะฟัะธัะผ (None = ะพะฝะปะฐะนะฝ-ะทะฐะฟะธัั)
online_start_time: str       # ะะฐัะฐะปะพ ะพะฝะปะฐะนะฝ-ะทะฐะฟะธัะธ (07:00)
online_end_time: str         # ะะพะฝะตั ะพะฝะปะฐะนะฝ-ะทะฐะฟะธัะธ (09:00)
max_online_entries: int      # ะะธะผะธั ะทะฐะฟะธัะตะน
```

### QueueToken
```python
token: str (UUID)            # ะฃะฝะธะบะฐะปัะฝัะน ัะพะบะตะฝ
day: date                    # ะะฐัะฐ ะดะตะนััะฒะธั
specialist_id: int           # ID ัะฟะตัะธะฐะปะธััะฐ
generated_by_user_id: int    # ะัะพ ัะณะตะฝะตัะธัะพะฒะฐะป
expires_at: datetime         # ะกัะพะบ ะดะตะนััะฒะธั (23:59:59)
active: bool                 # ะะบัะธะฒะตะฝ ะปะธ ัะพะบะตะฝ
```

### OnlineQueueEntry
```python
id: int
queue_id: int                # ะกะฒัะทั ั DailyQueue
number: int                  # ะะพะผะตั ะฒ ะพัะตัะตะดะธ
patient_name: str            # ะะผั ะฟะฐัะธะตะฝัะฐ
phone: str                   # ะขะตะปะตัะพะฝ
telegram_id: int             # ID ะฒ Telegram (ะพะฟัะธะพะฝะฐะปัะฝะพ)
status: str                  # waiting, called, completed, cancelled
source: str                  # online, registrar, telegram
created_at: datetime
```

## ะะฐัััะพะนะบะฐ

### ะะทะผะตะฝะตะฝะธะต ะฒัะตะผะตะฝะธ ะพะฝะปะฐะนะฝ-ะทะฐะฟะธัะธ

ะ `backend/app/services/queue_service.py`:
```python
ONLINE_QUEUE_START_TIME = time(7, 0)   # 07:00
ONLINE_QUEUE_END_TIME = time(9, 0)     # 09:00 (ะพะฟัะธะพะฝะฐะปัะฝะพ)
```

ะ `backend/app/crud/online_queue.py`:
```python
queue_settings = get_queue_settings(db)
queue_start_hour = queue_settings.get("queue_start_hour", 7)
```

### ะะฐัััะพะนะบะฐ ะปะธะผะธัะพะฒ

```python
# ะ ะฝะฐัััะพะนะบะฐั ะบะปะธะฝะธะบะธ
max_per_day = {
    "cardio": 15,
    "derma": 20,
    "dental": 12,
    "general": 30
}
```

## ะขะตััะธัะพะฒะฐะฝะธะต

```bash
# Backend ัะตััั
cd backend
python -m pytest backend/test_online_queue_system.py -v

# ะัะฝะพะฒะฝัะต ัะตััะพะฒัะต ััะตะฝะฐัะธะธ
1. test_qr_token_generation          - ะะตะฝะตัะฐัะธั QR
2. test_join_queue_with_valid_token  - ะัััะฟะปะตะฝะธะต ะฒ ะพัะตัะตะดั
3. test_time_restrictions            - ะัะตะผะตะฝะฝัะต ะพะณัะฐะฝะธัะตะฝะธั
4. test_queue_opening_closes_online  - ะะฐะบัััะธะต ะฟัะธ ะพัะบัััะธะธ
```

## Troubleshooting

### ะัะพะฑะปะตะผะฐ: 401 Unauthorized ะฟัะธ ะณะตะฝะตัะฐัะธะธ QR

**ะะตัะตะฝะธะต:**
1. ะัะพะฒะตัััะต ััะพ `localStorage.auth_token` ัััะตััะฒัะตั
2. ะัะพะฒะตัััะต ัะพะปั ะฟะพะปัะทะพะฒะฐัะตะปั (Admin/Registrar)
3. ะัะพะฒะตัััะต ััะพะบ ะดะตะนััะฒะธั ัะพะบะตะฝะฐ

### ะัะพะฑะปะตะผะฐ: "ะะฝะปะฐะนะฝ-ะทะฐะฟะธัั ะทะฐะบัััะฐ"

**ะัะธัะธะฝั:**
1. ะขะตะบััะตะต ะฒัะตะผั ะฝะต ะฒ ะพะบะฝะต 07:00-09:00
2. ะัะธัะผ ัะถะต ะพัะบััั ัะตะณะธัััะฐัะพัะพะผ (opened_at != null)
3. ะะพััะธะณะฝัั ะปะธะผะธั ะทะฐะฟะธัะตะน ะฝะฐ ะดะตะฝั

### ะัะพะฑะปะตะผะฐ: QR ะบะพะด ะฝะต ะพัะพะฑัะฐะถะฐะตััั

**ะะตัะตะฝะธะต:**
1. ะฃััะฐะฝะพะฒะธัั ะฑะธะฑะปะธะพัะตะบั: `npm install qrcode.react`
2. ะะผะฟะพััะธัะพะฒะฐัั: `import { QRCodeSVG } from 'qrcode.react';`
3. ะัะฟะพะปัะทะพะฒะฐัั:
   ```jsx
   <QRCodeSVG
     value={`${window.location.origin}${qrData.qr_url}`}
     size={200}
   />
   ```

## ะะฐะปัะฝะตะนัะธะต ัะปัััะตะฝะธั

- [ ] ะะฝัะตะณัะฐัะธั ัะตะฐะปัะฝะพะน ะฑะธะฑะปะธะพัะตะบะธ QR ะบะพะดะพะฒ
- [ ] Telegram ะฑะพั ะธะฝัะตะณัะฐัะธั ะดะปั ัะฒะตะดะพะผะปะตะฝะธะน
- [ ] SMS ัะฒะตะดะพะผะปะตะฝะธั ะพ ะฒัะทะพะฒะต
- [ ] ะกัะฐัะธััะธะบะฐ ะธ ะฐะฝะฐะปะธัะธะบะฐ ะพัะตัะตะดะตะน
- [ ] ะญะบัะฟะพัั ะพััััะพะฒ
- [ ] ะะพะฑะธะปัะฝะพะต ะฟัะธะปะพะถะตะฝะธะต ะดะปั ะฟะฐัะธะตะฝัะพะฒ
- [ ] ะญะปะตะบััะพะฝะฝะพะต ัะฐะฑะปะพ ะพัะตัะตะดะธ

## ะะพะปะตะทะฝัะต ัััะปะบะธ

- ะะพะบัะผะตะฝัะฐัะธั API: `/docs` (Swagger)
- ะะพะดะตะปะธ ะดะฐะฝะฝัั: `backend/app/models/online_queue.py`
- CRUD ะพะฟะตัะฐัะธะธ: `backend/app/crud/online_queue.py`
- ะะธะทะฝะตั-ะปะพะณะธะบะฐ: `backend/app/services/queue_service.py`

