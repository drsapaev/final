#!/usr/bin/env python3
"""
–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ JSON
"""
import requests
import base64

def test_json_upload():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ JSON –∑–∞–≥—Ä—É–∑–∫–∏"""
    print("üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ JSON...")
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω
    try:
        auth_response = requests.post(
            "http://localhost:8000/api/v1/auth/login",
            data={"username": "admin", "password": "admin123"},
            headers={"Content-Type": "application/x-www-form-urlencoded"}
        )
        
        if auth_response.status_code != 200:
            print(f"‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: {auth_response.status_code}")
            return
        
        token = auth_response.json()["access_token"]
        print(f"‚úÖ –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω")
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: {e}")
        return
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º JSON –∑–∞–≥—Ä—É–∑–∫—É
    print("\nüìÅ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ JSON –∑–∞–≥—Ä—É–∑–∫–∏...")
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    }
    
    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
    test_content = "Hello World from JSON upload!"
    encoded_content = base64.b64encode(test_content.encode()).decode()
    
    data = {
        "filename": "test_json.txt",
        "content": encoded_content,
        "title": "JSON —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª",
        "description": "–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ JSON API"
    }
    
    try:
        print("üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º JSON –∑–∞–ø—Ä–æ—Å...")
        upload_response = requests.post(
            "http://localhost:8000/api/v1/files/upload-json",
            headers=headers,
            json=data,
            timeout=10
        )
        
        print(f"üìä –°—Ç–∞—Ç—É—Å: {upload_response.status_code}")
        print(f"üìÑ –û—Ç–≤–µ—Ç: {upload_response.text}")
        
        if upload_response.status_code == 200:
            print("‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ JSON!")
            result = upload_response.json()
            print(f"   –ò–º—è —Ñ–∞–π–ª–∞: {result.get('filename')}")
            print(f"   –†–∞–∑–º–µ—Ä: {result.get('file_size')} –±–∞–π—Ç")
            print(f"   –•–µ—à: {result.get('file_hash')[:20]}...")
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞: {upload_response.status_code}")
            
    except requests.exceptions.ConnectionError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {e}")
    except requests.exceptions.Timeout as e:
        print(f"‚ùå –¢–∞–π–º–∞—É—Ç: {e}")
    except Exception as e:
        print(f"‚ùå –î—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞: {e}")

if __name__ == "__main__":
    test_json_upload()

