name: Role System Integrity Check

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'frontend/src/App.jsx'
      - 'frontend/src/pages/Login.jsx'
      - 'frontend/src/pages/UserSelect.jsx'
      - 'backend/app/api/v1/endpoints/*.py'
      - 'backend/app/core/role_validation.py'
  pull_request:
    branches: [ main ]
    paths:
      - 'frontend/src/App.jsx'
      - 'frontend/src/pages/Login.jsx'
      - 'frontend/src/pages/UserSelect.jsx'
      - 'backend/app/api/v1/endpoints/*.py'
      - 'backend/app/core/role_validation.py'

jobs:
  role-system-check:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install system packages (for wheels)
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libjpeg-dev \
          zlib1g-dev \
          libfreetype6-dev \
          libffi-dev \
          libssl-dev
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11.1'
    
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt
    
    - name: Validate import & environment
      run: |
        set -e  # Exit on error - moved to top
        cd backend
        export DATABASE_URL="sqlite:///./clinic.db"
        export CORS_DISABLE="1"
        export WS_DEV_ALLOW="1"
        # Ensure Python can import 'app' package
        export PYTHONPATH="$GITHUB_WORKSPACE/backend:$PYTHONPATH"
        
        echo "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
        echo "Python version: $(python --version)"
        echo "Python path: $(which python)"
        echo "PYTHONPATH: $PYTHONPATH"
        echo "Current directory: $(pwd)"
        echo "Files in current directory:"
        ls -la || true
        
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤..."
        python -c "import sys; print('sys.path[0:3]=', sys.path[0:3])" || true
        python -c "import fastapi; print('FastAPI version:', fastapi.__version__)" || { echo "‚ùå FastAPI not installed"; exit 1; }
        python -c "import uvicorn; print('Uvicorn version:', uvicorn.__version__)" || { echo "‚ùå Uvicorn not installed"; exit 1; }
        python -c "import sqlalchemy; print('SQLAlchemy version:', sqlalchemy.__version__)" || { echo "‚ùå SQLAlchemy not installed"; exit 1; }
        
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
        echo "Checking app directory structure:"
        ls -la app/ | head -20 || echo "‚ö†Ô∏è Cannot list app/ directory"
        echo "Checking app/main.py exists:"
        if [ ! -f app/main.py ]; then
          echo "‚ùå app/main.py not found"
          exit 1
        fi
        echo "‚úÖ app/main.py exists"
        
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
        echo "Step 1: Importing app package..."
        |
          if ! python -c "
          import sys
          import os
          print('Python version:', sys.version[:5])
          print('Current dir:', os.getcwd())
          print('PYTHONPATH:', os.environ.get('PYTHONPATH', 'NOT SET'))
          print('DATABASE_URL:', os.environ.get('DATABASE_URL', 'NOT SET'))
          try:
              import app
              print('‚úÖ app package imported')
          except Exception as e:
              print('‚ùå Failed to import app package:', e)
              import traceback
              traceback.print_exc()
              exit(1)
          " 2>&1; then
            echo "‚ùå Failed to import app package"
            exit 1
          fi
        
        echo "Step 2: Testing critical imports before app.main..."
        echo "  - Testing app.core.exception_handlers..."
        python -c "from app.core.exception_handlers import register_exception_handlers; print('‚úÖ exception_handlers OK')" 2>&1 || echo "‚ö†Ô∏è exception_handlers import failed"
        echo "  - Testing app.ws.queue_ws..."
        python -c "from app.ws.queue_ws import router, ws_queue; print('‚úÖ queue_ws OK')" 2>&1 || echo "‚ö†Ô∏è queue_ws import failed"
        echo "  - Testing app.api.deps..."
        python -c "from app.api.deps import create_access_token; print('‚úÖ deps OK')" 2>&1 || echo "‚ö†Ô∏è deps import failed (will use fallback)"
        echo "  - Testing app.api.v1.api..."
        if ! python -c "
try:
    from app.api.v1.api import api_router
    print('‚úÖ api.v1.api OK')
except Exception as e:
    print('‚ùå Failed to import app.api.v1.api:', e)
    import traceback
    traceback.print_exc()
    exit(1)
" 2>&1; then
          echo "‚ùå Failed to import app.api.v1.api - checking which endpoint module fails..."
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º–ø–æ—Ä—Ç—ã —Å–µ—Ä–≤–∏—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –Ω–µ–¥–∞–≤–Ω–æ –∏—Å–ø—Ä–∞–≤–∏–ª–∏
          echo "  - Testing recently fixed service imports..."
          python -c "
          import sys
          import traceback
          services_to_test = [
              'app.services.ai.deepseek_provider',
              'app.services.ai.deepseek_provider_new',
              'app.services.print_service',
              'app.services.user_management_service',
              'app.services.mobile_notifications',
          ]
          for module in services_to_test:
              try:
                  __import__(module)
                  print(f'‚úÖ {module} OK')
              except ImportError as e:
                  print(f'‚ùå {module} IMPORT ERROR: {e}')
                  traceback.print_exc()
              except Exception as e:
                  print(f'‚ùå {module} FAILED: {e}')
                  traceback.print_exc()
          " 2>&1 || true
          # –ü–æ–ø—Ä–æ–±—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥—É–ª–∏ –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏
          python -c "
          import sys
          modules_to_test = [
              'app.api.v1.endpoints.auth',
              'app.api.v1.endpoints.patients',
              'app.api.v1.endpoints.visits',
              'app.api.v1.endpoints.services',
              'app.api.v1.endpoints.appointments',
          ]
          for module in modules_to_test:
              try:
                  __import__(module)
                  print(f'‚úÖ {module} OK')
              except Exception as e:
                  print(f'‚ùå {module} FAILED: {e}')
                  import traceback
                  traceback.print_exc()
          " 2>&1 || true
          exit 1
        fi
        echo "  - Testing app.graphql..."
        python -c "from app.graphql import graphql_router; print('‚úÖ graphql OK')" 2>&1 || echo "‚ö†Ô∏è graphql import failed"
        
        echo "Step 3: Importing app.main module..."
        if ! python -c "
try:
    import app.main
    print('‚úÖ app.main module imported')
except Exception as e:
    print('‚ùå Failed to import app.main module:', e)
    import traceback
    traceback.print_exc()
    exit(1)
" 2>&1; then
          echo "‚ùå Failed to import app.main module"
          exit 1
        fi

        echo "Step 4: Importing app from app.main..."
        if ! python -c "
try:
    from app.main import app
    print('‚úÖ app import ok')
except Exception as e:
    print('‚ùå Failed to import app from app.main:', e)
    import traceback
    traceback.print_exc()
    exit(1)
" 2>&1; then
          echo "‚ùå Failed to import app from app.main"
          exit 1
        fi
        
        echo "‚úÖ All imports successful"
    
    - name: Setup test database
      run: |
        cd backend
        export DATABASE_URL="sqlite:///./clinic.db"
        export CORS_DISABLE="1"
        export WS_DEV_ALLOW="1"
        
        python - << 'PY'
        import sys
        import time
        sys.path.insert(0, '.')
        
        from app.db.base import Base
        from app.db.session import engine, SessionLocal
        from app.models.user import User
        from app.core.security import get_password_hash
        from sqlalchemy import text
        
        try:
            # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã
            print('–°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Ç–µ—Å—Ç–æ–≤ —Ä–æ–ª–µ–π...')
            Base.metadata.create_all(bind=engine)
            print('OK: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞')
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ users –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞–Ω–∞
            with engine.connect() as conn:
                result = conn.execute(text("SELECT name FROM sqlite_master WHERE type='table' AND name='users'"))
                if not result.fetchone():
                    print('ERROR: –¢–∞–±–ª–∏—Ü–∞ users –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è')
                    raise Exception("–¢–∞–±–ª–∏—Ü–∞ users –Ω–µ —Å–æ–∑–¥–∞–Ω–∞")
                print('OK: –¢–∞–±–ª–∏—Ü–∞ users –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞')
            
            # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
            time.sleep(1)
            
            # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –≤—Å–µ—Ö —Ä–æ–ª–µ–π
            db = SessionLocal()
            try:
                test_users = [
                    ("admin", "admin123", "Admin"),
                    ("registrar", "registrar123", "Registrar"),
                    ("lab", "lab123", "Lab"),
                    ("doctor", "doctor123", "Doctor"),
                    ("cashier", "cashier123", "Cashier"),
                    ("cardio", "cardio123", "cardio"),
                    ("derma", "derma123", "derma"),
                    ("dentist", "dentist123", "dentist"),
                ]
                
                for username, password, role in test_users:
                    existing_user = db.query(User).filter(User.username == username).first()
                    if not existing_user:
                        user = User(
                            username=username,
                            email=f"{username}@clinic.com",
                            hashed_password=get_password_hash(password),
                            role=role,
                            is_active=True,
                            is_superuser=(role == "Admin")
                        )
                        db.add(user)
                        print(f'OK: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {username} —Å–æ–∑–¥–∞–Ω')
                    else:
                        print(f'OK: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {username} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç')
                
                db.commit()
                print('OK: –í—Å–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≥–æ—Ç–æ–≤—ã')
            finally:
                db.close()
        except Exception as e:
            print('WARNING: –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ë–î –¥–ª—è —Ç–µ—Å—Ç–æ–≤ —Ä–æ–ª–µ–π:', e)
            import traceback
            traceback.print_exc()
            raise SystemExit(1)
        PY
    
    - name: Start backend server
      run: |
        cd backend
        export DATABASE_URL="sqlite:///./clinic.db"
        export CORS_DISABLE="1"
        export WS_DEV_ALLOW="1"
        echo "–ó–∞–ø—É—Å–∫ backend —Å–µ—Ä–≤–µ—Ä–∞..."
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –≤ —Ñ–æ–Ω–µ —Å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –≤—ã–≤–æ–¥–∞
        nohup python -m uvicorn app.main:app --host 127.0.0.1 --port 8000 > server.log 2>&1 &
        SERVER_PID=$!
        echo "–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω —Å PID: $SERVER_PID"
        
        # –ñ–¥–µ–º –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞
        echo "–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞..."
        sleep 15
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
        if ! kill -0 $SERVER_PID 2>/dev/null; then
          echo "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
          echo "–õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞:"
          cat server.log
          exit 1
        fi
        
        echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞..."
        # –ü—Ä–æ–±—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        for i in {1..5}; do
          echo "–ü–æ–ø—ã—Ç–∫–∞ $i/5..."
          if curl -f http://127.0.0.1:8000/api/v1/health; then
            echo "‚úÖ –°–µ—Ä–≤–µ—Ä —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ –æ—Ç–≤–µ—á–∞–µ—Ç"
            break
          else
            echo "–ü–æ–ø—ã—Ç–∫–∞ $i –Ω–µ—É–¥–∞—á–Ω–∞, –∂–¥–µ–º 3 —Å–µ–∫—É–Ω–¥—ã..."
            sleep 3
          fi
        done
        
        # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        if ! curl -f http://127.0.0.1:8000/api/v1/health; then
          echo "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫"
          echo "–õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞:"
          cat server.log
          exit 1
        fi
    
    - name: Run role system tests
      run: |
        cd backend
        echo "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã —Ä–æ–ª–µ–π..."
        python test_role_routing.py
        echo "–¢–µ—Å—Ç—ã —Å–∏—Å—Ç–µ–º—ã —Ä–æ–ª–µ–π –∑–∞–≤–µ—Ä—à–µ–Ω—ã"
    
    - name: Check system integrity
      run: |
        cd backend
        echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã..."
        python check_system_integrity.py
        echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    
    - name: Validate role consistency
      run: |
        cd backend
        python -c "
        from app.core.role_validation import validate_critical_user_roles
        if not validate_critical_user_roles():
            exit(1)
        print('OK: Role validation passed')
        "
    
    - name: Stop backend server
      if: always()
      run: |
        echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä..."
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ PID –µ—Å–ª–∏ –æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω
        if [ -n "$SERVER_PID" ]; then
          kill $SERVER_PID 2>/dev/null || true
        fi
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ uvicorn
        pkill -f "uvicorn.*8000" 2>/dev/null || true
        echo "OK: –°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
