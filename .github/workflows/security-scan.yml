name: üîí –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 3 * * *'  # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 UTC

jobs:
  security-scan:
    name: üîí –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python path
      run: |
        cd backend
        echo "PYTHONPATH=${{ github.workspace }}/backend" >> $GITHUB_ENV
        echo "PYTHONPATH=${{ github.workspace }}/backend" >> $GITHUB_PATH
        
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
      run: |
        cd backend
        pip install bandit safety pip-audit
        
    - name: üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (safety)
      run: |
        cd backend
        safety check --json --output safety-report.json || true
        
    - name: üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (pip-audit)
      run: |
        cd backend
        pip-audit --format json --output pip-audit-report.json || true
        
    - name: üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ (bandit)
      run: |
        cd backend
        bandit -r . -f json -o bandit-report.json || true
        
    - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          backend/safety-report.json
          backend/pip-audit-report.json
          backend/bandit-report.json
        
    - name: üìä –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
      run: |
        echo "üîí –ê–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∑–∞–≤–µ—Ä—à—ë–Ω"
        echo "üìã –û—Ç—á—ë—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã"
        
        if [ -f backend/safety-report.json ]; then
          echo "‚úÖ –û—Ç—á—ë—Ç safety —Å–æ–∑–¥–∞–Ω"
        fi
        
        if [ -f backend/pip-audit-report.json ]; then
          echo "‚úÖ –û—Ç—á—ë—Ç pip-audit —Å–æ–∑–¥–∞–Ω"
        fi
        
        if [ -f backend/bandit-report.json ]; then
          echo "‚úÖ –û—Ç—á—ë—Ç bandit —Å–æ–∑–¥–∞–Ω"
        fi
