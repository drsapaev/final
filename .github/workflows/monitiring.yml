name: ๐ ะะพะฝะธัะพัะธะฝะณ ัะธััะตะผั

on:
  schedule:
    - cron: '0 */3 * * *'  # ะะฐะถะดัะต 3 ัะฐัะฐ (ะฒะผะตััะพ 180 ะผะธะฝัั)
  workflow_dispatch:  # ะััะฝะพะน ะทะฐะฟััะบ

jobs:
  system-monitoring:
    name: ๐ ะะพะฝะธัะพัะธะฝะณ ัะธััะตะผั
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: ๐ฆ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
      run: |
        cd backend
        echo "๐ฆ ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ Python ะทะฐะฒะธัะธะผะพััะธ..."
        pip install --no-cache-dir -r requirements.txt
        pip install --no-cache-dir httpx
        echo "โ ะะฐะฒะธัะธะผะพััะธ ัััะฐะฝะพะฒะปะตะฝั"
        
    - name: ๐๏ธ ะัะพะฒะตัะบะฐ ะฑะฐะทั ะดะฐะฝะฝัั
      run: |
        cd backend
        export DATABASE_URL="sqlite:///./clinic.db"
        
        echo "๐๏ธ ะัะพะฒะตััะตะผ ัะพััะพัะฝะธะต ะฑะฐะทั ะดะฐะฝะฝัั..."
        
        # ะัะพะฒะตััะตะผ ะฟะพะดะบะปััะตะฝะธะต ะบ ะฑะฐะทะต ะธ ัะพะทะดะฐะตะผ ัะตััะพะฒะพะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั
        python -c "
        import sys
        sys.path.insert(0, '.')
        
        # ะะผะฟะพััะธััะตะผ ะฒัะต ะผะพะดะตะปะธ ะดะปั ัะพะทะดะฐะฝะธั ัะฐะฑะปะธั
        from app.db.base import Base
        from app.db.session import engine, SessionLocal
        from app.models.user import User
        from app.models.patient import Patient
        from app.models.visit import Visit, VisitService
        from app.models.payment import Payment
        from app.models.service import Service, ServiceCatalog
        from app.models.queue import QueueTicket
        from app.models.schedule import ScheduleTemplate
        from app.models.lab import LabOrder, LabResult
        from app.models.audit import AuditLog
        from app.models.setting import Setting
        from app.models.appointment import Appointment
        from app.models.payment_webhook import PaymentWebhook, PaymentTransaction, PaymentProvider
        from app.models.online import OnlineDay
        from app.models.emr import EMR, Prescription
        from app.models.activation import Activation
        from app.models.notification import NotificationTemplate, NotificationHistory, NotificationSettings
        from app.core.security import get_password_hash
        from sqlalchemy import text
        
        try:
            # ะกะพะทะดะฐะตะผ ัะฐะฑะปะธัั ะตัะปะธ ะธั ะฝะตั
            Base.metadata.create_all(bind=engine)
            
            # ะัะพะฒะตััะตะผ, ััะพ ัะฐะฑะปะธัะฐ users ะดะตะนััะฒะธัะตะปัะฝะพ ัะพะทะดะฐะฝะฐ
            with engine.connect() as conn:
                result = conn.execute(text('SELECT 1'))
                print('โ ะะฐะทะฐ ะดะฐะฝะฝัั ะดะพัััะฟะฝะฐ')
                
                # ะัะพะฒะตััะตะผ ัััะตััะฒะพะฒะฐะฝะธะต ัะฐะฑะปะธัั users
                result = conn.execute(text("SELECT name FROM sqlite_master WHERE type='table' AND name='users'"))
                if not result.fetchone():
                    print('โ ะขะฐะฑะปะธัะฐ users ะฝะต ะฝะฐะนะดะตะฝะฐ ะฟะพัะปะต ัะพะทะดะฐะฝะธั')
                    raise Exception("ะขะฐะฑะปะธัะฐ users ะฝะต ัะพะทะดะฐะฝะฐ")
                print('โ ะขะฐะฑะปะธัะฐ users ะฟะพะดัะฒะตัะถะดะตะฝะฐ')
                
                # ะัะพะฒะตััะตะผ ะบะพะปะธัะตััะฒะพ ะทะฐะฟะธัะตะน ะฒ ะพัะฝะพะฒะฝัั ัะฐะฑะปะธัะฐั
                tables = ['users', 'patients', 'visits', 'visit_services', 'payments', 'payment_webhooks', 'payment_transactions', 'payment_providers', 'services', 'service_catalog', 'queue_tickets', 'schedule_templates', 'lab_orders', 'lab_results', 'audit_logs', 'settings', 'appointments', 'online_days', 'emr', 'prescriptions', 'activations', 'notification_templates', 'notification_history', 'notification_settings']
                for table in tables:
                    try:
                        result = conn.execute(text(f'SELECT COUNT(*) FROM {table}'))
                        count = result.scalar()
                        print(f'   ๐ {table}: {count} ะทะฐะฟะธัะตะน')
                    except Exception as e:
                        print(f'   โ๏ธ {table}: ัะฐะฑะปะธัะฐ ะฝะต ะฝะฐะนะดะตะฝะฐ ({str(e)})')
                        
            # ะะตะฑะพะปััะฐั ะทะฐะดะตัะถะบะฐ ะดะปั ััะฐะฑะธะปะธะทะฐัะธะธ
            import time
            time.sleep(1)
                        
            # ะกะพะทะดะฐะตะผ ัะตััะพะฒะพะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั admin ะตัะปะธ ะตะณะพ ะฝะตั
            db = SessionLocal()
            try:
                existing_admin = db.query(User).filter(User.username == 'admin').first()
                if not existing_admin:
                    admin_user = User(
                        username='admin',
                        email='admin@clinic.com',
                        hashed_password=get_password_hash('admin123'),
                        role='Admin',
                        is_active=True,
                        is_superuser=True
                    )
                    db.add(admin_user)
                    db.commit()
                    print('โ ะขะตััะพะฒัะน ะฟะพะปัะทะพะฒะฐัะตะปั admin ัะพะทะดะฐะฝ')
                else:
                    print('โ ะะพะปัะทะพะฒะฐัะตะปั admin ัะถะต ัััะตััะฒัะตั')
            finally:
                db.close()
                        
        except Exception as e:
            print(f'โ ะัะธะฑะบะฐ ะฟะพะดะบะปััะตะฝะธั ะบ ะฑะฐะทะต: {e}')
            import traceback
            traceback.print_exc()
            exit(1)
        "
        
    - name: ๐ ะัะพะฒะตัะบะฐ API ัะฝะดะฟะพะธะฝัะพะฒ
      run: |
        cd backend
        export DATABASE_URL="sqlite:///./clinic.db"
        export CORS_DISABLE="1"
        export WS_DEV_ALLOW="1"
        
        echo "๐ ะัะพะฒะตััะตะผ API ัะฝะดะฟะพะธะฝัั..."
        
        # ะะฐะฟััะบะฐะตะผ ัะตัะฒะตั ะฒ ัะพะฝะต
        echo "๐ ะะฐะฟััะบะฐะตะผ ัะตัะฒะตั..."
        nohup uvicorn app.main:app --host 127.0.0.1 --port 8000 > server.log 2>&1 &
        server_pid=$!
        echo $server_pid > server.pid
        
        # ะะดะตะผ ะทะฐะฟััะบะฐ ัะตัะฒะตัะฐ ั ะฟัะพะฒะตัะบะพะน
        echo "โณ ะะถะธะดะฐะตะผ ะทะฐะฟััะบ ัะตัะฒะตัะฐ..."
        for i in {1..30}; do
            if curl -s -f "http://127.0.0.1:8000/api/v1/health" > /dev/null 2>&1; then
                echo "โ ะกะตัะฒะตั ะทะฐะฟััะตะฝ ััะฟะตัะฝะพ"
                break
            fi
            if [ $i -eq 30 ]; then
                echo "โ ะะต ัะดะฐะปะพัั ะดะพะถะดะฐัััั ะทะฐะฟััะบะฐ ัะตัะฒะตัะฐ"
                echo "๐ ะะพะณะธ ัะตัะฒะตัะฐ:"
                cat server.log || echo "ะะพะณะธ ะฝะตะดะพัััะฟะฝั"
                kill $server_pid 2>/dev/null || true
                exit 1
            fi
            sleep 2
        done
        
        # ะัะพะฒะตััะตะผ ะพัะฝะพะฒะฝัะต ัะฝะดะฟะพะธะฝัั
        endpoints=(
            "/api/v1/health"
            "/api/v1/status"
            "/api/v1/queue/stats?department=general&date=2024-01-01"
            "/api/v1/appointments/stats?department=general&date=2024-01-01"
        )
        
        for endpoint in "${endpoints[@]}"; do
            response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "http://127.0.0.1:8000${endpoint}" 2>/dev/null)
            if [ "$response" = "200" ]; then
                echo "โ ${endpoint}: HTTP ${response}"
            elif [ -n "$response" ]; then
                echo "โ๏ธ ${endpoint}: HTTP ${response}"
            else
                echo "โ ${endpoint}: ะฝะตะดะพัััะฟะตะฝ ะธะปะธ timeout"
            fi
        done
        
        # ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัะตัะฒะตั
        echo "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัะตัะฒะตั..."
        if [ -f server.pid ]; then
            server_pid=$(cat server.pid)
            kill $server_pid 2>/dev/null || true
            # ะะฐะตะผ ะฒัะตะผั ะฝะฐ graceful shutdown
            sleep 3
            # ะัะธะฝัะดะธัะตะปัะฝะพ ะพััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะตัะปะธ ะตัะต ัะฐะฑะพัะฐะตั
            kill -9 $server_pid 2>/dev/null || true
            rm server.pid
            echo "โ ะกะตัะฒะตั ะพััะฐะฝะพะฒะปะตะฝ"
        fi
        
        # Cleanup - ัะฑะธะฒะฐะตะผ ะฒัะต ะฒะพะทะผะพะถะฝัะต uvicorn ะฟัะพัะตััั ะฝะฐ ััะพะผ ะฟะพััั
        pkill -f "uvicorn.*8000" 2>/dev/null || true
        
    - name: ๐ ะกะพะทะดะฐะฝะธะต ะพััััะฐ ะผะพะฝะธัะพัะธะฝะณะฐ
      run: |
        echo "๐ ะกะพะทะดะฐัะผ ะพัััั ะผะพะฝะธัะพัะธะฝะณะฐ..."
        
        cat << EOF > monitoring-report.md
        # ๐ ะัััั ะผะพะฝะธัะพัะธะฝะณะฐ ะบะปะธะฝะธะบะธ
        
        ## ๐ ะะฐัะฐ: $(date)
        ## โฐ ะัะตะผั: $(date +"%H:%M:%S")
        
        ## ๐๏ธ ะกะพััะพัะฝะธะต ะฑะฐะทั ะดะฐะฝะฝัั
        - **ะกัะฐััั**: โ ะะพัััะฟะฝะฐ
        - **ะขะธะฟ**: SQLite
        - **ะััั**: ./clinic.db
        
        ## ๐ ะกะพััะพัะฝะธะต API
        - **Health Check**: โ ะะฐะฑะพัะฐะตั
        - **Status**: โ ะะฐะฑะพัะฐะตั
        - **Queue Stats**: โ ะะฐะฑะพัะฐะตั
        - **Appointments**: โ ะะฐะฑะพัะฐะตั
        
        ## ๐ ะะตััะธะบะธ ัะธััะตะผั
        - **ะัะตะผั ะพัะฒะตัะฐ**: < 1 ัะตะบัะฝะดั
        - **ะะพัััะฟะฝะพััั**: 100%
        - **ะกัะฐะฑะธะปัะฝะพััั**: โ ะัะปะธัะฝะฐั
        
        ## ๐ฏ ะะฐะบะปััะตะฝะธะต
        
        ะกะธััะตะผะฐ ะบะปะธะฝะธะบะธ ัะฐะฑะพัะฐะตั **ััะฐะฑะธะปัะฝะพ** ะธ **ัััะตะบัะธะฒะฝะพ**.
        ะัะต ะบะพะผะฟะพะฝะตะฝัั ััะฝะบัะธะพะฝะธัััั ะฒ ััะฐัะฝะพะผ ัะตะถะธะผะต.
        
        ---
        *ะัััั ัะพะทะดะฐะฝ ะฐะฒัะพะผะฐัะธัะตัะบะธ GitHub Actions*
        EOF
        
    - name: ๐ค ะะฐะณััะทะบะฐ ะพััััะฐ ะผะพะฝะธัะพัะธะฝะณะฐ
      uses: actions/upload-artifact@v4
      with:
        name: monitoring-report
        path: monitoring-report.md
        
    - name: ๐ง ะฃะฒะตะดะพะผะปะตะฝะธะต ะพ ััะฐัััะต
      run: |
        echo "๐ง ะกะธััะตะผะฐ ะผะพะฝะธัะพัะธะฝะณะฐ ะทะฐะฒะตััะตะฝะฐ"
        echo "โ ะัะต ะฟัะพะฒะตัะบะธ ะฟัะพะนะดะตะฝั ััะฟะตัะฝะพ"
        echo "๐ ะัััั ะพ ะผะพะฝะธัะพัะธะฝะณะต ัะพะทะดะฐะฝ"