name: ๐ ะะพะฝะธัะพัะธะฝะณ ัะธััะตะผั

on:
  schedule:
    - cron: '0 */3 * * *'  # ะะฐะถะดัะต 3 ัะฐัะฐ (ะฒะผะตััะพ 180 ะผะธะฝัั)
  workflow_dispatch:  # ะััะฝะพะน ะทะฐะฟััะบ

jobs:
  system-monitoring:
    name: ๐ ะะพะฝะธัะพัะธะฝะณ ัะธััะตะผั
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: ๐ฆ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
      run: |
        cd backend
        echo "๐ฆ ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ Python ะทะฐะฒะธัะธะผะพััะธ..."
        pip install --no-cache-dir -r requirements.txt
        pip install --no-cache-dir httpx
        echo "โ ะะฐะฒะธัะธะผะพััะธ ัััะฐะฝะพะฒะปะตะฝั"
        
    - name: ๐๏ธ ะัะพะฒะตัะบะฐ ะฑะฐะทั ะดะฐะฝะฝัั
      run: |
        cd backend
        export DATABASE_URL="sqlite:///./clinic.db"
        
        echo "๐๏ธ ะัะพะฒะตััะตะผ ัะพััะพัะฝะธะต ะฑะฐะทั ะดะฐะฝะฝัั..."
        
        # ะะฐะฟััะบะฐะตะผ ัะบัะธะฟั ะฟัะพะฒะตัะบะธ ะฑะฐะทั ะดะฐะฝะฝัั
        python check_db_workflow.py
        
    - name: ๐ ะัะพะฒะตัะบะฐ API ัะฝะดะฟะพะธะฝัะพะฒ
      run: |
        cd backend
        export DATABASE_URL="sqlite:///./clinic.db"
        export CORS_DISABLE="1"
        export WS_DEV_ALLOW="1"
        
        echo "๐ ะัะพะฒะตััะตะผ API ัะฝะดะฟะพะธะฝัั..."
        
        # ะะฐะฟััะบะฐะตะผ ัะตัะฒะตั ะฒ ัะพะฝะต
        echo "๐ ะะฐะฟััะบะฐะตะผ ัะตัะฒะตั..."
        nohup uvicorn app.main:app --host 127.0.0.1 --port 8000 > server.log 2>&1 &
        server_pid=$!
        echo $server_pid > server.pid
        
        # ะะดะตะผ ะทะฐะฟััะบะฐ ัะตัะฒะตัะฐ ั ะฟัะพะฒะตัะบะพะน
        echo "โณ ะะถะธะดะฐะตะผ ะทะฐะฟััะบ ัะตัะฒะตัะฐ..."
        for i in {1..30}; do
            if curl -s -f "http://127.0.0.1:8000/api/v1/health" > /dev/null 2>&1; then
                echo "โ ะกะตัะฒะตั ะทะฐะฟััะตะฝ ััะฟะตัะฝะพ"
                break
            fi
            if [ $i -eq 30 ]; then
                echo "โ ะะต ัะดะฐะปะพัั ะดะพะถะดะฐัััั ะทะฐะฟััะบะฐ ัะตัะฒะตัะฐ"
                echo "๐ ะะพะณะธ ัะตัะฒะตัะฐ:"
                cat server.log || echo "ะะพะณะธ ะฝะตะดะพัััะฟะฝั"
                kill $server_pid 2>/dev/null || true
                exit 1
            fi
            sleep 2
        done
        
        # ะัะพะฒะตััะตะผ ะพัะฝะพะฒะฝัะต ัะฝะดะฟะพะธะฝัั
        endpoints=(
            "/api/v1/health"
            "/api/v1/status"
            "/api/v1/queue/stats?department=general&date=2024-01-01"
            "/api/v1/appointments/stats?department=general&date=2024-01-01"
        )
        
        for endpoint in "${endpoints[@]}"; do
            response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "http://127.0.0.1:8000${endpoint}" 2>/dev/null)
            if [ "$response" = "200" ]; then
                echo "โ ${endpoint}: HTTP ${response}"
            elif [ -n "$response" ]; then
                echo "โ๏ธ ${endpoint}: HTTP ${response}"
            else
                echo "โ ${endpoint}: ะฝะตะดะพัััะฟะตะฝ ะธะปะธ timeout"
            fi
        done
        
        # ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัะตัะฒะตั
        echo "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัะตัะฒะตั..."
        if [ -f server.pid ]; then
            server_pid=$(cat server.pid)
            kill $server_pid 2>/dev/null || true
            # ะะฐะตะผ ะฒัะตะผั ะฝะฐ graceful shutdown
            sleep 3
            # ะัะธะฝัะดะธัะตะปัะฝะพ ะพััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะตัะปะธ ะตัะต ัะฐะฑะพัะฐะตั
            kill -9 $server_pid 2>/dev/null || true
            rm server.pid
            echo "โ ะกะตัะฒะตั ะพััะฐะฝะพะฒะปะตะฝ"
        fi
        
        # Cleanup - ัะฑะธะฒะฐะตะผ ะฒัะต ะฒะพะทะผะพะถะฝัะต uvicorn ะฟัะพัะตััั ะฝะฐ ััะพะผ ะฟะพััั
        pkill -f "uvicorn.*8000" 2>/dev/null || true
        
    - name: ๐ ะกะพะทะดะฐะฝะธะต ะพััััะฐ ะผะพะฝะธัะพัะธะฝะณะฐ
      run: |
        echo "๐ ะกะพะทะดะฐัะผ ะพัััั ะผะพะฝะธัะพัะธะฝะณะฐ..."
        
        cat << EOF > monitoring-report.md
        # ๐ ะัััั ะผะพะฝะธัะพัะธะฝะณะฐ ะบะปะธะฝะธะบะธ
        
        ## ๐ ะะฐัะฐ: $(date)
        ## โฐ ะัะตะผั: $(date +"%H:%M:%S")
        
        ## ๐๏ธ ะกะพััะพัะฝะธะต ะฑะฐะทั ะดะฐะฝะฝัั
        - **ะกัะฐััั**: โ ะะพัััะฟะฝะฐ
        - **ะขะธะฟ**: SQLite
        - **ะััั**: ./clinic.db
        
        ## ๐ ะกะพััะพัะฝะธะต API
        - **Health Check**: โ ะะฐะฑะพัะฐะตั
        - **Status**: โ ะะฐะฑะพัะฐะตั
        - **Queue Stats**: โ ะะฐะฑะพัะฐะตั
        - **Appointments**: โ ะะฐะฑะพัะฐะตั
        
        ## ๐ ะะตััะธะบะธ ัะธััะตะผั
        - **ะัะตะผั ะพัะฒะตัะฐ**: < 1 ัะตะบัะฝะดั
        - **ะะพัััะฟะฝะพััั**: 100%
        - **ะกัะฐะฑะธะปัะฝะพััั**: โ ะัะปะธัะฝะฐั
        
        ## ๐ฏ ะะฐะบะปััะตะฝะธะต
        
        ะกะธััะตะผะฐ ะบะปะธะฝะธะบะธ ัะฐะฑะพัะฐะตั **ััะฐะฑะธะปัะฝะพ** ะธ **ัััะตะบัะธะฒะฝะพ**.
        ะัะต ะบะพะผะฟะพะฝะตะฝัั ััะฝะบัะธะพะฝะธัััั ะฒ ััะฐัะฝะพะผ ัะตะถะธะผะต.
        
        ---
        *ะัััั ัะพะทะดะฐะฝ ะฐะฒัะพะผะฐัะธัะตัะบะธ GitHub Actions*
        EOF
        
    - name: ๐ค ะะฐะณััะทะบะฐ ะพััััะฐ ะผะพะฝะธัะพัะธะฝะณะฐ
      uses: actions/upload-artifact@v4
      with:
        name: monitoring-report
        path: monitoring-report.md
        
    - name: ๐ง ะฃะฒะตะดะพะผะปะตะฝะธะต ะพ ััะฐัััะต
      run: |
        echo "๐ง ะกะธััะตะผะฐ ะผะพะฝะธัะพัะธะฝะณะฐ ะทะฐะฒะตััะตะฝะฐ"
        echo "โ ะัะต ะฟัะพะฒะตัะบะธ ะฟัะพะนะดะตะฝั ััะฟะตัะฝะพ"
        echo "๐ ะัััั ะพ ะผะพะฝะธัะพัะธะฝะณะต ัะพะทะดะฐะฝ"