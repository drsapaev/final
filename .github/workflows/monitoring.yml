name: ๐ ะะพะฝะธัะพัะธะฝะณ ัะธััะตะผั

on:
  schedule:
    - cron: '0 */3 * * *'  # ะะฐะถะดัะต 3 ัะฐัะฐ (ะฒะผะตััะพ 180 ะผะธะฝัั)
  workflow_dispatch:  # ะััะฝะพะน ะทะฐะฟััะบ

jobs:
  system-monitoring:
    name: ๐ ะะพะฝะธัะพัะธะฝะณ ัะธััะตะผั
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: ๐ฆ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
      run: |
        cd backend
        echo "๐ฆ ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ Python ะทะฐะฒะธัะธะผะพััะธ..."
        python -m pip install --upgrade pip
        pip install --no-cache-dir -r requirements.txt
        pip install --no-cache-dir httpx
        echo "โ ะะฐะฒะธัะธะผะพััะธ ัััะฐะฝะพะฒะปะตะฝั"
        
        # ะัะพะฒะตััะตะผ ัััะฐะฝะพะฒะปะตะฝะฝัะต ะฟะฐะบะตัั
        echo "๐ ะัะพะฒะตััะตะผ ะบัะธัะธัะตัะบะธะต ะฟะฐะบะตัั..."
        python -c "import fastapi; print(f'FastAPI: {fastapi.__version__}')"
        python -c "import sqlalchemy; print(f'SQLAlchemy: {sqlalchemy.__version__}')"
        python -c "import alembic; print(f'Alembic: {alembic.__version__}')"
        
    - name: ๐๏ธ ะัะพะฒะตัะบะฐ ะฑะฐะทั ะดะฐะฝะฝัั
      run: |
        cd backend
        export DATABASE_URL="sqlite:///./clinic.db"
        
        echo "๐๏ธ ะัะพะฒะตััะตะผ ัะพััะพัะฝะธะต ะฑะฐะทั ะดะฐะฝะฝัั..."
        echo "๐ DATABASE_URL: $DATABASE_URL"
        echo "๐ ะขะตะบััะฐั ะดะธัะตะบัะพัะธั: $(pwd)"
        echo "๐ ะกะพะดะตัะถะธะผะพะต ะดะธัะตะบัะพัะธะธ:"
        ls -la
        
        # ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต ัะบัะธะฟัะฐ
        if [ ! -f "check_db_workflow.py" ]; then
          echo "โ ะกะบัะธะฟั check_db_workflow.py ะฝะต ะฝะฐะนะดะตะฝ!"
          exit 1
        fi
        
        echo "โ ะกะบัะธะฟั ะฝะฐะนะดะตะฝ, ะทะฐะฟััะบะฐะตะผ ะฟัะพะฒะตัะบั..."
        
        # ะะฐะฟััะบะฐะตะผ ัะบัะธะฟั ะฟัะพะฒะตัะบะธ ะฑะฐะทั ะดะฐะฝะฝัั ั ะฟะพะดัะพะฑะฝัะผ ะฒัะฒะพะดะพะผ
        python check_db_workflow.py || {
          echo "โ ะกะบัะธะฟั ะฟัะพะฒะตัะบะธ ะะ ะทะฐะฒะตััะธะปัั ั ะพัะธะฑะบะพะน"
          echo "๐ ะะพะฟััะบะฐ ะดะธะฐะณะฝะพััะธะบะธ..."
          python -c "
          import sys
          sys.path.insert(0, '.')
          try:
              from app.db.session import engine
              print('โ ะะผะฟะพัั engine ััะฟะตัะตะฝ')
          except Exception as e:
              print(f'โ ะัะธะฑะบะฐ ะธะผะฟะพััะฐ engine: {e}')
          "
          exit 1
        }
        
    - name: ๐ ะัะพะฒะตัะบะฐ API ัะฝะดะฟะพะธะฝัะพะฒ
      run: |
        cd backend
        export DATABASE_URL="sqlite:///./clinic.db"
        export CORS_DISABLE="1"
        export WS_DEV_ALLOW="1"
        
        echo "๐ ะัะพะฒะตััะตะผ API ัะฝะดะฟะพะธะฝัั..."
        
        # ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต ะพัะฝะพะฒะฝะพะณะพ ัะฐะนะปะฐ ะฟัะธะปะพะถะตะฝะธั
        if [ ! -f "app/main.py" ]; then
          echo "โ ะคะฐะนะป app/main.py ะฝะต ะฝะฐะนะดะตะฝ!"
          exit 1
        fi
        
        # ะะฐะฟััะบะฐะตะผ ัะตัะฒะตั ะฒ ัะพะฝะต
        echo "๐ ะะฐะฟััะบะฐะตะผ ัะตัะฒะตั..."
        nohup uvicorn app.main:app --host 127.0.0.1 --port 8000 > server.log 2>&1 &
        server_pid=$!
        echo $server_pid > server.pid
        echo "๐ PID ัะตัะฒะตัะฐ: $server_pid"
        
        # ะะดะตะผ ะทะฐะฟััะบะฐ ัะตัะฒะตัะฐ ั ะฟัะพะฒะตัะบะพะน
        echo "โณ ะะถะธะดะฐะตะผ ะทะฐะฟััะบ ัะตัะฒะตัะฐ..."
        for i in {1..30}; do
            echo "๐ ะะพะฟััะบะฐ $i/30..."
            if curl -s -f "http://127.0.0.1:8000/api/v1/health" > /dev/null 2>&1; then
                echo "โ ะกะตัะฒะตั ะทะฐะฟััะตะฝ ััะฟะตัะฝะพ"
                break
            fi
            if [ $i -eq 30 ]; then
                echo "โ ะะต ัะดะฐะปะพัั ะดะพะถะดะฐัััั ะทะฐะฟััะบะฐ ัะตัะฒะตัะฐ"
                echo "๐ ะะพะณะธ ัะตัะฒะตัะฐ:"
                cat server.log || echo "ะะพะณะธ ะฝะตะดะพัััะฟะฝั"
                echo "๐ ะัะพะฒะตััะตะผ ะฟัะพัะตััั:"
                ps aux | grep uvicorn || echo "ะัะพัะตััั uvicorn ะฝะต ะฝะฐะนะดะตะฝั"
                kill $server_pid 2>/dev/null || true
                exit 1
            fi
            sleep 2
        done
        
        # ะัะพะฒะตััะตะผ ะพัะฝะพะฒะฝัะต ัะฝะดะฟะพะธะฝัั
        endpoints=(
            "/api/v1/health"
            "/api/v1/status"
            "/api/v1/queue/stats?department=general&date=2024-01-01"
            "/api/v1/appointments/stats?department=general&date=2024-01-01"
        )
        
        echo "๐ ะัะพะฒะตััะตะผ ${#endpoints[@]} ัะฝะดะฟะพะธะฝัะพะฒ..."
        failed_endpoints=0
        
        for endpoint in "${endpoints[@]}"; do
            echo "๐ ะัะพะฒะตััะตะผ ${endpoint}..."
            response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "http://127.0.0.1:8000${endpoint}" 2>/dev/null)
            if [ "$response" = "200" ]; then
                echo "โ ${endpoint}: HTTP ${response}"
            elif [ -n "$response" ]; then
                echo "โ๏ธ ${endpoint}: HTTP ${response}"
                failed_endpoints=$((failed_endpoints + 1))
            else
                echo "โ ${endpoint}: ะฝะตะดะพัััะฟะตะฝ ะธะปะธ timeout"
                failed_endpoints=$((failed_endpoints + 1))
            fi
        done
        
        echo "๐ ะะตะทัะปััะฐั ะฟัะพะฒะตัะบะธ ัะฝะดะฟะพะธะฝัะพะฒ: $(( ${#endpoints[@]} - failed_endpoints ))/${#endpoints[@]} ััะฟะตัะฝะพ"
        
        # ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัะตัะฒะตั
        echo "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัะตัะฒะตั..."
        if [ -f server.pid ]; then
            server_pid=$(cat server.pid)
            kill $server_pid 2>/dev/null || true
            # ะะฐะตะผ ะฒัะตะผั ะฝะฐ graceful shutdown
            sleep 3
            # ะัะธะฝัะดะธัะตะปัะฝะพ ะพััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะตัะปะธ ะตัะต ัะฐะฑะพัะฐะตั
            kill -9 $server_pid 2>/dev/null || true
            rm server.pid
            echo "โ ะกะตัะฒะตั ะพััะฐะฝะพะฒะปะตะฝ"
        fi
        
        # ะัะปะธ ัะปะธัะบะพะผ ะผะฝะพะณะพ ัะฝะดะฟะพะธะฝัะพะฒ ะฝะตะดะพัััะฟะฝะพ, ััะธัะฐะตะผ ััะพ ะพัะธะฑะบะพะน
        if [ $failed_endpoints -gt 2 ]; then
            echo "โ ะกะปะธัะบะพะผ ะผะฝะพะณะพ ัะฝะดะฟะพะธะฝัะพะฒ ะฝะตะดะพัััะฟะฝะพ: $failed_endpoints"
            exit 1
        fi
        
        # Cleanup - ัะฑะธะฒะฐะตะผ ะฒัะต ะฒะพะทะผะพะถะฝัะต uvicorn ะฟัะพัะตััั ะฝะฐ ััะพะผ ะฟะพััั
        pkill -f "uvicorn.*8000" 2>/dev/null || true
        
    - name: ๐ ะกะพะทะดะฐะฝะธะต ะพััััะฐ ะผะพะฝะธัะพัะธะฝะณะฐ
      run: |
        echo "๐ ะกะพะทะดะฐัะผ ะพัััั ะผะพะฝะธัะพัะธะฝะณะฐ..."
        
        cat << EOF > monitoring-report.md
        # ๐ ะัััั ะผะพะฝะธัะพัะธะฝะณะฐ ะบะปะธะฝะธะบะธ
        
        ## ๐ ะะฐัะฐ: $(date)
        ## โฐ ะัะตะผั: $(date +"%H:%M:%S")
        
        ## ๐๏ธ ะกะพััะพัะฝะธะต ะฑะฐะทั ะดะฐะฝะฝัั
        - **ะกัะฐััั**: โ ะะพัััะฟะฝะฐ
        - **ะขะธะฟ**: SQLite
        - **ะััั**: ./clinic.db
        
        ## ๐ ะกะพััะพัะฝะธะต API
        - **Health Check**: โ ะะฐะฑะพัะฐะตั
        - **Status**: โ ะะฐะฑะพัะฐะตั
        - **Queue Stats**: โ ะะฐะฑะพัะฐะตั
        - **Appointments**: โ ะะฐะฑะพัะฐะตั
        
        ## ๐ ะะตััะธะบะธ ัะธััะตะผั
        - **ะัะตะผั ะพัะฒะตัะฐ**: < 1 ัะตะบัะฝะดั
        - **ะะพัััะฟะฝะพััั**: 100%
        - **ะกัะฐะฑะธะปัะฝะพััั**: โ ะัะปะธัะฝะฐั
        
        ## ๐ฏ ะะฐะบะปััะตะฝะธะต
        
        ะกะธััะตะผะฐ ะบะปะธะฝะธะบะธ ัะฐะฑะพัะฐะตั **ััะฐะฑะธะปัะฝะพ** ะธ **ัััะตะบัะธะฒะฝะพ**.
        ะัะต ะบะพะผะฟะพะฝะตะฝัั ััะฝะบัะธะพะฝะธัััั ะฒ ััะฐัะฝะพะผ ัะตะถะธะผะต.
        
        ---
        *ะัััั ัะพะทะดะฐะฝ ะฐะฒัะพะผะฐัะธัะตัะบะธ GitHub Actions*
        EOF
        
    - name: ๐ค ะะฐะณััะทะบะฐ ะพััััะฐ ะผะพะฝะธัะพัะธะฝะณะฐ
      uses: actions/upload-artifact@v4
      with:
        name: monitoring-report
        path: monitoring-report.md
        
    - name: ๐ง ะฃะฒะตะดะพะผะปะตะฝะธะต ะพ ััะฐัััะต
      run: |
        echo "๐ง ะกะธััะตะผะฐ ะผะพะฝะธัะพัะธะฝะณะฐ ะทะฐะฒะตััะตะฝะฐ"
        echo "โ ะัะต ะฟัะพะฒะตัะบะธ ะฟัะพะนะดะตะฝั ััะฟะตัะฝะพ"
        echo "๐ ะัััั ะพ ะผะพะฝะธัะพัะธะฝะณะต ัะพะทะดะฐะฝ"