# SSOT Migration: Queue Architecture Fix

## ‚ö†Ô∏è –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–æ–±–ª–µ–º–∞
Visit –∏ OnlineQueueEntry —Å–º–µ—à–∞–Ω—ã. –û—á–µ—Ä–µ–¥—å –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∏–∑ –¥–≤—É—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ ‚Üí —Ü–µ–ø–Ω—ã–µ –±–∞–≥–∏.

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- [x] Frontend –≤—ã–∑—ã–≤–∞–µ—Ç full-update endpoint (–Ω–µ cart) –¥–ª—è QR-–∑–∞–ø–∏—Å–µ–π
- [x] API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç OnlineQueueEntry.id (–Ω–µ Visit.id) –¥–ª—è QR-–≤–∏–∑–∏—Ç–æ–≤  
- [x] queue_time —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ë–ï–ó –∏–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ª—É–≥

## ‚ùå –ù–æ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (—Å–ª–µ–¥—Å—Ç–≤–∏—è –ø–∞—Ç—á–µ–≤–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞)
- [ ] **P1**: –ù–æ–≤–∞—è —É—Å–ª—É–≥–∞ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤–æ–µ queue_time –∏ –Ω–æ–º–µ—Ä
- [ ] **P2**: –°—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ "–∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω" –≤–º–µ—Å—Ç–æ "–í –æ—á–µ—Ä–µ–¥–∏"
- [ ] **P3**: –°—Ç–æ–∏–º–æ—Å—Ç—å –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
- [ ] **P4**: –í–∫–ª–∞–¥–∫–∞ –≠–ö–ì –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É—Å–ª—É–≥–∏ D01 (–Ω–µ–≤–µ—Ä–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è)

---

## üéØ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–∏–Ω—Ü–∏–ø 1: Visit ‚â† Queue
```
Visit = –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–ª–∞—Ç–µ–∂–µ–π, —Å–æ–¥–µ—Ä–∂–∏—Ç VisitService
OnlineQueueEntry = –∑–∞–ø–∏—Å—å –≤ –æ—á–µ—Ä–µ–¥–∏ —Å queue_time, number, source
```

### –ü—Ä–∏–Ω—Ü–∏–ø 2: –û—á–µ—Ä–µ–¥—å —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ OnlineQueueEntry
- Visit –ù–ï –≤–ª–∏—è–µ—Ç –Ω–∞ –ø–æ—Ä—è–¥–æ–∫
- queue_time –∏ number –∂–∏–≤—É—Ç –¢–û–õ–¨–ö–û –≤ OnlineQueueEntry
- source –∂–∏–≤—ë—Ç –≤ OnlineQueueEntry (—É–∂–µ –µ—Å—Ç—å)

### –ü—Ä–∏–Ω—Ü–∏–ø 3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥ ‚Üí –Ω–æ–≤–∞—è OnlineQueueEntry
```
–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–∞—Ü–∏–µ–Ω—Ç–∞ ‚Üí –ù–ï–¢ –Ω–æ–≤–æ–π entry, —Å–æ—Ö—Ä–∞–Ω—è–µ–º queue_time
–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∏ ‚Üí –ù–û–í–ê–Ø entry —Å –Ω–æ–≤—ã–º queue_time –∏ number
```

### –ü—Ä–∏–Ω—Ü–∏–ø 4: –°—Ç–∞—Ç—É—Å –∏ —Å—É–º–º–∞ –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è –∏–∑ entries
```python
status = compute_from_entries(all_patient_entries_today)
payment_sum = sum(entry.total_amount for entry in entries)
```

---

## –≠—Ç–∞–ø—ã —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

### Phase 1: –†–∞–∑–æ—Ä–≤–∞—Ç—å Visit ‚Üí Queue
- [ ] get_today_queues: –æ—á–µ—Ä–µ–¥—å –¢–û–õ–¨–ö–û –∏–∑ OnlineQueueEntry
- [ ] Visit –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç record_type="online_queue"
- [ ] –£–±—Ä–∞—Ç—å entry_type_for_visit –ª–æ–≥–∏–∫—É

### Phase 2: –ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É full_update
- [ ] –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö ‚Üí update existing entry, preserve queue_time
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∏ ‚Üí create NEW entry —Å —Ç–µ–∫—É—â–∏–º queue_time –∏ –Ω–æ–≤—ã–º number
- [ ] –£–¥–∞–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∏ ‚Üí soft-delete entry (status='cancelled')

### Phase 3: –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ —Å—Ç–∞—Ç—É—Å–∞ –∏ —Å—É–º–º—ã
- [ ] status –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∏–∑ entries, –Ω–µ –∏–∑ Visit
- [ ] total_cost –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∏–∑ entries.services, –Ω–µ –∏–∑ VisitService

### Phase 4: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≤–∫–ª–∞–¥–∫–∞–º
- [ ] –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ specialty –∏–∑ entry, –Ω–µ –∏–∑ Visit

---

## Status: ARCHITECTURAL REFACTORING REQUIRED
–ü–∞—Ç—á–µ–≤—ã–π –ø–æ–¥—Ö–æ–¥ –∏—Å—á–µ—Ä–ø–∞–Ω. –ù—É–∂–µ–Ω systematic fix.
