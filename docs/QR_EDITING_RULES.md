# Правила Редактирования QR-Записей (SSOT)

Этот документ описывает строгие правила обработки и редактирования QR-записей (записей онлайн-очереди) в системе, направленные на предотвращение дублирования и поддержание целостности данных.

## 1. Идентификация QR-записи

Запись считается QR-записью (OnlineQueueEntry), если выполняются следующие условия:
*   `record_type === 'online_queue'`
*   `source === 'online'`

## 2. Принцип Единого Источника Истины (SSOT) при Редактировании

При редактировании QR-записи через `AppointmentWizardV2` (или любые другие интерфейсы) **ЗАПРЕЩЕНО** создавать новые записи в БД. Необходимо обновлять существующую запись.

### Правило 2.1: Использование endpoint полного обновления
Для сохранения изменений в QR-записи **ОБЯЗАТЕЛЬНО** использовать метод API:
`PUT /api/v1/qr-queue/online-entry/{entry_id}/full-update`

Этот метод обновляет:
*   Данные пациента (ФИО, телефон, год рождения, адрес)
*   Тип визита и скидки
*   Список услуг (удаляет старые, добавляет новые)

### Правило 2.2: Запрет на использование `create_cart_appointments`
При редактировании существующей QR-записи **ЗАПРЕЩЕНО** использовать endpoint `POST /registrar/cart` (`create_cart_appointments`), так как он всегда создает *новые* записи в очереди и визиты, что приводит к дубликатам.

## 3. Логика Frontend (AppointmentWizardV2)

Логика `handleComplete` в `AppointmentWizardV2.jsx` должна следовать следующему алгоритму:

1.  **Проверка типа записи:**
    ```javascript
    const isOnlineQueueEntry = initialData.record_type === 'online_queue' && effectiveSource === 'online';
    ```

2.  **Получение ID:**
    ```javascript
    const queueEntryId = initialData.queue_numbers?.[0]?.id || initialData.id;
    ```

3.  **Выполнение обновления:**
    Если `isOnlineQueueEntry` и `queueEntryId` существуют:
    *   Сформировать payload с данными пациента и услугами из корзины.
    *   Вызвать `updateOnlineQueueEntry` (wrapper для `PUT .../full-update`).
    *   **CRITICAL:** При успешном обновлении немедленно завершить функцию (`return`), чтобы предотвратить выполнение fallback-логики создания записей.

## 4. Дедупликация в Таблице (RegistrarPanel)

При отображении списка записей в `RegistrarPanel` необходимо группировать записи, чтобы предотвратить визуальное дублирование, если один пациент записан к нескольким врачам через QR (хотя технически это разные записи или одна запись с несколькими услугами).

**Ключ дедупликации:**
`dedupKey = online_{pid|phone|fio}_{date}`

*   Приоритет 1: `patient_id`
*   Приоритет 2: `phone` (нормализованный)
*   Приоритет 3: `fio` (нормализованный)
*   Fallback: `entry_id` (если ничего не совпадает)

## 5. Добавление Услуг

При добавлении услуги к существующей QR-записи:
*   Новая услуга добавляется в список услуг существующей `OnlineQueueEntry` через `full-update`.
*   Система **НЕ ДОЛЖНА** создавать отдельную `OnlineQueueEntry` для новой услуги, если это не требуется бизнес-логикой (например, запись к другому специалисту на другое время). В текущей реализации все услуги в рамках одного QR-визита хранятся в одной записи (или связанных записях с единым `visit_id`).
