# AI Execution Budget

> **ÐŸÑ€Ð°Ð²Ð¸Ð»Ð¾**: Ð’ÐµÑ€Ñ…Ð½Ð¸Ð¹ ÑÐ»Ð¾Ð¹ Ð’Ð¡Ð•Ð“Ð”Ð Ð¸Ð¼ÐµÐµÑ‚ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ð¹ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚, Ñ‡ÐµÐ¼ Ð½Ð¸Ð¶Ð½Ð¸Ð¹.  
> `Provider â‰¤ MCP < Frontend`

---

## ðŸ“Š Ð¢Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ñ‹ Ð¿Ð¾ ÑÐ»Ð¾ÑÐ¼

| Ð¡Ð»Ð¾Ð¹ | ÐšÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚ | Timeout | Retry | ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ |
|------|-----------|---------|-------|------------|
| **Frontend** | axios / mcpClient.js | 120s | 0 | hardcoded |
| **MCP Orchestrator** | mcp_manager.py | 180s | 1 | `MCP_REQUEST_TIMEOUT` |
| **AI Provider** | deepseek/openai/gemini | 160s | 0 | `AI_PROVIDER_TIMEOUT` |

---

## âš ï¸ ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°

### 1. Ð˜ÐµÑ€Ð°Ñ€Ñ…Ð¸Ñ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ð¾Ð²
```
Provider (160s) < MCP (180s) < Frontend (120s)
         â†‘              â†‘              â†‘
    HTTP timeout   asyncio.wait_for   UX timeout
```

**ÐŸÐ¾Ñ‡ÐµÐ¼Ñƒ Frontend < MCP?**  
Frontend Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ Ð¾ÑˆÐ¸Ð±ÐºÑƒ Ñ€Ð°Ð½ÑŒÑˆÐµ, Ñ‡ÐµÐ¼ backend Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÑƒ.
Ð­Ñ‚Ð¾ **ÐžÐš** â€” Ð»ÑƒÑ‡ÑˆÐµ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ "Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ" Ñ‡ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ½ÑƒÑ‚ÑŒ.

### 2. Retry Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð° Ð¾Ð´Ð½Ð¾Ð¼ ÑƒÑ€Ð¾Ð²Ð½Ðµ
- âŒ Frontend: **ÐÐ•Ð¢ retry**
- âœ… MCP: **1 retry** Ð¿Ñ€Ð¸ timeout
- âŒ Provider: **ÐÐ•Ð¢ retry**

**ÐŸÐ¾Ñ‡ÐµÐ¼Ñƒ?** Retry Ð½Ð° Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¸Ñ… ÑƒÑ€Ð¾Ð²Ð½ÑÑ… = ÑÐºÑÐ¿Ð¾Ð½ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾Ðµ ÑƒÐ¼Ð½Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº.

### 3. Circuit Breaker
ÐŸÐ¾ÑÐ»Ðµ **3 consecutive failures** Ð¾Ñ‚ Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€Ð°:
- ÐŸÑ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ÑÑ Ð½Ð° **5 Ð¼Ð¸Ð½ÑƒÑ‚**
- Ð›Ð¾Ð³Ð¸Ñ€ÑƒÐµÑ‚ÑÑ `CIRCUIT_BREAKER` ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ
- Fallback Ð½Ð° Ð´Ñ€ÑƒÐ³Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€Ð° (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)

---

## ðŸ”§ ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ

### Backend (.env)
```env
MCP_REQUEST_TIMEOUT=180
AI_PROVIDER_TIMEOUT=160
```

### Frontend (mcpClient.js)
```javascript
const mcpClient = axios.create({
    timeout: 120000,  // 120 ÑÐµÐºÑƒÐ½Ð´
});
```

---

## ðŸ“ˆ ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³

### Ð›Ð¾Ð³Ð¸ Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ
```
MCP_WAIT_START: server=icd10, timeout=180s
MCP_TIMEOUT: server=icd10, elapsed=180.12s, layer=mcp_manager
CIRCUIT_BREAKER: provider=deepseek, disabled_until=...
```

### ÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸
- `/api/v1/mcp/metrics` â€” ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ð¾ ÑÐµÑ€Ð²ÐµÑ€Ð°Ð¼
- `avg_response_time` â€” ÑÑ€ÐµÐ´Ð½ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ Ð¾Ñ‚Ð²ÐµÑ‚Ð°
- `errors` â€” ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¾ÑˆÐ¸Ð±Ð¾Ðº

---

## ðŸš¨ Ð§Ñ‚Ð¾ Ð´ÐµÐ»Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¸ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ð°Ñ…

1. **ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸**: Ð¸ÑÐºÐ°Ñ‚ÑŒ `MCP_TIMEOUT`
2. **ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€Ð°**: API ÑÑ‚Ð°Ñ‚ÑƒÑ, rate limits
3. **ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ circuit breaker**: `/mcp/metrics`
4. **Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ ÑÐ½Ð¸Ð·Ð¸Ñ‚ÑŒ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ñ‹** Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ

---

## ðŸ“ Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹

| Ð”Ð°Ñ‚Ð° | Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ |
|------|-----------|
| 2026-01-17 | ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ. MCP timeout: 30â†’180s |
