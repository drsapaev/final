# Тестовые сценарии для нового мастера регистрации

## Подготовка к тестированию

### Предварительные условия:
1. Запущен backend сервер
2. Запущен frontend сервер
3. В админ-панели включен новый мастер (V2)
4. Есть тестовые данные: врачи, услуги, пациенты

### Тестовые данные:
- **Врач-кардиолог**: для ЭхоКГ
- **Врач-стоматолог**: для рентгенографии зуба
- **Услуги**: ЭКГ, ЭхоКГ, консультация кардиолога, лабораторные анализы
- **Пациент**: с предыдущими консультациями для тестирования повторных визитов

## Сценарий 1: Базовая регистрация

### Шаги:
1. Открыть панель регистратора
2. Нажать "Новая запись" (должен показать V2)
3. **Шаг 1 - Поиск пациента**:
   - Ввести номер телефона существующего пациента
   - Проверить автозаполнение данных
   - Или создать нового пациента
4. **Шаг 2 - Выбор услуг**:
   - Выбрать несколько услуг из разных категорий
   - Проверить группировку K/D/C/L/S/O
   - Проверить расчёт общей суммы
5. **Шаг 3 - Врачи и время**:
   - Для услуг, требующих врача, выбрать врача
   - Выбрать доступные слоты (сегодня/завтра)
6. **Шаг 4 - Подтверждение**:
   - Проверить итоговую сумму
   - Выбрать способ оплаты
   - Завершить регистрацию

### Ожидаемый результат:
- Создается `PaymentInvoice` с несколькими `Visit`
- Пациент добавляется в соответствующие очереди
- Печатаются отдельные талоны для каждого визита

## Сценарий 2: Повторный визит (льгота)

### Предварительные условия:
- Пациент имел консультацию у кардиолога менее 21 дня назад

### Шаги:
1. Найти пациента с предыдущей консультацией
2. Выбрать "Консультация кардиолога"
3. Выбрать тип визита "Повторный"
4. Проверить, что цена = 0 (бесплатно)
5. Завершить регистрацию

### Ожидаемый результат:
- `Visit.discount_mode = "repeat"`
- Цена консультации = 0
- Система проверила дату предыдущей консультации у того же специалиста

## Сценарий 3: Льготный визит

### Шаги:
1. Найти пациента
2. Выбрать консультацию специалиста
3. Выбрать тип визита "Льготный"
4. Проверить, что цена консультации = 0
5. Завершить регистрацию

### Ожидаемый результат:
- `Visit.discount_mode = "benefit"`
- Цена консультации = 0
- Остальные услуги остаются платными

## Сценарий 4: All Free (требует одобрения)

### Шаги:
1. Найти пациента
2. Выбрать несколько услуг (включая платные процедуры)
3. Поставить галочку "All Free"
4. Завершить регистрацию
5. **В админ-панели**:
   - Перейти в "Заявки All Free"
   - Найти созданную заявку
   - Одобрить или отклонить

### Ожидаемый результат:
- `Visit.discount_mode = "all_free"`
- `Visit.approval_status = "pending"`
- Заявка появляется в админ-панели
- После одобрения все услуги становятся бесплатными

## Сценарий 5: Корзина (мультивизит)

### Шаги:
1. Найти пациента
2. Добавить в корзину:
   - ЭКГ (без врача)
   - ЭхоКГ + консультация кардиолога (с врачом)
   - Лабораторные анализы (без врача)
3. Выбрать разное время для каждого визита
4. Проверить итоговую сумму
5. Завершить регистрацию

### Ожидаемый результат:
- Создается один `PaymentInvoice`
- Создается 3 отдельных `Visit` с разными `queue_tag`
- Печатается 3 отдельных талона
- Пациент попадает в разные очереди

## Сценарий 6: Click оплата

### Шаги:
1. Создать запись с платными услугами
2. Выбрать способ оплаты "Онлайн - Click"
3. Нажать "Оплатить"
4. Проверить редирект на Click
5. **В тестовой среде**: симулировать успешную оплату
6. Проверить возврат в систему
7. Проверить статус оплаты

### Ожидаемый результат:
- `PaymentInvoice.status = "pending"` → `"paid"`
- Все связанные `Visit.status = "paid"`
- Автоматическая печать талонов после оплаты

## Сценарий 7: Автосохранение и горячие клавиши

### Шаги:
1. Начать заполнение мастера
2. Заполнить данные пациента
3. Выбрать услуги
4. **Закрыть браузер/вкладку**
5. Открыть мастер снова
6. Проверить восстановление данных
7. Проверить работу горячих клавиш:
   - `Enter` - переход к следующему шагу
   - `Ctrl+Enter` - завершение
   - `Shift+Enter` - новая строка в textarea

### Ожидаемый результат:
- Данные восстанавливаются из localStorage
- Показывается кнопка "Очистить черновик"
- Горячие клавиши работают корректно

## Сценарий 8: Очереди и queue_tag

### Шаги:
1. Создать записи с разными услугами:
   - ЭКГ (`queue_tag: "ecg"`)
   - ЭхоКГ + консультация кардиолога (`queue_tag: "cardiology_common"`)
   - Стоматология (`queue_tag: "stomatology"`)
2. Проверить, что пациенты попадают в правильные очереди
3. В панели очередей проверить разделение

### Ожидаемый результат:
- ЭКГ - отдельная очередь без врача
- ЭхоКГ и консультация кардиолога - общая кардио-очередь
- Стоматология - отдельная очередь

## Сценарий 9: Динамическое ценообразование

### Предварительные условия:
- Врач-дерматолог изменил цену процедуры через свою панель

### Шаги:
1. **В панели дерматолога**:
   - Выбрать процедуру
   - Изменить цену с указанием причины
   - Отправить на одобрение
2. **В панели регистратора**:
   - Перейти в "Изменения цен"
   - Найти запрос от дерматолога
   - Одобрить изменение
3. **Создать новую запись**:
   - Выбрать ту же процедуру
   - Проверить, что используется новая цена

### Ожидаемый результат:
- `DoctorPriceOverride.status = "approved"`
- `Visit.doctor_price_override` содержит информацию об изменении
- Новая цена применяется в последующих записях

## Сценарий 10: Сравнение с классическим мастером

### Шаги:
1. **В админ-панели**: переключить на старый мастер (V1)
2. Создать запись через старый мастер
3. Переключить на новый мастер (V2)
4. Создать аналогичную запись через новый мастер
5. Сравнить результаты

### Ожидаемый результат:
- Оба мастера создают корректные записи
- Новый мастер предоставляет дополнительные функции
- Данные совместимы между версиями

## Критерии успешного тестирования

### Функциональность:
- ✅ Все сценарии выполняются без ошибок
- ✅ Данные корректно сохраняются в БД
- ✅ Очереди работают правильно
- ✅ Оплата проходит успешно
- ✅ Льготы применяются корректно

### Производительность:
- ✅ Мастер загружается быстро (< 2 сек)
- ✅ Поиск пациентов работает мгновенно
- ✅ Автосохранение не замедляет интерфейс

### UX/UI:
- ✅ Интерфейс интуитивно понятен
- ✅ Горячие клавиши работают
- ✅ Ошибки отображаются понятно
- ✅ Дизайн соответствует Windows 11

### Совместимость:
- ✅ Работает в Chrome, Firefox, Edge
- ✅ Адаптивный дизайн на разных экранах
- ✅ Совместимость со старой системой

## Отчёт о тестировании

После выполнения всех сценариев создать отчёт:

```markdown
# Отчёт о тестировании мастера регистрации V2

## Дата: [DATE]
## Тестировщик: [NAME]

### Выполненные сценарии:
- [ ] Сценарий 1: Базовая регистрация
- [ ] Сценарий 2: Повторный визит
- [ ] Сценарий 3: Льготный визит
- [ ] Сценарий 4: All Free
- [ ] Сценарий 5: Корзина
- [ ] Сценарий 6: Click оплата
- [ ] Сценарий 7: Автосохранение
- [ ] Сценарий 8: Очереди
- [ ] Сценарий 9: Динамическое ценообразование
- [ ] Сценарий 10: Сравнение с V1

### Найденные проблемы:
[Список проблем с приоритетом]

### Рекомендации:
[Рекомендации по улучшению]

### Заключение:
[Готовность к продакшену: ДА/НЕТ]
```
