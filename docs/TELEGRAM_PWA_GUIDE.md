# üì± Telegram Bot & PWA Integration Guide

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∫–ª–∏–Ω–∏–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å Telegram –±–æ—Ç–æ–º –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ PWA —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é –¥–ª—è –æ—Ñ–ª–∞–π–Ω —Ä–∞–±–æ—Ç—ã.

## ü§ñ Telegram Bot

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞

1. **–°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞:**
   ```bash
   # 1. –ù–∞–π–¥–∏—Ç–µ @BotFather –≤ Telegram
   # 2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ /newbot
   # 3. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º
   # 4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω
   ```

2. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ–∫–µ–Ω–∞:**
   ```bash
   # –í .env —Ñ–∞–π–ª–µ
   TELEGRAM_BOT_TOKEN=your-bot-token-here
   
   # –ò–ª–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
   export TELEGRAM_BOT_TOKEN="your-bot-token"
   ```

### –§—É–Ω–∫—Ü–∏–∏ –±–æ—Ç–∞

#### –ö–æ–º–∞–Ω–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
- `/start` - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–∞–º–∏
- `/queue` - –£—Ç—Ä–µ–Ω–Ω—è—è –æ—á–µ—Ä–µ–¥—å (07:00-08:00)
- `/appointment` - –ó–∞–ø–∏—Å—å –Ω–∞ –ø—Ä–∏–µ–º (Web App)
- `/help` - –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º

#### –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- üè• **–£—Ç—Ä–µ–Ω–Ω—è—è –æ—á–µ—Ä–µ–¥—å** - –∑–∞–ø–∏—Å—å –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º
- üìÖ **Web App –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- üìã **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ —Å—Ç–∞—Ç—É—Å—ã
- üìÑ **–î–æ–∫—É–º–µ–Ω—Ç—ã** - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ —Ä–µ—Ü–µ–ø—Ç–æ–≤

### API Endpoints

#### Webhook:
```bash
POST /api/v1/telegram/bot/webhook
# –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç Telegram
```

#### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook (–∞–¥–º–∏–Ω)
POST /api/v1/telegram/bot/set-webhook
{
  "webhook_url": "https://your-domain.com/api/v1/telegram/bot/webhook"
}

# –£–¥–∞–ª–µ–Ω–∏–µ webhook (–∞–¥–º–∏–Ω)  
DELETE /api/v1/telegram/bot/webhook

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ
GET /api/v1/telegram/bot/info
```

#### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:
```bash
# –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
POST /api/v1/telegram/bot/send-notification
{
  "user_id": 123456789,
  "message": "–í–∞—à–∞ –æ—á–µ—Ä–µ–¥—å –ø–æ–¥–æ—à–ª–∞!"
}

# –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –≤–∏–∑–∏—Ç–µ
POST /api/v1/telegram/bot/send-appointment-reminder
{
  "user_id": 123456789,
  "appointment": {
    "doctor": "–ò–≤–∞–Ω–æ–≤ –ò.–ò.",
    "date": "2024-01-20",
    "time": "14:30"
  }
}

# –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
POST /api/v1/telegram/bot/send-lab-notification
{
  "user_id": 123456789,
  "results": {
    "test_name": "–û–±—â–∏–π –∞–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏",
    "date": "2024-01-19"
  }
}
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ

```python
from app.services.telegram import telegram_bot, notification_service

# –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
await telegram_bot.send_notification(
    user_id=123456789,
    message="–í–∞—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–æ—Ç–æ–≤—ã!"
)

# –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –≤–∏–∑–∏—Ç–µ
await notification_service.send_appointment_reminder(
    user_id=user_id,
    visit_id=visit_id,
    hours_before=24
)
```

## üì± PWA (Progressive Web App)

### –§—É–Ω–∫—Ü–∏–∏ PWA

#### Service Worker:
- ‚úÖ **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –∏ API –¥–∞–Ω–Ω—ã–µ
- ‚úÖ **–û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º** - —Ä–∞–±–æ—Ç–∞ –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
- ‚úÖ **Background Sync** - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
- ‚úÖ **Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - —Å–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- ‚úÖ **HEIC –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è** - —Ñ–æ–Ω–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

#### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
- üì± **–ù–∞ –¥–æ–º–∞—à–Ω–∏–π —ç–∫—Ä–∞–Ω** - –∫–∞–∫ –Ω–∞—Ç–∏–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- üñ•Ô∏è **–ù–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä** - —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä
- ‚ö° **–ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫** - –±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ PWA –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

#### PWA Hook:
```jsx
import { usePWA } from './hooks/usePWA';

function MyComponent() {
  const {
    isInstallable,
    isInstalled,
    isOnline,
    installPWA,
    sendNotification
  } = usePWA();

  return (
    <div>
      {isInstallable && (
        <button onClick={installPWA}>
          –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        </button>
      )}
      
      <div>
        –°—Ç–∞—Ç—É—Å: {isOnline ? '–û–Ω–ª–∞–π–Ω' : '–û—Ñ–ª–∞–π–Ω'}
      </div>
    </div>
  );
}
```

#### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
```jsx
import { PWAInstallPrompt, ConnectionStatus } from './components/pwa';

// –ü—Ä–æ–º–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PWA
<PWAInstallPrompt onClose={() => setShowPrompt(false)} />

// –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
<ConnectionStatus showOfflineAlert={true} />
```

#### HEIC –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è:
```jsx
import { convertHEICToJPEG, isHEICFile } from './utils/heicConverter';

async function handleFileUpload(files) {
  for (const file of files) {
    if (isHEICFile(file)) {
      const jpegFile = await convertHEICToJPEG(file, 0.8);
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª
    }
  }
}
```

### Service Worker –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

#### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:
```javascript
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫—ç—à–∏—Ä—É—é—Ç—Å—è:
- –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã (HTML, CSS, JS)
- API endpoints (/api/v1/auth/me, /api/v1/patients, etc.)
- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —Ä–µ—Å—É—Ä—Å—ã

// –ù–ï –∫—ç—à–∏—Ä—É—é—Ç—Å—è:
- –ü–ª–∞—Ç–µ–∂–∏ (/api/v1/payments)
- AI –∑–∞–ø—Ä–æ—Å—ã (/api/v1/ai)
- Telegram webhook (/api/v1/telegram)
```

#### Background Sync:
```javascript
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ñ–ª–∞–π–Ω –æ—á–µ—Ä–µ–¥–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —É—Å–ø–µ—à–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
```

#### Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:
```javascript
// –ß–µ—Ä–µ–∑ Service Worker
await registration.showNotification('–ó–∞–≥–æ–ª–æ–≤–æ–∫', {
  body: '–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',
  icon: '/favicon.ico',
  actions: [
    { action: 'explore', title: '–û—Ç–∫—Ä—ã—Ç—å' },
    { action: 'close', title: '–ó–∞–∫—Ä—ã—Ç—å' }
  ]
});
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –¥–µ–ø–ª–æ–π

### Backend –Ω–∞—Å—Ç—Ä–æ–π–∫–∞:

1. **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
   ```bash
   TELEGRAM_BOT_TOKEN=your-bot-token
   FRONTEND_URL=https://your-domain.com
   ```

2. **Webhook –Ω–∞—Å—Ç—Ä–æ–π–∫–∞:**
   ```bash
   # –ß–µ—Ä–µ–∑ API (–Ω—É–∂–Ω—ã –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞)
   curl -X POST https://your-api.com/api/v1/telegram/bot/set-webhook \
     -H "Authorization: Bearer YOUR_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"webhook_url": "https://your-api.com/api/v1/telegram/bot/webhook"}'
   ```

### Frontend –Ω–∞—Å—Ç—Ä–æ–π–∫–∞:

1. **Manifest.json:**
   ```json
   {
     "name": "–ö–ª–∏–Ω–∏–∫–∞",
     "short_name": "Clinic",
     "start_url": "/",
     "display": "standalone",
     "theme_color": "#1976d2",
     "background_color": "#ffffff"
   }
   ```

2. **Service Worker —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:**
   ```javascript
   // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ main.jsx
   if ('serviceWorker' in navigator) {
     navigator.serviceWorker.register('/sw.js');
   }
   ```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:
```bash
python test_telegram_pwa.py
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π:
1. **Telegram –±–æ—Ç** - –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /start –±–æ—Ç—É
2. **PWA —É—Å—Ç–∞–Ω–æ–≤–∫–∞** - –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –≤ Chrome/Edge
3. **–û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º** - –æ—Ç–∫–ª—é—á–∏—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
4. **Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - —Ä–∞–∑—Ä–µ—à–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
5. **HEIC –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è** - –∑–∞–≥—Ä—É–∑–∏—Ç–µ .heic —Ñ–∞–π–ª

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞:
```bash
GET /api/v1/telegram/bot/stats
# –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å–æ–æ–±—â–µ–Ω–∏–π, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
```

### PWA –º–µ—Ç—Ä–∏–∫–∏:
- Service Worker —Å—Ç–∞—Ç—É—Å –≤ DevTools
- Cache Storage —Ä–∞–∑–º–µ—Ä
- Background Sync –∑–∞–¥–∞—á–∏
- Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–∫–∞

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### Telegram:
- Webhook URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å HTTPS
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø—Ä–∞–≤ –ø–æ —Ä–æ–ª—è–º

### PWA:
- HTTPS –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è Service Worker
- –í–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∏—Ä—É–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ñ–ª–∞–π–Ω –∑–∞–ø—Ä–æ—Å–æ–≤

## üì± –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç

### Telegram:
1. –ù–∞–π—Ç–∏ –±–æ—Ç–∞ –ø–æ username
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å /start
3. –í—ã–±—Ä–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ –º–µ–Ω—é
4. –ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### PWA:
1. –û—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. –£–≤–∏–¥–µ—Ç—å –ø—Ä–æ–º–ø—Ç "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ –¥–æ–º–∞—à–Ω–∏–π —ç–∫—Ä–∞–Ω
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ –Ω–∞—Ç–∏–≤–Ω—ã–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º

## üêõ Troubleshooting

### Telegram –±–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ TELEGRAM_BOT_TOKEN
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ backend

### PWA –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è:
- –ù—É–∂–µ–Ω HTTPS (–∫—Ä–æ–º–µ localhost)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ manifest.json
- Service Worker –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω

### –û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
- Service Worker –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–∫—Ç–∏–≤–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Cache Storage –≤ DevTools
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –Ω—É–∂–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –∫—ç—à–∏—Ä—É—é—Ç—Å—è

### HEIC –Ω–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∫—É –±—Ä–∞—É–∑–µ—Ä–∞
- Service Worker –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≥–æ—Ç–æ–≤
- Fallback –Ω–∞ heic2any –±–∏–±–ª–∏–æ—Ç–µ–∫—É
