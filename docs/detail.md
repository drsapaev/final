ниже — полный, самостоятельный «паспорт» модуля Регистратура. Он описывает всё: таблицу, режимы работы, интерфейс, бизнес‑правила, обмен с остальными панелями, печать, оплаты, онлайн‑очередь, конфиги, API, события, безопасность, тест‑чеклист.

1) Назначение и роль

Регистратура — центральная операционная панель приёма. Оперирует очередями (живой/плановой/онлайн), пациентами, талонами, оплатами и маршрутами пациента (врач, лаборатория, доп. услуги). Является «источником правды» для табло и кассы.


---

2) Данные и структура (уровень БД)

2.1. Основные сущности

patients: id, fio, birth_year, phone (uniq), address, telegram_id?, created_at.

visits: id, patient_id, doctor_id, date, status (planned|queued|in_progress|done|canceled|no_show|paid_pending|paid), source (desk|online|telegram|pwa), complaint?, diagnosis?, icd10?, total_cost?, draft_json?, created_at.

services: id, title, code?, price, category (consultation|lab|procedure|echo|ecg|dent|derm|cosmetology|other), active.

visit_services: visit_id, service_id, qty, price, note?.

daily_queues: id, day (date), specialist_id (врач/кабинет), active (bool), opened_at (datetime|null) — факт открытия приема.

queue_entries: id, queue_id, number (1..N), patient_id?, patient_name, phone?, telegram_id?, created_at.

payments: id, visit_id?, provider, invoice_id?, amount, currency, status (created|pending|paid|canceled|failed|refunded), meta, created_at.

schedules: doctor_id, weekday, start, end, breaks_json?.

audit_logs: actor_id, event, entity, entity_id, payload, ts.


2.2. Индексы (важно для скорости регистратуры)

patients(phone) (unique)

visits(patient_id, date)

queue_entries(queue_id, phone)

queue_entries(queue_id, telegram_id)

payments(provider, invoice_id)

daily_queues(day, specialist_id)



---

3) Режимы работы очереди

3.1. Живая очередь (дневная)

Нумерация с 1 для каждого специалиста/кабинета каждый день.

Источник: регистрация на месте + подтягивание подтверждённых плановых записей.

Талон печатается сразу после сохранения.


3.2. Плановые записи (на будущий день)

Без времени (дневной визит). В день Х — перевод в живую очередь по подтверждению.

Подтверждение пациентом через Telegram/PWA (кнопки: «подтвердить/перенести/отменить»).


3.3. Онлайн‑очередь (утреннее окно)

Доступна с 07:00 локального времени (Asia/Tashkent) и до открытия регистратуры.

Открытие приёма фиксирует daily_queues.opened_at → закрывает набор онлайн.

Уникальность: один номер на телефон или Telegram‑чат. Повтор вернёт тот же номер.

Лимиты: макс N номеров на врача (например, ≤ 15); авто‑закрытие (порог, например, 09:00).

Стартовый номер в онлайне: кастомно на спец‑профиль (например, стоматолог с №3, дерматолог с №15).



---

4) Интерфейс регистратуры (UI/UX)

4.1. Основная таблица

Колонки (пример по умолчанию):

1. № (автонумерация для дня и специалиста
2. ФИО
3. Год рождения
4. Телефон
5. Адрес (сворачиваемая колонка)
6. Специалист/Кабинет
7. Тип обращения (платный/повторный/льготный)
8. Услуги (чек‑лист, группами — дерма/косметология/кардио/ЭКГ/ЭхоКГ/стоматология/лаборатория)
9. Вид оплаты (нал/карта/онлайн)
10. Стоимость (итоговая)
11. Статус (план/подтверждён/в очереди/в кабинете/завершён/отменён/неявка)
12. Действия (печать талона, чек, отмена, перенос)

Особенности:

Пустые строки — внизу всегда ≥5, чтобы печатать талон быстрее.

Автозаполнение: по телефону/ФИО → подтягиваем карточку пациента.

Фиксация колонок №/ФИО/телефон слева; действия справа.

Быстрые фильтры: по врачу/дню/статусу/оплате.

Инлайн‑валидация: маска телефона, год (1900…текущий – 1), required поля.


4.2. Панель действий

Кнопки: «Новая запись», «Печать талона», «Оплатить», «QR онлайн‑оплаты», «Открыть приём сейчас» (закрывает утренний онлайн набор), «Экспорт CSV/PDF».

Горячие клавиши:

Enter — сохранить/распечатать талон,

Ctrl+P — печать талона,

Ctrl+K — перейти к поиску пациента,

Ctrl+Shift+O — открыть приём (подтверждение).


Тосты: успех/ошибка, предупреждения (дубликат номера, пустые поля, превышение лимита).


4.3. Вкладки (специальности)

1. Универсальная — общий реестр.


2. Дерматолог‑косметолог — колонка «Процедуры» (группы дерма/косметология), «Стоимость от врача».


3. Кардиолог — чек «ЭхоКГ как доп.услуга» (попадание во вкладку ЭхоКГ), отдельная вкладка ЭхоКГ.


4. Стоматолог — онлайн‑очередь без выбора услуги; оплата консультации до визита.



4.4. Календарь

Единый календарь записей (по врачам/кабинетам).

Цвета статусов: серый — план, синий — подтверждено, зеленый — в очереди, оранжевый — в кабинете, зеленый тёмный — завершён, красный — отменен/неявка.



---

5) Печать и документы

5.1. Талон (термопринтер / ESC‑POS)

Содержимое: клиника, дата/время, № очереди (крупно), ФИО/год, услуга/специалист, оплата (если предоплачено), текст‑подсказка (язык ru/uz).

Печать сразу после сохранения записи.

Язык талона зависит от lang (ru/uz) на рабочем месте.


5.2. Квитанция/чек

Наличные: ESC/POS чек (касса).

Онлайн: PDF‑квитанция (сумма, услуги, способ оплаты), возможность отправки в Telegram.



---

6) Оплаты

6.1. Наличные

Кнопка «Оплатить (наличные)» → печать ESC/POS чека → статус paid.


6.2. Онлайн (Click, Payme, Kaspi, Stripe, Apple/Google Pay и т.д.)

«Оплатить онлайн» → POST /api/payments/init → ссылка/QR для пациента.

После оплаты провайдер бьёт в /{provider}/webhook → status=paid → помечаем визит и талон «оплачено».

Привязка платежа к визиту (/attach-visit), история в payments.



---

7) Онлайн‑очередь (утреннее окно)

7.1. Генерация QR

POST /api/online-queue/qrcode?day=YYYY-MM-DD&specialist_id=... → токен (вшивает дату и врача).

QR/ссылка ведёт в PWA‑страницу QueueJoin.


7.2. Вступление в очередь

PWA/Telegram отправляет { token, phone?, telegram_id? }.

Правила:

Доступно только с 07:00 до opened_at.

Один номер по телефону или Telegram‑чату (повтор → отдаём ранее выданный).

Макс N номеров на врача/день (конфиг).

(Опц.) Авто‑закрытие по времени (например, 09:00).


Ответ: { number, duplicate?: true }.


7.3. Открытие приёма

Регистратор нажимает «Открыть приём сейчас» → проставляется opened_at → онлайн набор закрыт.



---

8) Взаимодействия с остальными модулями

8.1. Врач

Регистратура создаёт визит → врач видит пациента в своей очереди.

Стоимость процедур, заданная врачом, синхронизируется с регистратурой.

Статусы: регистратор переводит queued → врач может поставить in_progress → done.


8.2. Лаборатория

Регистратор может добавить лабораторные услуги к визиту.

Появляются заявки в лаборатории (по услуге/панели).

Готовность результатов → уведомление пациенту/врачу.


8.3. Табло очереди

Любое изменение очереди (добавление/вызов/завершение) уходит в WebSocket канал табло.

Настройки табло (ролики/звуки/тема) в админке.


8.4. Касса/Оплаты

Регистратура инициирует платежи (нал/онлайн).

Печать чека, PDF‑квитанция, вебхуки.


8.5. Админ

Конфиги очереди, провайдеров оплат, AI, табло, расписания, роли/доступы.



---

9) Конфигурации (Admin → Settings)

Очередь:

TIMEZONE=Asia/Tashkent

QUEUE_START_HOUR=7

online_start_number per speciality

online_max_per_day per speciality (напр., 15)

online_auto_close_time (напр., 09:00)


Печать:

Принтер по умолчанию: талон/чек/рецепт

Формат A5 для рецептов


Оплаты:

Провайдеры (test/prod ключи), включение/выключение


AI:

активный провайдер, ключи, лимиты


Табло:

тема, список роликов, звук




---

10) API (срез, с чем работает регистратура)

POST /api/patients / GET /api/patients?phone=...

POST /api/visits (создать визит)
body: { patient_id, doctor_id, date, services[], type, payment_type }

POST /api/print/ticket — талон (ESC/POS)

POST /api/payments/init — онлайн платёж

POST /api/payments/:id/attach-visit

POST /api/online-queue/qrcode?day&specialist_id

POST /api/online-queue/join — утренний номер

POST /api/online-queue/open?day&specialist_id — закрыть онлайн набор

GET /api/schedule?doctor_id|date — занятость

GET /api/queue/today?specialist_id — текущая очередь (для табло)


Пример POST /api/visits

{
  "patient_id": 123,
  "doctor_id": 7,
  "date": "2025-08-13",
  "services": [{"id": 3, "qty": 1}, {"id": 18, "qty": 1}],
  "type": "paid",
  "payment_type": "online"
}


---

11) События (event‑bus/WebSocket)

queue.created — новая запись

queue.number_assigned — присвоен номер (живая/онлайн)

queue.called — вызов пациента (для табло)

queue.closed — приём открыт (онлайн набор закрыт)

payment.status_changed — обновление статуса оплаты

visit.status_changed — движение визита (planned → queued → in_progress → done|canceled|no_show)



---

12) Безопасность и аудит

RBAC: только registrar/admin видят регистратуру.

Поле телефон — PII: маскирование в списках по настройке (опция).

Логи: каждое добавление/редактирование/оплата/печать/отмена → audit_logs.

Rate‑limit: защита /online-queue/* и /payments/*.

Валидация: телефон/год рождения/обязательные поля/диапазоны.

Антидубликаты: по телефону/Telegram в онлайн‑очереди.



---

13) Производительность

Пагинация и server‑side фильтры (в реестре).

Индексы (см. п.2.2).

Кэш справочников (услуги, МКБ‑10).

Ленивая подгрузка истории пациента.



---

14) Отчётность (что доступно из регистратуры)

Экспорт реестра за день (CSV/PDF).

Сводка оплат (нал/онлайн).

Топ услуг/загруженность по врачам.



---

15) Тест‑чеклист для регистратуры (критично)

1. CRUD запись: создать пациента → визит → печать талона.


2. Онлайн‑очередь: токен → до 07:00 запрещено, после 07:00 до opened_at — выдается номер.


3. Дубликат: один и тот же телефон/Telegram получает тот же номер.


4. Лимит: по достижении N — отказ с корректным текстом.


5. Открыть приём: кнопка закрывает набор онлайн, проверка недоступности join.


6. Спец‑правила: стоматолог онлайн с №3; дерматолог с №15 (проверка стартовых номеров).


7. ЭхоКГ: отметка у кардиолога — пациент появляется во вкладке «ЭхоКГ».


8. Оплаты: нал — печать чека; онлайн — init→webhook→статус→квитанция PDF.


9. Печать: талон/чек на правильном принтере, язык ru/uz.


10. Календарь: цвета статусов, фильтры.


11. RBAC: доступ только ролям registrar/admin.


12. Аудит: события записываются.


13. Локализация: RU/UZ ключи присутствуют.


14. Производительность: реестр 500+ строк — без лагов (пагинация/виртуализация).




---

16) Частные спецификации для вкладок

Кардиолог/ЭхоКГ

Вкладка Кардиолог: чек «ЭхоКГ» — добавляет пациента и в вкладку ЭхоКГ (общая очередь).

Печать: обязательна.

Оплата: консультация + (опц.) ЭхоКГ, чеки раздельно/общим счётом.


Дерматолог‑косметолог

«Процедуры» — чек‑лист (группы «Дерматологические» и «Косметологические»).

Стоимость: из кабинета врача или вручную (настройка — кто главный).

Печать талонов обязательна.


Стоматолог

Онлайн‑очередь без выбора услуги; стартовый № — конфиг (напр., 3).

Оплата консультации до визита (талон «Оплачено»).



---

17) Ошибки/краевые случаи (UX‑подсказки)

Телефон уже зарегистрирован сегодня → подсказать «Найден существующий визит»/«Вернуть в очередь».

Пациент в онлайне получил номер и пришёл без телефона → поиск по ФИО/год/приблизительное время.

Превышение лимита N на врача → предложить запись на другой день.

Потеря принтера → fallback: PDF‑талон с кнопкой «Открыть печать».



---

18) Что настраивается без разработчика

Стартовые номера/лимиты онлайн.

Авто‑закрытие по времени.

Форматы печатных форм (шаблоны Jinja для PDF).

Видимые/обязательные поля формы.

Список услуг и цен.

Роли и доступы.



---

Итог: модуль Регистратуры в текущей финальной версии покрывает полный ежедневный поток: от регистрации и талонов до оплат и передачи в кабинеты/лабораторию/табло. Учтены спец‑правила (кардиология/ЭхоКГ, дерматология/стоматология), утреннее окно онлайн‑очереди (07:00→открытие), уникальность номера, лимиты, печать, локализация, безопасность и отчётность. Если хочешь — добавлю мини‑мануал для регистраторов (1‑страничная «шпаргалка» с картинками шаг за шагом).

Хорошо, тогда дам такой же подробный и полный документ по Админ-панели, как я сделал для Регистратуры.
Опишу всё — назначение, структуру данных, интерфейс, бизнес-правила, доступы, взаимодействие с другими модулями, API, конфиги, тест-чеклист.


---

1) Назначение и роль

Админ-панель — центр управления системой. Предназначена для администраторов и старших менеджеров клиники.
Обеспечивает настройку справочников, ролей, цен, расписаний, интеграций (Telegram, оплаты, AI), а также контроль работы (логи, отчёты, управление расходами и зарплатами).


---

2) Данные и структура (БД)

2.1. Основные сущности

users: id, username, password_hash, role (admin|registrar|doctor|lab_tech|patient), fio?, telegram_id?, active, created_at, last_login.

roles_permissions: role, permission_code (RBAC).

doctors: id, user_id, speciality, cabinet, price_default, active.

services: id, title, code?, category, price, duration?, active.

expenses: id, category, amount, currency, note, created_at.

payroll: id, doctor_id, period_start, period_end, amount, status (pending|paid), created_at.

settings: key, value (JSON), updated_at.

audit_logs: actor_id, event, entity, entity_id, payload, ts.


2.2. Индексы

users(username) (unique)

roles_permissions(role)

doctors(user_id)

services(category, active)

expenses(created_at)

payroll(doctor_id, period_start)



---

3) Разделы и интерфейс

3.1. Панель управления (Dashboard)

Сводка по текущему дню:

Кол-во пациентов, визитов, доход (нал/онлайн).

График посещений за неделю.

ТОП-5 услуг.


Быстрые кнопки: создать пользователя, добавить услугу, открыть логи.



---

3.2. Пользователи

CRUD пользователей.

Поля: логин, пароль, роль, ФИО, активность, привязка к врачу (для doctor).

Возможность сброса пароля.

Фильтры по ролям, активности.



---

3.3. Роли и доступы (RBAC)

Таблица разрешений.

Возможность создать кастомную роль.

Пример: роль cashier с доступом только к оплатам.



---

3.4. Врачи

Список врачей (привязка к пользователю).

Специальность, кабинет, базовая цена.

Расписание:

Таблица (понедельник–воскресенье, время начала/окончания, перерывы).

Экспорт расписания в PDF.


Привязка к услугам.



---

3.5. Услуги

CRUD услуг.

Группировка по категориям (кардиология, дерматология, лаборатория и т.д.).

Поля: название, код (опц.), категория, цена, активность.

Импорт/экспорт CSV.



---

3.6. Расходы

Журнал расходов.

Категории: аренда, материалы, зарплаты, маркетинг, прочее.

Фильтр по периоду/категории.

Экспорт в Excel/PDF.



---

3.7. Зарплаты

История выплат врачам.

Период, сумма, статус (ожидание/выплачено).

Автоматический расчёт % от оказанных услуг.

Экспорт ведомости.



---

3.8. Настройки

Общие:

Название клиники, адрес, логотип.

Часовой пояс, формат даты/времени.


Telegram:

Токен бота.

ID чатов для уведомлений.


Оплаты:

API ключи Click, Payme и т.д.


AI:

Провайдер (OpenAI/Gemini/DeepSeek).

Ключ, модель, лимиты.


Очередь:

Стартовые номера по спец-кабинетам.

Лимиты онлайн-очереди.

Авто-закрытие.


Печать:

Шаблоны квитанций/рецептов.




---

3.9. Логи

Системный журнал:

Авторизация/выход.

Создание/редактирование/удаление сущностей.

Оплаты.


Фильтры по дате/пользователю/событию.



---

4) Взаимодействия с другими модулями

Регистратура:

Админ управляет услугами, ценами, врачами, расписанием.


Врач:

Админ может редактировать расписание врача.


Лаборатория:

Настройки групп анализов, цен.


PWA/Telegram:

Настройка ключей, конфигурации онлайн-записи.


Отчёты:

Данные для анализа доходов, посещаемости.




---

5) API (для админ-панели)

GET /api/admin/dashboard

GET/POST/PUT/DELETE /api/admin/users

GET/POST/PUT/DELETE /api/admin/services

GET/POST/PUT/DELETE /api/admin/doctors

GET/POST/PUT/DELETE /api/admin/expenses

GET/POST/PUT/DELETE /api/admin/payroll

GET/PUT /api/admin/settings

GET /api/admin/logs



---

6) Безопасность

Доступ только ролям admin.

Логи всех действий.

Двухфакторная аутентификация (опция).

Ограничение IP (опция).



---

7) Тест-чеклист

1. Создать пользователя → войти.


2. Задать врачу расписание → отобразилось в регистратуре.


3. Добавить услугу → доступна в регистратуре.


4. Изменить цену услуги → обновлено у врача.


5. Включить/отключить услугу → регистратура видит только активные.


6. Заполнить расходы → видно в отчётах.


7. Выдать зарплату врачу → статус «выплачено».


8. Изменить Telegram-токен → бот работает.


9. Изменить стартовые номера очереди → проверка в регистратуре.


10. Экспорт расходов в PDF/Excel.




---

Если хочешь, я могу добавить сюда детальный UI-flow и скриншотные макеты для каждого раздела админ-панели, чтобы это было похоже на полное руководство.
Хочешь, чтобы я так дополнил?

Хорошо, тогда сделаю подробное техническое и функциональное описание Панели лаборатории, по тому же формату, как для Регистратуры и Админ-панели — с полным разбором структуры, логики, интерфейса, API, взаимодействий и тест-чек-листа.


---

1) Назначение и роль

Панель лаборатории — это рабочее место для лаборантов и сотрудников, выполняющих и оформляющих лабораторные исследования.
Основная задача — приём назначений от врачей и регистратуры, проведение анализов, внесение результатов, прикрепление файлов и управление статусами.


---

2) Данные и структура (БД)

2.1. Основные сущности

lab_requests — заявки на анализы:

id (UUID)

patient_id (связь с patients)

doctor_id (назначивший)

service_id (тип анализа)

status (pending, in_progress, completed, cancelled)

created_at, updated_at

notes (дополнительная информация)


lab_results — результаты анализов:

id

lab_request_id (FK)

result_text (JSON/текст)

file_id (связь с files)

created_at


files:

id, filename, mime_type, path, uploaded_at




---

3) Интерфейс и функциональность

3.1. Главная таблица

Колонки:

№ заявки

ФИО пациента

Дата рождения

Назначивший врач

Услуга (анализ)

Статус

Дата назначения

Дата готовности

Действия (открыть, редактировать, удалить)


Фильтры:

По дате назначения

По статусу

По услуге

По врачу


Поиск:

По ФИО пациента

По номеру заявки




---

3.2. Карточка заявки

Данные пациента (ФИО, возраст, контакты, ID).

Назначивший врач и его специализация.

Тип исследования.

Примечания от врача.

История изменений статусов.



---

3.3. Форма внесения результатов

Текстовое поле для ввода заключения.

Таблица значений (если анализ количественный).

Загрузка файлов (PDF, JPG, PNG).

Автоматическая генерация PDF с результатами по шаблону.

Возможность сохранить как черновик или сразу отправить врачу/пациенту.



---

3.4. Статусы

pending — ожидает выполнения.

in_progress — в процессе выполнения.

completed — готово, результаты загружены.

cancelled — отменено.


При изменении статуса:

Врач получает уведомление (в системе и Telegram).

Пациент получает уведомление о готовности (если привязан Telegram).



---

4) Взаимодействие с другими модулями

Врач:

Назначает лабораторное исследование → заявка появляется в панели лаборатории.

Получает готовый результат (в карточке пациента и в истории).


Регистратура:

Может вручную создать лабораторную заявку (по просьбе пациента).


Пациент (PWA/Telegram):

Видит статус своих анализов.

Может скачать прикреплённый файл результата.




---

5) API эндпоинты

GET /api/lab/requests — список заявок.

GET /api/lab/requests/{id} — получить заявку.

POST /api/lab/requests — создать (регистратура/врач).

PUT /api/lab/requests/{id} — изменить статус/добавить результаты.

POST /api/lab/results — загрузить результаты.

POST /api/files — загрузка файла.

GET /api/files/{id} — скачивание файла.



---

6) Безопасность и доступы

Доступ имеют роли:

lab_tech — полный доступ к своим функциям.

admin — полный доступ.

doctor — только просмотр своих назначений.


Все действия логируются.



---

7) Дополнительные возможности

Массовая печать результатов.

Экспорт журнала анализов в Excel/PDF.

Интеграция с внешними лабораторными системами (LIS).

Шаблоны для ввода типовых анализов (например, ОАК, биохимия).



---

8) Тест-чеклист

1. Врач создаёт назначение → заявка появляется в лаборатории.


2. Лаборант меняет статус на in_progress → отображается у врача.


3. Лаборант загружает файл PDF → врач и пациент могут скачать.


4. Статус completed → уведомления врачу и пациенту.


5. Фильтрация по дате и статусу → выдаёт корректные результаты.


6. Экспорт журнала за месяц → содержит все заявки.




---

Если хочешь, я могу сделать визуальный UI-flow и структуру экранов панели лаборатории с конкретными компонентами React, которые мы используем в проекте.
Хочешь, чтобы я это добавил?

ниже — полный «паспорт» Панели кардиолога (консультация, ЭхоКГ, ЭКГ) в рамках Programma Clinic. Это самостоятельный документ: цели, данные, интерфейс, бизнес‑правила, интеграции (регистратура/лаборатория/оплаты/табло/AI), печать, API, права, тест‑чеклист.

1) Назначение и роль

Кабинет кардиолога объединяет консультацию и ЭхоКГ в общую очередь (выполняет сам кардиолог), а ЭКГ ведётся отдельной очередью (может оформляться как доп. услуга). Панель обеспечивает ведение ЭМК, назначения, файлы (ЭКГ/ЭхоКГ/PDF), печать рецептов/памяток, повторные приёмы и AI‑помощь.


---

2) Данные и структура (БД)

2.1. Основные сущности

patients: id, fio, birth_year, phone, address, telegram_id?.

visits: id, patient_id, doctor_id, date, status (planned|queued|in_progress|done|canceled|no_show), source (desk|online|telegram|pwa), complaint?, diagnosis?, icd10?, total_cost?, draft_json?, created_at.

services (ключевые категории):

consultation.cardiology,

echo.cardiography (ЭхоКГ),

ecg (ЭКГ),

при необходимости — холтер, СМАД и т.п.
поля: id, title, code?, category, price, active.


visit_services: visit_id, service_id, qty, price, note?.

daily_queues: id, day, specialist_id, active, opened_at? (см. онлайн‑окно 07:00).

queue_entries: id, queue_id, number, patient_id?, patient_name, phone?, telegram_id?.

files: id, patient_id, visit_id, kind (ecg|echo|doc|image), path, meta_json (например, прибор/параметры/расшифровка).

payments: id, visit_id?, provider, amount, currency, status, meta, created_at.

lab_requests (если оформляются анализы): как в модуле лаборатории.

audit_logs: действия врача и системные события.


2.2. Индексы (производительность)

visits(doctor_id, date), visits(patient_id, date).

queue_entries(queue_id, phone|telegram_id).

files(visit_id, kind).

payments(visit_id, status).



---

3) Очереди и расписание (кардиология)

3.1. Общая очередь «Кардиолог (Консультация+ЭхоКГ)»

Консультация и ЭхоКГ в одной очереди (кардиолог выполняет ЭхоКГ).

В регистратуре: чекбокс «ЭхоКГ» добавляет услугу и одновременно помещает пациента во вкладку «ЭхоКГ» (для удобного мониторинга), но номер очереди — общий.


3.2. Отдельная очередь «ЭКГ»

ЭКГ — отдельная очередь и талон, но может быть добавлена как доп. услуга в рамках визита.


3.3. Онлайн‑очередь (утреннее окно)

С 07:00 до фактического открытия регистратуры (daily_queues.opened_at).

Уникальность: 1 номер на телефон/Telegram. Повторный запрос → тот же номер.

Лимит номеров/авто‑закрытие — из админ‑настроек профиля кардиолога.


3.4. Календарь врача

Будущие записи: цвета статусов (план/подтвержден/отменён).

Подтверждение пациентом из Telegram/PWA → попадание в живую очередь дня.



---

4) Интерфейс панели кардиолога (UI/UX)

4.1. Верхняя панель (контекст визита)

ФИО, год рождения, телефон (иконка для звонка/копирования), карточка пациента (ссылка).

Номер в очереди / статус визита.

Оплата: виджет статуса (оплачено/ожидание), кнопка «Оплатить» (нал/онлайн).

Кнопки: «Печать талона», «Рецепт A5», «Памятка», «Повторный приём», «Отправить в Telegram».


4.2. Жалобы / Объективные данные / Диагноз

Rich‑text жалоб (react‑quill), маска/валидация для МКБ‑10 (автоподсказки).

Кнопка AI: «Сформировать предварительный диагноз / план обследования» на основе жалоб и прикреплённых данных (ЭКГ/ЭхоКГ/анализы).


4.3. Услуги визита

Список выбранных: «Консультация кардиолога», «ЭхоКГ» (чек), «ЭКГ» (чек), другие (холтер/СМАД).

Редактируемые цены/кол‑во (при праве врача изменять стоимость).

Синхронизация суммы с регистратурой → касса.


4.4. Файлы и исследования (центральный блок)

4.4.1. ЭКГ

Загрузка PDF/XML/SCP/DICOM (если поддерживается прибором) + JPG/PNG (сканы).

Просмотр миниатюр + отдельный просмотрщик: кривые, частота, интервалы (если парсинг).

Кнопка AI‑анализ ЭКГ: извлечь ключевые показатели, предупредить о критичных находках (текст‑резюме).


4.4.2. ЭхоКГ

Загрузка отчётов (PDF), изображений, видео‑клипов (коротких mp4; по настройке).

Поля параметров (опциональная структура): размеры камер, ФВ ЛЖ, клапанные градиенты и т.п.

Кнопка AI‑подсказка: формировать резюме заключения на основе структурных полей/файла.


4.4.3. Прочие документы

Выписки, анализы (PDF/JPG/PNG) — предпросмотр + AI‑интерпретация «кратко для врача».


4.5. Памятка и Рецепт (PDF)

Памятка: выбор шаблона (например, «После ЭхоКГ», «После изменения терапии»), редактирование черновика → генерация PDF → «Печать / Отправить в Telegram / Сохранить в ЭМК».

Рецепт A5: шапка (логотип, реквизиты), пациент, дата, препараты (латинское/коммерческое, дозировки, режим), подпись/штамп — печать на одном принтере для всех панелей.


4.6. Повторный приём

Кнопка «Назначить повтор» → модалка: дата (без времени), опциональные услуги/анализы.

Создание записи (status=planned) → уведомление пациенту (Telegram) → подтверждение в день визита.


4.7. Локализация и тема

RU/UZ/EN; тёмная тема; все подписи/кнопки — через i18n‑ключи.



---

5) Бизнес‑правила (кардиология)

1. Общая очередь консультация+ЭхоКГ (один номер).


2. Отдельная очередь ЭКГ.


3. В регистратуре «ЭхоКГ» как доп.услуга добавляет пациента во вкладку «ЭхоКГ».


4. Печать талона обязательна для консультации и ЭхоКГ/ЭКГ.


5. Врач может редактировать стоимость услуг визита (по настройке роли/клиники).


6. Оплата консультации может быть до визита (онлайн/нал), талон «Оплачено».


7. Фото/файлы — только у врача; регистратура их не видит (видит факты/стоимость).


8. AI‑подсказки: не подменяют диагноз; только рекомендации/черновики.


9. Автосейв черновиков визита каждые 500–800 мс.


10. PDF‑рецепт/памятка — кэширование по (visitId, template, lang).




---

6) Интеграции и взаимодействия

6.1. Регистратура

Передача/приём статусов визита, суммы услуг, печать талона.

Онлайн‑очередь: врач видит номера, регистратура управляет открытием приёма.


6.2. Лаборатория

Назначения анализов из кабинета → заявки в лаборатории → готовность → уведомления врачу/пациенту.


6.3. Табло

Вызов пациента врачом транслируется в табло (WebSocket), кастомные звуки/ролики.


6.4. Оплаты/Касса

Наличные: печать ESC/POS, статус paid.

Онлайн: init → redirect → webhook → статус → квитанция PDF; привязка к визиту.


6.5. AI‑сервисы

Провайдеры: OpenAI/Gemini/Grok/Copilot/DeepSeek; переключение в админке.

Маршруты:

/api/ai/complaint-to-plan — жалобы → обследования/процедуры/МКБ‑кандидаты.

/api/ai/icd-suggest — автоподбор МКБ‑10.

/api/ai/doc-interpret — интерпретация загруженных PDF/изображений.

/api/ai/ecg-interpret / /api/ai/echo-interpret — специализированные подсказки (если включены).




---

7) Печать (спецификация)

7.1. Талон (ESC/POS)

Крупный номер, ФИО/год, дата/время, тип визита (консультация/ЭхоКГ/ЭКГ), кабинет, язык ru/uz.

«Оплачено» — если предоплата была завершена.


7.2. Рецепт A5 (PDF)

Логотип/шапка, пациент, дата, назначения, подпись/штамп.

Печать на общем «медицинском» принтере; A5; фиксированные отступы.


7.3. Памятка (PDF)

Шаблоны: «После коррекции терапии», «После ЭхоКГ/ЭКГ» и т.п.

Отправка в Telegram, сохранение в ЭМК.



---

8) API (срез, специфично для кардиолога)

Очередь/визиты

GET /api/doctor/cardiology/queue/today

POST /api/visits/:id/medical — жалобы/диагноз/МКБ.

POST /api/visits/:id/services — добавить/обновить услуги (консультация/ЭхоКГ/ЭКГ).

POST /api/visits/:id/complete — завершить визит.


Файлы/исследования

POST /api/visits/:id/files?kind=ecg|echo|doc (multipart).

GET /api/visits/:id/files?kind=... — список.

(опц.) POST /api/visits/:id/ecg/parse — парсинг формата SCP/XML.

(опц.) POST /api/visits/:id/echo/params — сохранение структурных параметров.


AI

POST /api/ai/complaint-to-plan

POST /api/ai/icd-suggest

POST /api/ai/ecg-interpret

POST /api/ai/echo-interpret

POST /api/ai/memo-generate


Печать/PDF

POST /api/pdf/prescription (A5)

POST /api/pdf/memo

POST /api/print/ticket


Повторный приём

POST /api/appointments/repeat — { patient_id, doctor_id, date, services? }


Оплаты

POST /api/payments/init / POST /api/payments/:id/attach-visit / POST /api/payments/{provider}/webhook / GET /api/payments/:id




---

9) Права и безопасность

Роли с доступом: doctor(cardiology), admin.

Регистратура не видит прикреплённые ЭКГ/Эхо‑файлы, только факты/стоимости.

Аудит: загрузка/удаление файлов, генерация PDF/печать, изменение стоимости, завершение визита.

Ограничение размера и типов файлов (PDF/JPG/PNG/SCP/XML/DICOM), антивирус/санитайз (по политике).

JWT+RBAC, rate‑limit на AI/файлы/оплаты.



---

10) Производительность

Миниатюры изображений; ленивые превью; асинхронная генерация тяжёлых PDF/AI‑резюме (Celery).

Кэш AI‑результатов для одного и того же файла/шаблона.

Индексация визитов/файлов; пагинация очереди.



---

11) Тест‑чеклист (E2E/интеграция)

1. Очередь: пациент из регистратуры (консультация) → виден у кардиолога.


2. ЭхоКГ: чекбокс в регистратуре → пациент появляется и во вкладке «ЭхоКГ», общая нумерация.


3. ЭКГ: отдельная очередь/талон; добавление как доп. услуга к визиту.


4. Онлайн‑окно: 07:00→opened_at — выдаётся номер; дубликат по телефону/Telegram возвращает прежний номер; лимит N.


5. Жалобы/МКБ: валидация МКБ‑10, автоподсказка; AI выдаёт план обследования.


6. Файлы: загрузка ЭКГ(PDF/SCP/XML) и Эхо(PDF/JPG/MP4) → предпросмотр/метаданные.


7. AI: интерпретация ЭКГ/Эхо — есть текст‑резюме; нет падений на «сложных» файлах.


8. Услуги/стоимость: изменил цену ЭхоКГ → сумма отразилась в регистратуре/кассе.


9. Памятка/Рецепт: генерация PDF, печать на общем принтере, отправка в Telegram.


10. Оплата: нал — печать ESC/POS; онлайн — init→webhook→status=paid→квитанция.


11. Повторный приём: создан без времени, ушло уведомление, по подтверждению попал в очередь дня.


12. Завершение: статус done с логированием; файлы/PDF в ЭМК пациента.


13. RBAC: к панели кардиолога нет доступа у неролевых пользователей.


14. Локализация/тема: RU/UZ; светлая/тёмная.


15. Производительность: очередь 100+ визитов, многофайловые визиты — без лагов.




---

12) Дополнительно (на будущее)

Холтер/СМАД: отдельные сущности с загрузкой длительных записей, авто‑парсинг отчётов, AI‑резюме.

Шаблоны заключений Эхо с параметрами и авто‑расчётами (зоны норм).

Голосовой ввод жалоб/заключений (модуль ASR).

Согласие пациента (PDF под роспись) при начале терапии/обследования.



---

Итог: Панель кардиолога полностью увязана с регистратурой, онлайн‑очередью (с правилами 07:00 → открытие), табло, кассой, лабораторией и AI. Визиты ведутся «под ключ»: от жалоб и файлов ЭКГ/Эхо — до рецепта A5, памятки, оплаты и повторной записи. Если хочешь, могу из этого сделать чек‑лист настройки (какие справочники включить, стартовые номера, лимиты, шаблоны PDF) и положить в админку как «мастер первичной настройки кардиологии».

Хорошо, тогда дам подробный, технически ориентированный и полностью структурированный документ по панели дерматолога-косметолога в том же формате, что мы сделали для кардиолога.


---

1) Назначение и роль

Кабинет дерматолога-косметолога объединяет дерматологические и косметологические услуги в одной панели. Врач ведёт приём, может назначать лабораторные исследования, выполнять косметологические процедуры, прикреплять фото до/после, использовать AI-анализ изображений и формировать рекомендации/памятки.

Важное отличие — акцент на фотодокументацию и шаблонные процедуры (ботулотоксин, пилинг, лазер и др.) с автоматическим проставлением расходных материалов и цен.


---

2) Данные и структура (БД)

2.1. Основные сущности

patients — общая таблица пациентов.

visits — визиты с полями:
id, patient_id, doctor_id, date, status, complaint, diagnosis, icd10, total_cost, draft_json, created_at.

services — основные категории:

consultation.dermatology (консультация)

procedure.cosmetology (процедуры)

skin_diagnostics (дерматоскопия и др.)


visit_services — выбранные услуги визита (с ценой, кол-вом).

queue_entries — очередь на день (отдельная для дерматолога).

files — прикреплённые изображения (JPG/PNG/WebP) и PDF:
kind = before_photo | after_photo | analysis | doc.

procedures_templates — шаблон процедур с:

названием,

списком расходников,

шагами,

стандартным временем,

базовой ценой.


payments — как в других панелях.

audit_logs — фиксация действий.



---

3) Очереди и расписание

3.1. Очередь дерматолога

Живая очередь в регистратуре + запись на будущее.

Онлайн-очередь с начальным номером (например, с №15 — задаётся в админке).

Уникальность номера на телефон/Telegram, лимит номеров в настройках.


3.2. Календарь

Будущие визиты отмечены цветом статуса.

Косметологические процедуры отображаются с иконками по типу процедуры.



---

4) Интерфейс панели дерматолога-косметолога

4.1. Верхний блок

Данные пациента (ФИО, возраст, контакты).

Номер в очереди / статус визита.

Оплата (виджет), кнопка "Оплатить".

Быстрые кнопки: Печать талона, Рецепт, Памятка, Повторный приём, Telegram.


4.2. Жалобы и диагноз

Поле жалоб (Rich-text) с поддержкой фото-вставок (например, высыпания).

Поле "Диагноз" с автоподсказкой по МКБ-10.

AI-кнопка: анализ текста и фото → предварительный диагноз + план лечения.


4.3. Фото-документация

Раздел "Фото ДО / ПОСЛЕ":

Загрузка JPG/PNG/WebP (камера или файл).

Хранение в ЭМК с привязкой к визиту.

Просмотр до/после в режиме "слайдер".


AI-анализ кожи: выявление воспалений, пигментаций, динамики (при сравнении).


4.4. Косметологические процедуры

Выбор из списка шаблонов процедур (ботулотоксин, мезотерапия, лазер, пилинг и т.д.).

Автозаполнение расходных материалов и стоимости.

Возможность редактировать шаги процедуры в визите.

Таймер проведения (для процедур с экспозицией).


4.5. Лабораторные назначения

Кнопка "Назначить анализ" → выбор из справочника лаборатории.

Автоматическая передача заявки в модуль лаборатории.


4.6. Памятки и рецепты

Шаблоны памяток: "После пилинга", "После лазера", "Домашний уход".

Рецепт A5: стандартная форма, печать/Telegram.


4.7. Повторный приём

Модалка с выбором даты и процедуры.

Автоматическое напоминание через Telegram/PWA.



---

5) Бизнес-правила

1. Фото-материалы обязательны для косметологических процедур.


2. Все процедуры должны иметь расходные материалы (для учёта склада).


3. Онлайн-очередь — уникальный номер на контакт, лимит из админки.


4. AI-подсказки — только рекомендательный характер.


5. Врач может изменять цену услуг, если включено в настройках.


6. Памятка обязательна при процедурах с постуходом.




---

6) Интеграции

Регистратура — очередь, оплата, печать талонов.

Лаборатория — назначение анализов.

Касса — оплата нал/онлайн.

AI-сервисы — распознавание кожи, анализ динамики.

Telegram/PWA — фото результатов, напоминания, памятки.



---

7) Печать

Талон — стандартный (номер, ФИО, услуга, кабинет).

Рецепт A5 — лекарства, мази, уходовые средства.

Памятка — PDF с рекомендациями по уходу.



---

8) API

GET /api/doctor/dermatology/queue/today

POST /api/visits/:id/files?kind=before_photo|after_photo

POST /api/ai/skin-analyze — AI-анализ фото.

POST /api/visits/:id/procedure — добавить процедуру.

POST /api/pdf/memo — памятка.



---

9) Права и безопасность

Роли: doctor(dermatology), admin.

Доступ к фото только врачу и админу.

Файлы проверяются на допустимый формат.

Аудит действий: загрузка/удаление фото, изменения процедур.



---

10) Тест-чеклист

1. Пациент из регистратуры появился в очереди дерматолога.


2. Онлайн-очередь с началом №15 работает и не дублирует номера.


3. Загрузка фото до/после работает, AI-анализ даёт результат.


4. Процедура из шаблона заполнила цену и расходники.


5. Памятка после процедуры сгенерировалась в PDF и отправилась в Telegram.


6. Лабораторные назначения отобразились в лаборатории.




---

Если хочешь, я могу в следующем сообщении так же подробно описать панель стоматолога, чтобы у нас была полная документация по каждому врачу. Это упростит финальное ТЗ.
Хочешь, продолжу?

Хорошо, сделаю полный детализированный документ по панели стоматолога, в том же формате, что и для кардиолога и дерматолога-косметолога.


---

1) Назначение и роль

Кабинет стоматолога предназначен для ведения приёма пациентов по стоматологическому профилю: осмотр, лечение, удаление зубов, профилактика, протезирование и т.д.
Особенность — разделение по типам услуг (консультация, лечение, хирургия, ортопедия), работа с схемой зубного ряда, фиксация проведённых манипуляций и материалов, интеграция с кассой и лабораторией (ортопедическая лаборатория или анализы).


---

2) Данные и структура (БД)

2.1. Основные сущности

patients — общая база пациентов.

visits — визиты стоматолога:
id, patient_id, doctor_id, date, status, complaint, diagnosis, teeth_chart_json, total_cost, notes, created_at.

teeth_chart — схема зубов (каждый зуб как отдельная запись):
visit_id, tooth_number, status, procedure, material, cost.

services — справочник услуг стоматолога (консультация, удаление, пломба, чистка, протезирование, имплантация и т.д.).

materials — расходные материалы (пломбировочный материал, коронки, штифты, анестезия и др.).

visit_services — услуги в конкретном визите с ценой и количеством.

files — рентгеновские снимки, фото до/после.

payments — платежи.

lab_orders — заявки в зуботехническую лабораторию (при ортопедии).



---

3) Очередь и расписание

3.1. Очередь стоматолога

В регистратуре и онлайн (начиная с №3 по умолчанию, изменяемо в админке).

Живая очередь на текущий день + возможность записи на будущее.


3.2. Календарь

Будущие приёмы стоматолога отображаются в календаре с цветовой маркировкой по типу процедуры (консультация, лечение, хирургия).



---

4) Интерфейс панели стоматолога

4.1. Верхний блок

Данные пациента: ФИО, возраст, контакты.

Номер в очереди и статус визита.

Виджет оплаты и кнопка "Оплатить".

Быстрые кнопки: Печать талона, Рецепт, План лечения, Повторный приём.


4.2. Жалобы и диагноз

Поле жалоб (Rich-text) с возможностью прикреплять фото или рентген.

Диагноз с возможностью выбора по МКБ-10.


4.3. Схема зубов (Teeth Chart)

Интерактивная схема верхней и нижней челюсти.

Клик по зубу → модалка с выбором процедуры (пломба, удаление, коронка, чистка, имплант и т.д.).

Для каждого зуба можно указать материал, стоимость, комментарий.

Цветовая маркировка по состоянию: здоров, лечен, удалён, протезирован.


4.4. Услуги и материалы

Список доступных стоматологических услуг (с ценой).

Автоматическое добавление расходных материалов при выборе услуги.

Возможность ручного добавления дополнительных материалов.


4.5. Фото и рентген

Загрузка JPG/PNG/WebP и DICOM-файлов (при интеграции с рентген-системами).

Отображение в галерее визита.


4.6. Лабораторные назначения

Для ортопедических работ — заявка в зуботехническую лабораторию с указанием вида протеза, материалов и сроков.


4.7. Рецепты и планы лечения

Генерация PDF рецептов на лекарства или материалы для домашнего ухода.

План лечения: перечень процедур по датам, распечатывается или отправляется в Telegram/PWA пациенту.


4.8. Повторный приём

Модалка с выбором даты и типа приёма.

Автонапоминание пациенту.



---

5) Бизнес-правила

1. Онлайн-очередь начинается с №3 (по умолчанию, можно менять в админке).


2. Все манипуляции должны быть зафиксированы в схеме зубов.


3. Лабораторные заявки обязательны для всех ортопедических работ.


4. Рентген-снимки обязательны перед хирургическими вмешательствами.


5. План лечения фиксируется в системе и доступен пациенту в личном кабинете.




---

6) Интеграции

Регистратура — очередь, оплата, печать талонов.

Зуботехническая лаборатория — заявки.

Касса — оплата нал/онлайн.

PWA/Telegram — отправка планов лечения, рецептов, напоминаний.



---

7) Печать

Талон — стандартный (номер, ФИО, услуга, кабинет).

Рецепт — формат A5, лекарства, средства ухода.

План лечения — PDF с датами, процедурами, материалами.



---

8) API

GET /api/doctor/stomatology/queue/today

POST /api/visits/:id/teeth-chart — сохранить схему зубов.

POST /api/visits/:id/files?kind=photo|xray

POST /api/lab-orders — заявка в зуботехническую лабораторию.

POST /api/pdf/treatment-plan — генерация плана лечения.



---

9) Права и безопасность

Роли: doctor(stomatology), admin.

Доступ к зубной карте и снимкам только врачу и админу.

Файлы проверяются на допустимый формат.

Все действия логируются (изменения зубной карты, назначения процедур).



---

10) Тест-чеклист

1. Пациент из регистратуры появился в очереди стоматолога.


2. Онлайн-очередь начинается с №3 и не дублирует номера.


3. Выбор зуба в схеме открывает модалку с процедурами.


4. Материалы и цена добавляются автоматически при выборе услуги.


5. Рентген загружается и отображается.


6. Лабораторная заявка отправляется и фиксируется в журнале.


7. План лечения генерируется в PDF и отправляется пациенту.




---

Если хочешь, я могу теперь аналогично подробно описать панель регистратора, но с техническим уклоном — там много нюансов по очередям, оплатам и связям с врачами.
Хочешь, перейдём к этому?

ниже — полный “паспорт” Telegram‑бота Programma Clinic: назначение, роли, сценарии, команды, клавиатуры, вебхуки, безопасность, мультиязычность, оплата, печать PDF, интеграция с нашей очередью (утренний QR 07:00), а также примерные схемы БД и фрагменты кода под FastAPI + aiogram.


---

1) Назначение бота

Связь клиники с пациентами и персоналом.

Самостоятельная онлайн‑запись и подтверждение/перенос/отмена.

Утреннее вступление в живую очередь по QR (одно место на телефон/Telegram, окно 07:00 → до открытия).

Уведомления: напоминания о приёме, готовность анализов/документов, сообщения врача.

Платежи: выдача URL на оплату, статус, квитанция PDF, чек (ESC/POS в клинике).

Документы: выдача пациенту PDF‑памяток, рецептов A5, результатов анализов.

Мультиязычность RU/UZ/EN.

Админ‑функции (ограниченно): рассылка, аварийные оповещения, быстрая отправка QR на сегодня.



---

2) Роли пользователей в боте

Пациент (основной): привязка телефона → доступ к своим визитам, оплатам, файлам.

Регистратор/Админ (служебные панели): сервисные команды (ограниченные RBAC).

Врач (опционально): быстрые служебные нотификации (например, свободное окно).


Привязка учётки: телефон → OTP‑код → match с patients.phone, или по ссылке из PWA.


---

3) Основные сценарии

3.1. Онбординг

1. /start → выбор языка RU/UZ/EN (inline‑клавиатура).


2. Запрос телефона (контакт) → OTP → привязка к пациенту.


3. Приветственный экран: «Записаться», «Мои визиты», «Оплатить», «Документы», «Помощь».



3.2. Онлайн‑запись

Ветка: «Записаться на приём» → выбор специалиста → дата → подтверждение.

На карточке слота: стоимость консультации, адрес, правила.

После записи: создаём visit(status=planned, source=telegram), отправляем подтверждение, при желании — сразу платёжную ссылку.


3.3. Утренний QR (живая очередь)

Пациент сканирует QR с плаката/табло → бот получает token.

Бэк проверяет окно 07:00–open, лимит мест, уникальность по telegram_id/phone.

Ответ: «Ваш номер: №N» (дубликату — вернуть прежний номер).

Показываем памятку: «Придите с № к открытию, возьмите документ/полис».


3.4. Напоминания/подтверждения

За день/утром: кнопки в сообщении: Подтвердить / Перенести / Отменить.

Подтвердил → попадает в очередь дня (если визит на сегодня).

Перенести → быстрый диалог выбора даты/кабинета.

Отменить → статус canceled, уведомление регистратуре.


3.5. Оплата

«Оплатить» → выбор визита/счёта → выдаём checkout_url.

После успешной оплаты → авто‑уведомление «Оплачено», кнопка «Скачать квитанцию PDF».

Если нал — показываем инструкцию «оплата на месте» (и QR кассы, если нужно).


3.6. Результаты и документы

«Мои документы» → список: памятки, рецепты, результаты лаборатории, ЭКГ/Эхо отчёты.

Нажатие → отправка PDF/изображения из файлового сервиса.

При появлении нового результата → пуш «Готов результат по анализу Х».


3.7. Стоматология/Дерматология — фото

Опционально: запрос бота загрузить фото ДО из ЛК пациента (если включено) → файл уходит как before_photo в визит (помечаем источником patient).



---

4) Команды и клавиатуры

4.1. Команды (slash)

/start — онбординг + язык.

/help — подсказки по функциям.

/lang — смена языка.

/unlink — отвязать телефон (с подтверждением).

/(service) служебные (только admin/registrar):

/broadcast <текст> — рассылка (rate‑limit + подтверждение).

/qr_today — сгенерировать QR‑ссылку для текущего дня/специалиста.



4.2. Главное меню (reply‑keyboard)

«🗓 Записаться»

«📄 Мои визиты»

«💳 Оплата»

«📎 Документы»

«⚙️ Язык»

«🆘 Помощь»


4.3. Inline‑кнопки (в сообщениях)

Подтвердить / Перенести / Отменить.

Оплатить / Проверить оплату.

Скачать PDF (квитанция/рецепт/памятка/анализ).

Изменить язык RU/UZ/EN.



---

5) Мультиязычность

Язык хранится в telegram_links.lang.

Шаблоны текстов в backend/locales/*.json.

Все ответы — через наш t(lang, key).

Язык можно задать при первом /start или вручную /lang.



---

6) Интеграция с backend (FastAPI)

6.1. Вебхук

POST /api/telegram/webhook — принимает апдейты.

aiogram обрабатывает CallbackQuery, Message, Contact, Photo, Document.

Хендлеры вызывают сервисы: записи, оплата, файлы, PDF.


6.2. Сервисные эндпоинты (срез)

POST /api/queue/join — утренний QR (token, phone?, telegram_id).

POST /api/appointments/create — запись (patient_id, doctor_id, date).

POST /api/appointments/confirm|reschedule|cancel.

POST /api/payments/init / GET /api/payments/:id.

GET /api/patients/:id/docs / GET /api/files/:id.

POST /api/pdf/memo|prescription|receipt.



---

7) Безопасность

Привязка чата ↔ пациент через OTP по телефону.

Любой state‑changing запрос сопровождаем patient_id из связки и проверкой JWT от бота к API.

Rate‑limit по чату и защита от флуд/спама.

Очередь QR: 1 номер на telegram_id/phone в сутки и в конкретной очереди.

Логирование всех действий, маскирование телефонов в логах.

В админ‑командах — whitelisting admin_telegram_ids.



---

8) Структура хранения (БД, срез)

telegram_links
- id
- patient_id (FK -> patients)
- chat_id (int64)
- username?
- phone_normalized
- lang (ru|uz|en)
- created_at, last_active

telegram_sessions
- chat_id
- state (json)          # воронка диалога
- ttl

notifications
- id
- patient_id
- type (appointment_reminder, result_ready, payment, broadcast)
- payload (json)
- sent_at, status


---

9) Текстовые шаблоны (примеры)

[reminder.ru]
Здравствуйте, {{fio}}!
Напоминаем о приёме {{date}} у {{doctor}} ({{service}}).
Подтвердите или выберите действие ниже.

[reminder.uz]
Assalomu alaykum, {{fio}}!
{{date}} kuni {{doctor}} qabuliga eslatma ({{service}}).
Quyida amalni tanlang.

Кнопки: ✅ Подтвердить | 🔁 Перенести | ❌ Отменить

Ответ на подтверждение:

Вы подтверждены. В день визита вы получите номер живой очереди.


---

10) Алгоритмы (ключевые)

10.1. Утренний QR (join)

1. Бот получает token из параметров start.


2. Бот вызывает POST /api/queue/join с telegram_id (и phone, если известен).


3. Бэк:

проверяет время (локаль Asia/Tashkent) — с 07:00 и до opened_at.

проверяет дубликат по telegram_id/phone.

присваивает номер, либо возвращает старый.



4. Бот отвечает: «Ваш номер №N» (или «Вы уже записаны, №N»).



10.2. Напоминание/подтверждение

За 24 ч и/или утром → sendMessage с inline‑кнопками.

Callback:

confirm → visits.status=queued (если сегодня) или planned_confirmed.

reschedule → запускаем воронку выбора даты; сохраняем новый слот.

cancel → status=canceled, пуш регистратуре.



10.3. Оплата

init_payment → checkout_url. Открыть в webview/браузере.

webhook провайдера → status=paid → отправить «Оплачено» и «Квитанция PDF» (ссылка).

На месте: выдаём инструкцию «оплата в кассе», кнопка «Показать QR кассы» (опционально).



---

11) Пример кода (FastAPI + aiogram)

backend/services/telegram_service.py (схематично):

from aiogram import Bot, Dispatcher, F
from aiogram.types import Message, CallbackQuery, ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardButton, InlineKeyboardMarkup
from aiogram.enums import ParseMode

bot = Bot(token=settings.TELEGRAM_BOT_TOKEN, parse_mode=ParseMode.HTML)
dp = Dispatcher()

@dp.message(F.text == "/start")
async def start(m: Message):
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="RU", callback_data="lang:ru"),
         InlineKeyboardButton(text="UZ", callback_data="lang:uz")]
    ])
    await m.answer("Выберите язык / Tilni tanlang:", reply_markup=kb)

@dp.callback_query(F.data.startswith("lang:"))
async def set_lang(cb: CallbackQuery):
    lang = cb.data.split(":")[1]
    link_chat_to_lang(cb.from_user.id, lang)
    await cb.message.edit_text(t(lang, "hello"))
    # показать главное меню (reply-клавиатура)
    kb = ReplyKeyboardMarkup(resize_keyboard=True, keyboard=[
        [KeyboardButton(text=t(lang,"menu.book")), KeyboardButton(text=t(lang,"menu.my_visits"))],
        [KeyboardButton(text=t(lang,"menu.pay")), KeyboardButton(text=t(lang,"menu.docs"))]
    ])
    await cb.message.answer(t(lang,"menu.welcome"), reply_markup=kb)

@dp.message(F.text.contains("Записаться"))
async def book_entry(m: Message):
    lang = get_lang(m.from_user.id)
    # ... диалог выбора врача/даты ...
    await m.answer(t(lang, "book.pick_specialist"))

@dp.callback_query(F.data == "visit:confirm")
async def visit_confirm(cb: CallbackQuery):
    user = get_patient_by_chat(cb.from_user.id)
    visit_id = get_visit_in_context(cb)
    confirm_visit(visit_id, user.patient_id)
    await cb.message.edit_reply_markup(reply_markup=None)
    await cb.message.answer("Подтверждено ✅")

Вебхук‑роут FastAPI:

@router.post("/telegram/webhook")
async def telegram_webhook(request: Request):
    update = await request.json()
    await dp.feed_raw_update(bot=bot, update=update)
    return {"ok": True}

Инициализация вебхука (разово):

curl -X POST "https://api.telegram.org/bot$TOKEN/setWebhook" \
  -d "url=https://<your-domain>/api/telegram/webhook"


---

12) Интеграция PDF/файлов

Визит → POST /api/pdf/memo|prescription → получить URL → sendDocument.

Результаты лаборатории/ЭКГ/Эхо → sendDocument с подписью.

Квитанция об оплате → sendDocument + короткий текст «Спасибо!».



---

13) Настройки (.env)

TELEGRAM_BOT_TOKEN=...
TELEGRAM_ADMIN_IDS=12345678,98765432
TELEGRAM_WEBHOOK_SECRET=...        # опционально, для верификации запросов
BASE_PUBLIC_URL=https://clinic.example.com


---

14) Эксплуатация и мониторинг

Логи в audit_logs с метаданными чата.

Алерты в Telegram‑чат админов при падениях вебхука (Health‑пинг каждые N минут).

Rate‑limit (например, 20 сообщений/мин/пользователь), анти‑флуд.

Хранить минимально необходимые данные (телефон → хеш/нормализация).



---

15) Тест‑чеклист (E2E)

1. /start → язык → привязка телефона через OTP → главное меню.


2. Онлайн‑запись: выбор врача/даты → визит planned → уведомление регистратуре.


3. Накануне визита: пришёл reminder c кнопками; «Подтвердить» меняет статус корректно.


4. Утренний QR: до 07:00 — отказ; с 07:00 до opened_at — выдал номер; повторный запрос → тот же номер.


5. Оплата онлайн: выдал checkout_url → после webhooks статус paid → квитанция PDF.


6. Документы: «Мои документы» → список → скачивание PDF (рецепт/памятка/результат).


7. Мультиязык: RU/UZ текст соответствует словарям.


8. Безопасность: неавторизованному чату не показываются персональные данные.


9. Админ‑рассылка: уходит только whitelisted‑админам/подписчикам, без флуда.


10. Ошибки сети: повторная отправка уведомления по экспоненте, логирование.




---

16) Что уже учтено в нашем проекте

Окно утренней записи 07:00, уникальность по чату/телефону, «Открыть приём» закрывает запись.

Мультиязычность на уровне шаблонов.

Привязка платежей к визиту, success‑страницы, webhooks.

Отправка PDF (рецепт A5, памятка, квитанция, анализы).

Связь с регистратурой/табло/AI.



---

17) Что можно добавить (по желанию)

Голосовые подсказки (STT → текст жалобы → AI).

Smart‑FAQ (навигация по частым вопросам, цены, адрес).

Callback‑кнопка «Перезвоните мне» → тикет в регистратуре.

Инлайн‑бот (поиск талонов прямо из диалога, если понадобится).

Captcha при массовых стартах (защита очереди).



---

Если хочешь, я сразу:

добавлю готовые locales/*.json для всех текстов бота,

проверю, что в текущей Canvas‑версии вебхук, сервис‑методы и шаблоны присутствуют, и где надо — докину недостающие файлы (без создания новых канвасов, а прямым обновлением финальной версии).


ок, даю полный «паспорт» PWA‑модуля Programma Clinic — что это, для кого, архитектура, офлайн‑логика, кэширование, пуши, страницы/флоуы, интеграции (очередь по QR, оплаты, AI, файлы, HEIC), безопасность и чек‑листы. Кодовые фрагменты включил минимально‑достаточные (manifest, SW, примеры API), чтобы сверить с Canvas.


---

1) Что такое наш PWA и для кого

PWA (Progressive Web App) — устанавливаемое веб‑приложение для пациентов и врачей (облегчённый кабинет), работающее офлайн и с push‑уведомлениями. Устанавливается с главной страницы (Add to Home Screen), открывается на полный экран, работает как приложение.

Профили:

Пациент (patient): онлайн‑запись, подтверждение/перенос/отмена, талоны, платежи, документы (памятки, рецепты A5, результаты анализов, ЭКГ/Эхо), загрузка файлов/фото «до/после».

Doctor‑Lite (врач упрощённый): просмотр своих ближайших записей, подтверждение присутствия, быстрые уведомления (опционально, если включено админом).



---

2) Архитектура

Фронтенд: React (наш общий код), отдельный роутинг /pwa/.

i18n: RU/UZ/EN; язык из localStorage и/или Telegram.

Аутентификация: JWT + refresh (по возможности) → хранение в IndexedDB (через wrapper) + runtime‑кэш.

Service Worker (SW): Workbox‑подход:

Static assets: precacheManifest (revisioned).

API: Stale‑While‑Revalidate / Network‑First по типам.

Background Sync: очередь POST‑запросов (например, загрузка фото).


Storage: IndexedDB для черновиков форм, медиа‑кэша (миниатюры), пуш‑ключей; CacheStorage для статических ресурсов.

Push: Web Push (VAPID), при opt‑in подписка → бэкенду.

Timezone: Asia/Tashkent (чётко для расписания, QR‑окна 07:00).



---

3) Офлайн‑модель и кэш‑стратегии

Страницы /pwa/ → App Shell кэшируется и открывается офлайн.

API /api/patients/me, /api/visits/upcoming → Network‑First с fallback к кешированным данным (24–48 ч TTL).

Документы (PDF, изображения) → Cache‑First (при первом открытии). Ограничиваем размер/кол‑во.

Загрузки файлов (фото до/после): сохраняем в IndexedDB → Background Sync → при восстановлении сети автоматическая отправка.

HEIC: конвертация клиент‑сайд в JPEG (если браузер не поддерживает), затем отправка.



---

4) Страницы и флоуы (пациент)

4.1. Онбординг

Выбор языка RU/UZ/EN.

Вход: номер телефона + OTP или связка через Telegram (deep link).

Согласие на офлайн‑хранение и пуши (опционально).


4.2. Главная панель

Ближайший визит: дата/время/врач/кабинет + действия Подтвердить / Перенести / Отменить.

Быстрые карточки: Онлайн‑запись, Мои документы, Оплата, Живая очередь (QR).


4.3. Онлайн‑запись

Выбор специалиста → календарь доступных слотов → подтверждение → визит planned.

В настройках клиники: можно скрыть время (план на день без слотов).


4.4. Утренний QR (живая очередь)

Страница /pwa/queue?token=...:

Показывает текущий статус записи: до 07:00 → «Откроется в 07:00», 07:00–open → «Получен №N» (или «Вы уже записаны №N»), после открытия → «Запись закрыта регистратурой».

Один номер на телефон/Telegram‑чат.

Лимит мест (например, 15 на врача).



4.5. Оплата

Список неоплаченных счетов → Оплатить (Click/Payme и др.) → checkout_url в системном webview → success возвращается в PWA.

Сохранение квитанции PDF (может кэшироваться офлайн).


4.6. Мои документы

Памятки (PDF), рецепты A5 (PDF), результаты анализов, ЭКГ/Эхо (PDF/изображения).

При офлайн доступе — ранее открытые остаются в кэше.


4.7. Фото «до/после» (если разрешено)

Страница загрузки: камера/файл → HEIC→JPEG конверт (если нужно) → локальный preview → отправка (или фоновой sync).

Метаданные: зона/угол/освещение (опционально).



---

5) Страницы и флоуы (Doctor‑Lite)

Календарь на сегодня/неделю.

Список пациентов сегодня: статус подтверждён/неподтверждён, быстрый вызов (триггер табло).

Push уведомления о новых подтверждениях/онлайн‑записях.

Без редактирования медицинских данных (только просмотр расписания и статусов).



---

6) Интеграции

Telegram: deep link (объединённые перевод/язык, подтверждения визитов).

Очередь и табло: подтверждение из PWA копирует логику бота → попадание в очередь дня.

Оплата: общий /api/payments/* + квитанция PDF.

AI‑памятки: пациент может запросить копию памятки, уже сгенерированной врачом.



---

7) Безопасность

JWT → хранение «не в LocalStorage», а в IndexedDB/Memory + HttpOnly refresh (если у нас включён cookie‑поток) или короткий TTL и ротации.

Device binding (по желанию): записываем deviceId, строгая инвалидизация сессии при logout.

CSP/COOP/COEP заголовки для защиты от XSS/дампов (в продакшене за Nginx).

Маскирование PII в логах.

Ограничение офлайн‑кэша по объёму/сроку.



---

8) Манифест, SW и кодовые фрагменты

8.1. public/manifest.json

{
  "name": "Programma Clinic",
  "short_name": "Clinic",
  "description": "Онлайн-запись, очередь, документы и оплата",
  "start_url": "/pwa/",
  "scope": "/",
  "display": "standalone",
  "background_color": "#0B132B",
  "theme_color": "#0B132B",
  "icons": [
    { "src": "/icons/icon-192.png", "sizes": "192x192", "type": "image/png" },
    { "src": "/icons/icon-512.png", "sizes": "512x512", "type": "image/png" }
  ],
  "lang": "ru",
  "prefer_related_applications": false
}

8.2. Базовый Service Worker public/sw.js (концепт)

// Простейшая схема; в проекте используем Workbox/сборку
const APP_SHELL = ["/", "/pwa/", "/offline", "/manifest.json"];
self.addEventListener("install", evt => {
  evt.waitUntil(caches.open("clinic-shell").then(c => c.addAll(APP_SHELL)));
});
self.addEventListener("fetch", evt => {
  const url = new URL(evt.request.url);
  // App Shell для роутов PWA
  if (url.pathname.startsWith("/pwa")) {
    evt.respondWith(
      fetch(evt.request).catch(() => caches.match("/pwa/").then(r => r || caches.match("/offline")))
    );
    return;
  }
  // API стратегия (пример)
  if (url.pathname.startsWith("/api/")) {
    evt.respondWith(
      fetch(evt.request).then(r => {
        const copy = r.clone();
        caches.open("clinic-api").then(c => c.put(evt.request, copy));
        return r;
      }).catch(() => caches.match(evt.request))
    );
    return;
  }
});

> В финале у нас Workbox‑конфиг, стратегии по типам (precache, staleWhileRevalidate, networkFirst, backgroundSync). Привёл простую идею для сверки.



8.3. Подписка на Push (клиент)

async function subscribePush() {
  const reg = await navigator.serviceWorker.ready;
  const sub = await reg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: VAPID_PUBLIC_KEY
  });
  await api.post("/api/push/subscribe", sub); // сохраняем endpoint+keys
}

8.4. Фоновая отправка фото (Background Sync)

// псевдо: сохраняем payload в IndexedDB, регистрируем тег
async function queueUpload(formData){
  await idb.set('upload-queue', Date.now(), formData);
  const reg = await navigator.serviceWorker.ready;
  await reg.sync.register('photo-upload');
}
self.addEventListener('sync', async (evt) => {
  if (evt.tag === 'photo-upload') {
    evt.waitUntil((async () => {
      const items = await id

ниже — полное описание AI‑функций Programma Clinic: архитектура, провайдеры (OpenAI, Gemini, Grok, Copilot, DeepSeek), точки встраивания (дерматолог, кардиолог/ЭхоКГ, стоматолог, лаборатория, регистратура, PWA, Telegram), типы задач (текст, коды МКБ‑10, анализ анализов/ЭКГ/Эхо, OCR/PDF/HEIC, фото‑диагностика кожи и «до/после»), безопасность, логирование, конфигурация, тестирование и контроль качества. Всё спроектировано так, чтобы единый AI‑слой работал одинаково во всех кабинетах, а «специфика» включалась через параметры.


---

1) Цель и принципы

Единый AI‑слой (ai_service) с несколькими провайдерами, переключаемыми из админ‑панели.

Строгие границы медицинской ответственности: AI → рекомендации/подсказки, финальное решение — врач.

Локализация: вход/выход — RU/UZ/EN (на основе выбранного языка пользователя/врача).

Приватность: минимум данных, шифрование файлов, аудит, явное согласие пациента на обработку файлов AI (по политике клиники).

Повторяемость и контроль: семплинг (temperature/top_p), детерминированность (seed), версия шаблонов/подсказок, логи.



---

2) Поставщики (плагины AI)

Папка: backend/services/ai/

openai_provider.py

gemini_provider.py

grok_provider.py

copilot_provider.py (Azure/CoPilot Studio, текст/чаты)

deepseek_provider.py


Каждый провайдер реализует общий интерфейс:

class AIProvider:
    name: str
    async def chat(self, messages: list[dict], **opts) -> AIResult: ...
    async def text(self, prompt: str, **opts) -> AIResult: ...
    async def vision(self, prompt: str, images: list[AIImage], **opts) -> AIResult: ...
    async def ocr(self, file: FileRef, **opts) -> AIDoc: ...        # если нативно доступно
    async def embed(self, texts: list[str], **opts) -> list[vec]: ...

Назначение файла‑провайдера: инкапсулирует аутентификацию, ретраи, лимиты, маппинг опций (temperature, top_p, max_tokens, seed, system_prompt), парсинг ошибок в единый формат.

Комментарий в каждом файле (в Canvas у тебя есть) поясняет: что провайдер умеет и когда его выбирать (например, Vision у Gemini/OpenAI; длинные PDF — лучше через оффлайн OCR → затем LLM).



---

3) Менеджер AI (ядро)

Файл: backend/services/ai/ai_service.py

Функции:

Маршрутизация по задаче: task_type → нужен ли vision/ocr/text, какой провайдер предпочтителен (из админ‑настроек).

Фолбэки: если выбранный провайдер недоступен/ошибся → цепочка fallback (например, OpenAI → Gemini → DeepSeek).

Политики: семплинг, языки, медицинские дисклеймеры, безопасные подсказки.

Кэширование (Redis): дедупликация по хэшу входа, TTL.

Аудит: кто вызвал, какие входные поля отправлялись, какой провайдер ответил, длительность, статус.


Универсальная точка входа:

async def ai_run(task: TaskSpec) -> AIResult:
    # 1) нормализация и валидация входных данных
    # 2) выбор провайдера + режим (text/vision)
    # 3) формирование prompt по шаблону (см. §7)
    # 4) вызов провайдера с ретраями и таймаутом
    # 5) пост‑обработка (JSON‑валидатор, детокс, локализация)
    # 6) кэш, аудит, возврат


---

4) Типы AI‑задач (сквозные «Capabillities»)

4.1. Текст → рекомендации (универсально для всех кабинетов)

Вход: жалобы/анамнез/объективно (текст), возраст/пол, выбранные предварительные услуги.

Выход: структурированный JSON: suggested_procedures[], warnings[], icd10_candidates[], advice_text.

Использование: врач видит карточку «AI‑предложения», может принять/отклонить частично.


4.2. ICD‑10 (кодировка)

Вход: строка диагноза, ключевые симптомы.

Выход: primary_code, alt_codes[], rationale.

Валидация: регулярка формата МКБ‑10; фиксируем источник и версию модели.


4.3. Лабораторные значения → интерпретация

Вход: список показателей (имя, значение, реф.диапазон, единицы), возраст/пол.

Выход: flags{high/low/critical}, possible_causes[], recommendations[], urgency_level, note_for_patient.

UI: подсветка ячеек, кнопка «Вставить в заключение».


4.4. Документы (PDF/JPG/HEIC) → OCR → суммаризация

Вход: файл(ы) — выписки, результаты анализов, заключения исследований, рецепты.

Пайплайн: локальный OCR (Tesseract/PaddleOCR) → текст → LLM‑суммаризация → структурирование (даты, диагноз, назначения).

Выход: summary, extracted_fields{diagnosis, meds, next_date, doctor}, links_to_attach (для ЭМК).

Поддержка HEIC: конверсия → JPEG перед OCR.


4.5. Фото‑анализ (дерматология, стоматология «до/после»)

Вход: одно или два фото (до/после), метаданные (зона/угол/вспышка).

Выход: findings[] (воспаление/пигментация и т.д.), change_score (динамика), care_suggestions.

Предупреждения: низкое качество фото, плохой свет, сильная компрессия.


4.6. ЭКГ/Эхо (кардиология)

Экспорт ЭКГ: PDF/XML/SCP — парсинг ключевых параметров (ЧСС, интервалы, оси), авто‑вывод «подозрительно/норма» (с дисклеймером).

Эхо: из PDF извлекаются измерения (фракция выброса, размеры полостей), генерируется шаблонный раздел заключения (врач редактирует).


4.7. Памятки и рецепты (A5 PDF)

Вход: диагноз/процедуры/препараты/контекст пациента.

Выход: готовый текст RU/UZ, стили под A5, с логотипом; AI адаптирует тон и читаемость.

Кнопки: «Отправить в Telegram», «Печать», «Сохранить в ЭМК».



---

5) Точки встраивания (UI/UX)

Панель врача: кнопки «AI‑подсказка» у разделов Жалобы, Диагноз/МКБ‑10, Процедуры, Анализы; «Сформировать памятку/рецепт (AI)».

Дерматолог‑косметолог: «Анализ фото» (до/после), «Вставить шаблон процедуры», «AI‑памятка по уходу».

Стоматолог: «План лечения (AI)» по выбранным зубам/материалам; суммаризация снимка/рентгена (если в JPG/PDF).

Кардиолог: «Разобрать ЭКГ/Эхо (AI)» → заполнить черновик заключения.

Лаборатория: «AI‑интерпретация набора показателей» для черновика результата.

Регистратура: подсказки о вероятной специализации по жалобе при первичной записи (не активно по умолчанию).

PWA/Telegram: на стороне пациента — только объяснительные тексты/памятки, без клинических диагнозов.



---

6) Админ‑консоль (настройки AI)

Провайдер по умолчанию + порядок фолбэков.

Ключи API (в services/ai/.env или секрет‑хранилище).

Глобальные лимиты: запросов/мин, токены/сутки, размеры файлов.

Профили качества:

Conservative — низкая температура, максимум структурности.

Creative — для текстов памяток/объяснений.


Шаблоны подсказок (prompt templates) в базе: версия/язык/тип задачи.

Согласие на AI для файлов — включено/выключено, текст согласия.



---

7) Промпты (ядро и примеры)

Единая схема:

system: «Ты медицинский ассистент… придерживайся формата JSON, язык вывода = {lang}…» + дисклеймер.

context: описание пациента/аналитики/файлов (кратко).

task: чёткая инструкция что вернуть (JSON‑схема), лимиты.

examples: по возможности, 1–2 мини‑примера.


Пример: Лабораторная интерпретация

system:
  Ты медицинский ассистент. Не ставь диагноз. Дай интерпретацию показателей и рекомендации для врача и пациента.
task:
  На входе список {name,value,unit,refRange,flag?}, возраст, пол, жалобы. Верни JSON:
  {
    "flags": [{"name":"ALT","level":"high","why":"..."}],
    "possible_causes":["..."],
    "recommendations":["..."],
    "urgency":"routine|soon|urgent",
    "patient_note_ru":"коротко и понятно",
    "patient_note_uz":"..."
  }
lang: ru

Пример: МКБ‑10

system: Ты помощник по кодированию МКБ‑10. Верни лучший код и 2 альтернативы.
task:
  Вход: диагноз (ru), ключевые симптомы. Выход: { primary_code:"", alt:["",""], rationale:"" }
constraints:
  Только валидные коды МКБ‑10 вида [A00-Z99(.xxx)].

Пример: Памятка A5

system: Ты должен вернуть только чистый текст памятки для пациента, без "AI" меток.
task:
  Сгенерируй краткую памятку после процедуры {procedure}, учитывая возраст/пол и лекарства. Язык = {lang}.
style:
  короткие абзацы, маркированные списки, запреты/памятки, когда обратиться повторно.


---

8) API (контракты)

POST /api/ai/analyze-text

body: { lang, task: "complaints2plan|icd10|lab", payload: {...}, options? }

resp: { ok, data, provider, usage{tokens}, cached? }


POST /api/ai/vision

body: { lang, task: "derma_photo|before_after", images:[file_ids], meta }

resp: как выше, data с findings/change_score.


POST /api/ai/ocr

body: { file_id, lang, task: "summary|extract_fields" }

resp: { text?, summary?, fields? }


POST /api/ai/prescription

body: { lang, visit_id, meds[], dx, warnings[] }

resp: { html|markdown|text } → дальше → /api/pdf/prescription-a5


Стандарты:

Все ответы AI приводятся к JSON‑схемам (pydantic), валидируются → иначе помечаем как unsafe_format и показываем пользователю аккуратно.



---

9) Безопасность, приватность, соответствие

Политика данных: для AI отправляем только необходимые поля. Если врачу нужен полный документ, сначала анонимизируем (маскируем ФИО/телефон/адрес).

Согласие: для загрузки фото и документов пациентом/PWA — чекбокс согласия на обработку AI.

Хранение ключей: сервер‑сайд, не в клиенте. Ротация ключей по расписанию.

Аудит: таблица ai_audit (время, пользователь, тип задачи, провайдер, статус, токены).

Ограничения: размер файла, формат, анти‑спам, частота вызовов.



---

10) Качество и контроль

Температура: по умолчанию 0.2 для структурных задач; 0.6 для памяток.

Deterministic: seed где доступно (для повторяемости на одинаковом входе).

Валидация: pydantic‑схемы на выход; если невалидно → «мягкий» перегенер.

Снапшоты шаблонов: каждая генерация содержит prompt_version.

A/B: опционально для выбора лучшего шаблона (в админке).

Чёрные списки: списки «медицинских» слов/утверждений, которые нельзя возвращать без фразы‑дисклеймера.



---

11) Логи и метрики

ai_audit: кто/когда/что/сколько, provider, ms.

Метрики: время отклика, % ошибок, доля кэш‑хитов, средний токен/запрос.

Алерты: деградация провайдера → автопереключение и уведомление админу.



---

12) Тестирование

Юнит‑тесты: мок‑провайдера, проверка маршалинга JSON, валидации схем.

Контент‑тесты: «золотые» примеры жалоб/анализов/МКБ → стабильно одинаковый JSON.

Файлы: PDF/HEIC наборы на OCR; проверка извлечённых полей.

E2E: кнопки во врачебных панелях, Telegram/PWA → корректные ответы, локализация.



---

13) Производительность

Кэш (Redis) по хэшу входа/шаблона/версии → экономим токены и время.

Асинхронщина: все AI‑вызовы async, параллельная обработка изображений.

Batch: для ICD‑10 кандидатов/лаб‑профилей можно объединять.

Лимиты: глобальные и per‑user (защититься от лавины).



---

14) Будущее расширение

Structured Output (JSON mode) — когда провайдер гарантирует JSON.

Встроенные клинические калькуляторы (CHA₂DS₂‑VASc, GRACE и др.) — до‑/после AI.

RAG: подключение локальной базы протоколов клиники (векторное извлечение → LLM).

Он‑девайс OCR/vision (для приватности) через локальные модели.



---

15) Связь с интерфейсами (кратко)

Регистратура: AI‑подсказка специализации (по умолчанию выключено).

Кардиолог: ЭКГ/Эхо парсинг → черновик заключения.

Дерматолог: фото‑анализ, шаблоны процедур, уход/памятки.

Стоматолог: план лечения по зубной карте, текстовые объяснения.

Лаборатория: интерпретация профилей, «флаги» и приоритет.

Пациент (PWA/Telegram): только объяснения, памятки, квитанции — без диагнозов.



---

Мини‑пример кода менеджера (схема)

# ai_service.py (концепт)
from .providers import get_provider
from .prompts import build_prompt
from .cache import ai_cache
from .audit import save_ai_audit

async def ai_run(task: TaskSpec) -> dict:
    key = ai_cache.make_key(task)
    if cached := await ai_cache.get(key):
        return {**cached, "cached": True}

    chain = task.providers or settings.AI_CHAIN_DEFAULT   # ["openai","gemini","deepseek"]
    last_err = None
    for name in chain:
        prov = get_provider(name)
        try:
            prompt = build_prompt(task)                   # system/context/task/examples
            if task.mode == "vision":
                res = await prov.vision(prompt.text, task.images, **task.options)
            elif task.mode == "ocr":
                res = await prov.ocr(task.file, **task.options)
            else:
                res = await prov.text(prompt.text, **task.options)
            data = task.postprocess(res)                  # validate JSON, localize, etc.
            await ai_cache.set(key, data, ttl=task.ttl)
            await save_ai_audit(task, provider=name, ok=True, meta=res.usage)
            return {**data, "provider": name}
        except Exception as e:
            last_err = e
            await save_ai_audit(task, provider=name, ok=False, meta={"error": str(e)})
            continue
    raise RuntimeError(f"AI failed: {last_err}")


---

Итого

У нас единая модульная архитектура AI, одна кнопка/метод на всех панелях.

Для каждого профиля врача уже определены «точки» AI (жалобы→план, МКБ‑10, лаборатория, ЭКГ/Эхо, фото‑анализ, памятки/рецепты).

Админ‑панель даёт переключение провайдеров, лимиты, шаблоны и качество.

Закрыты вопросы безопасности, приватности и аудита.

Предусмотрены кэш/фолбэки/валидация и тестирование.


Если хочешь, в следующем шаге пройду по финальному Canvas и точечно добавлю/подправлю:

JSON‑схемы ответов,

набор промптов (ru/uz),

сервисные эндпоинты /api/ai/* (если где-то отсутствуют),

UI‑кнопки и обработчики в кабинетах.


ниже — полный, практичный “паспорт” ЭМК (электронной медкарты) в Programma Clinic: структура данных, экран врача, сценарии приёма (от открытия карточки до выписки), удобства и автоматизации, AI‑подсказки, шаблоны, печать/экспорт, безопасность/аудит, интеграция с очередью/оплатой/лабораторией/Telegram/PWA, и контрольные чек‑листы.


---

1) Что такое ЭМК в нашем проекте

ЭМК — единая медицинская карта пациента, объединяющая:

анкету и идентификаторы,

историю визитов у всех специалистов,

назначения (процедуры, анализы, рецепты),

файлы и изображения (PDF, JPG/PNG/HEIC, DICOM/PDF для ЭКГ/Эхо),

финансовые события (счета/оплаты/чеки),

логи действий и версионирование записей,

согласия и приватность.


Ключевая цель: врач работает в одном экране визита, не переключаясь между модулями: жалобы → диагноз/МКБ‑10 → процедуры/услуги → анализы → файлы → рецепт/памятка → печать/отправка → финал визита (с оплатой и статусом).


---

2) Модель данных (ядро)

2.1. Пациент

patients
id, first_name, last_name, patronymic?, birth_date, sex, phone, email?, address?
external_ids (jsonb), consents (jsonb), created_at

2.2. Визит

visits
id, patient_id(FK), doctor_id(FK), specialty, date, status (planned|queued|in_progress|done|canceled)
complaint(text), anamnesis(text), objective(text)
diagnosis(text), icd10_code(varchar)
notes(text), lang(ru|uz|en)
total_cost(numeric), payment_status(created|pending|paid|partial|canceled)
created_at, updated_at, locked_at? (после закрытия)

2.3. Назначения и услуги

visit_services
id, visit_id, service_id, title, quantity, unit_price, total, group (derma|cosmetology|stom|cardio|general), source(doctor|template|ai)

2.4. Лаборатория

lab_orders
id, visit_id, patient_id, panel, items(jsonb), status, result_text?, result_files[]

2.5. Файлы

files
id, owner_type('visit'|'patient'), owner_id, kind('memo'|'prescription'|'result'|'photo_before'|'photo_after'|'xray'|'ecg'|'echo'|'doc'),
name, mime, size, url, meta(jsonb:{zone,angle,flash,source}), created_at

2.6. Платежи

payments
id, visit_id?, provider, invoice_id?, amount, currency, status, meta(jsonb), created_at

2.7. Журнал/версии

emr_logs
id, actor_id, visit_id, action, before(jsonb), after(jsonb), ts
emr_versions
id, visit_id, snapshot(jsonb), version, ts


---

3) Экран врача: анатомия интерфейса визита

3.1. Шапка

Пациент: ФИО, возраст, пол, ID, телефон (кнопка: открыть историю визитов).

Визит: дата, номер очереди, статус (саницвет), специалист и кабинет.

Оплата: бейдж платежного статуса (оплачено/ожидает), сумма по визиту.

Быстрые действия: «Печать талона», «Рецепт A5», «Памятка», «Повторный приём», «Закрыть визит».


3.2. Вкладки (или вертикальные секции)

1. Жалобы / Анамнез / Объективно

Rich‑text, авто‑сохранение, шаблоны фраз, AI‑подсказка (жалобы → предплан).



2. Диагноз + МКБ‑10

Ввод с автоподсказкой; кнопка «Подобрать МКБ‑10» (AI/справочник), валидатор формата.



3. Процедуры/услуги

Поиск/чек‑лист; группы по профилю (дерма/космет/стом/кардио/general).

Цена редактируема врачом (если разрешено); сумма тянется в регистратуру.

Кнопка «Из шаблона врача» и «AI: предложить по жалобам».



4. Лаборатория / Инструментальные

Назначение панелей (кровь/биохимия/…); чек‑лист; AI‑интерпретация результатов (когда готовы).



5. Файлы

Фото ДО/ПОСЛЕ (JPG/PNG/HEIC): drag‑&‑drop + предпросмотр + миниатюры.

Рентген/ЭКГ/Эхо PDF, DICOM (при наличии): просмотрщик или скачивание.

AI‑OCR/суммаризация документов (выписки/результаты).



6. Рецепт A5 / Памятка

Редактор с шаблонами; быстрая генерация на основе диагноза/процедур;

Кнопки: «Печать», «В Telegram», «В ЭМК (файл)».



7. Повторный приём

Модалка: дата (без времени — логика «в день визита попадёт в очередь»), услуги, напоминание.




3.3. Боковая панель

История визитов (таймлайн): быстропросмотр диагноза/услуг/рецептов, файлы.

Календарь врача (сегодня/неделя).

Статусы: «


Тогда давай сделаем полный, технически и функционально детализированный паспорт модуля Табло в нашем приложении.
Это — отдельный, но тесно связанный с очередью и визитами элемент, который видят пациенты (на мониторах/экранах в зонах ожидания) и персонал (для мониторинга вызовов).


---

1. Назначение

Модуль «Табло» — это экран ожидания и вызова пациентов.
Он отображает:

Текущую очередь по специалистам/кабинетам.

Вызовы в кабинет с номером талона, ФИО/инициалами (по настройке), и назначенным врачом.

Информационные блоки: рекламные баннеры, инструкции, полезные уведомления.


Задача:
— минимизировать голосовые объявления и хаотичность в зале ожидания,
— синхронизировать вызов пациента с очередью, визитом и кабинетом врача.


---

2. Где используется

На мониторах в зоне ожидания (Smart TV/ПК с браузером в полноэкранном режиме).

На информационных киосках.

Может быть открыт в браузере на планшете у администратора (режим контроля).



---

3. Техническая реализация

3.1. Фронтенд

React-компонент DisplayBoard в режиме full-screen.

Верстка адаптирована для Full HD и Ultra-HD.

Цветовые темы (светлая/тёмная) подбираются в админке.

Обновление данных:

WebSocket (/ws/queue) — мгновенное обновление при изменении статуса визита.

Fallback — опрос REST API каждые 5–10 сек.



3.2. Backend

Эндпоинт GET /api/board/state возвращает JSON:


{
  "updated_at": "2025-08-13T14:25:00Z",
  "specialists": [
    {
      "name": "Кардиолог",
      "room": "101",
      "queue": [
        { "ticket": "A008", "status": "in_queue" },
        { "ticket": "A009", "status": "in_queue" }
      ],
      "current_call": { "ticket": "A007", "patient": "Иванов И.И." }
    }
  ],
  "announcements": [
    { "type": "info", "text": "Соблюдайте дистанцию", "lang": "ru" },
    { "type": "banner", "img": "/static/img/banner1.png" }
  ]
}

События WebSocket:

CALL_PATIENT: вызов пациента в кабинет.

QUEUE_UPDATE: изменение состава очереди.

ANNOUNCEMENT_UPDATE: замена баннеров/сообщений.




---

4. Интерфейс табло

4.1. Верхняя панель

Логотип клиники.

Текущее время, дата, день недели.

Название учреждения (многоязычно).


4.2. Основное поле

Две колонки:

1. Вызовы сейчас — крупные карточки:

Номер талона (XX###), крупный шрифт.

Кабинет (иконка 🚪 + №).

ФИО/инициалы (опция — может быть скрыто ради конфиденциальности).

Фото врача (опция).



2. Очередь далее — по каждому специалисту:

До 3–5 номеров в ожидании.

Цветовая подсветка по статусу (ожидание, приглашён, задержка).




4.3. Нижняя панель

Бегущая строка:

Новости клиники, советы, предупреждения.

Многоязычный вывод (RU/UZ/EN).


Блок баннеров:

Изображения / слайды (рекламные акции, партнёры).

Видео (по настройке).




---

5. Логика работы

1. Регистратор или врач переводит визит пациента в статус in_progress → backend отправляет событие CALL_PATIENT.


2. Табло:

показывает карточку пациента в зоне «Вызовы сейчас»;

может воспроизвести звуковой сигнал и/или голосовое оповещение:
«Пациент A007, кабинет 101».



3. После N секунд (настраивается) вызов перемещается в историю и исчезает с табло.


4. Очередь перерисовывается в реальном времени (WebSocket).




---

6. Настройки админки

Тема: цвета, фон, шрифты.

Режим конфиденциальности:

Полное ФИО.

Только инициалы.

Только номер талона.


Количество отображаемых мест в очереди.

Баннеры: загрузка/удаление, порядок, длительность показа.

Видеоролики: список и порядок воспроизведения.

Языки интерфейса.

Время жизни вызова на экране.

Голосовое оповещение:

Вкл/Выкл.

Язык и голос (TTS).

Громкость.


Режим теста: для проверки верстки и медиа.



---

7. Интеграции

Очередь (реестр визитов) → табло берёт данные о статусе пациентов.

Профили врачей — фото, кабинет, специальность.

Регистратура/врач → мгновенный вызов.

PWA/Telegram — можно дублировать вызов на телефон пациента.



---

8. Технические детали развёртывания

Frontend: отдельный route /display (без авторизации, по токену/ключу в URL).

Backend:

сокет /ws/board с аутентификацией по API-ключу;

кэш Redis для быстрой отдачи состояния очереди.


Docker: сервис display может быть встроен в frontend или вынесен отдельно.

Failover: при падении WebSocket переходит на опрос API.



---

9. UX-удобства

Адаптация шрифтов под размер экрана (responsive typography).

Контрастные цвета для дальнего восприятия.

Настройка анимации появления вызова (слайд/вспышка).

Возможность закрепить инфо-сообщение сверху (например, «Сегодня вакцинация бесплатно»).

Встроенный тест-режим для быстрой настройки нового монитора.



---

10. Безопасность и приватность

ФИО можно отключить для защиты персональных данных.

API-ключ для публичного отображения.

Баннеры/видео загружаются только из админки (нет внешних ссылок).

Вся логика вызовов синхронизирована с RBAC — только врач/регистратор может инициировать вызов.



---

Если хочешь, я могу прямо сейчас сделать UI-схему (макет) экрана табло на основе текущей реализации, чтобы у нас был документированный вид для фронтенда.
Хочешь, подготовлю?

ниже — единый, подробный «паспорт» четырёх онлайн‑модулей Programma Clinic: Очередь, Онлайн‑запись, Онлайн‑оплата, Онлайн‑консультация. Всё согласовано с тем, что мы уже реализовали в финальном Canvas (QR‑очередь с окном 07:00→open, уникальность по телефону/Telegram, лимиты, касса/вебхуки, PWA/Telegram, роли).


---

1) Очередь (живая + дневные планы)

1.1. Назначение

Управление живой очередью (утренний QR + приходные пациенты) и плановыми визитами на день (онлайн‑записи).

Единая логика для всех специалистов, с особыми правилами (кардиолог+ЭхоКГ общая очередь; ЭКГ отдельная).


1.2. Бизнес‑правила

Ежедневный сброс нумерации с №1 на специалиста/кабинет.

Утренний QR‑приём:

Доступен с 07:00 локального времени (Asia/Tashkent) до момента «Открыть приём» в регистратуре.

Один номер на Telegram‑чат или телефон (повтор выдаёт тот же номер).

Максимум N мест (напр., 15) на врача.

Авто‑закрытие по времени (напр., 09:00) — опционально.


Онлайн‑записанные на день → попадают в дневной список; после подтверждения пациентом — становятся в живую очередь соответствующего дня (логика «без фиксированного времени» поддерживается).

Регистратор может

замораживать/пропускать номер,

вставлять пустые строки (технические номера для ускорения),

печатать талон сразу при сохранении.



1.3. UI (регистратура)

Вкладки по специалистам/очередям (в т.ч. отдельная «ЭхоКГ» и «ЭКГ»).

Таблица: №, ФИО, год рожд., телефон, тип (платный/повторный/льготный), вид оплаты (нал/карта/онлайн), стоимость, статус, действия (вызов/печать/оплата/отмена).

Кнопки:

«Сгенерировать QR на день» (получаем токен),

«Открыть приём» (закрывает доступ через QR/бота),

«Печать талона», «Вызвать», «Перекинуть к другому врачу».



1.4. Табло

Мгновенные вызовы через WebSocket.

Настройки конфиденциальности: ФИО/инициалы/только номер.


1.5. PWA/Telegram

Страница /pwa/queue?token=... выдаёт номер (или сообщает «вы уже записаны»).

Бот: /start <token> → получить номер; повтор → вернуть тот же.


1.6. Данные/модели (срез)

daily_queues(id, day, specialist_id, active, opened_at)

queue_entries(id, queue_id, number, patient_name?, phone?, telegram_id?, status)


1.7. API (срез)

POST /api/queue/qrcode?day&specialist_id         # токен на день
POST /api/queue/join                              # {token, phone?, telegram_id?} -> номер
POST /api/queue/open                              # day, specialist_id (закрывает утро)
GET  /api/queue/today?specialist_id               # список
POST /api/queue/call/{entry_id}                   # вызов (табло/звук)
POST /api/queue/print-ticket/{entry_id}


---

2) Онлайн‑запись (Appointments)

2.1. Назначение

Пациент заранее выбирает специалиста и дату (со временем или без), подтверждает в Telegram/PWA, видит в календаре врача.


2.2. Бизнес‑правила

Глобально настраиваемые правила начала очереди для онлайн‑талонов (например: кардиолог — с №8, дерматолог — с №15).

Возможность выключить онлайн‑записи по специалисту/дню.

Запись без времени: в день визита — подтверждение → получение порядкового номера и попадание в живую очередь.

Напоминания: T‑1 день и T‑3 часа в Telegram/PWA.

Регистратор может менять статус, объединять с доп‑услугами, печатать талон.


2.3. UI

Публичный виджет/PWA: выбор врача → календарь/дата → подтверждение → чек‑лист визита.

Календарь врача: цветовые статусы (запланировано/подтверждено/отменено), фильтр.


2.4. Данные/модели

appointments(id, patient_id, doctor_id, date, time?, status, created_by, source(web|telegram|registrar))


2.5. API (срез)

GET  /api/appointments/slots?doctor_id&date
POST /api/appointments/create                      # {patient, doctor, date, time?}
POST /api/appointments/{id}/{confirm|cancel|reschedule}
GET  /api/calendar/doctor/{doctor_id}?from&to


---

3) Онлайн‑оплата (Payments)

3.1. Назначение

Безналичная оплата консультаций/услуг/доп‑работ через Click/Payme/....

Чеки (ESC/POS + PDF), привязка к визиту и кассовая панель.


3.2. Поток

1. Регистратор/пациент инициирует платёж (init) → получаем payment_id, checkout_url, qr_payload.


2. Пациент платит в окне провайдера → webhook закончит платеж (status=paid/failed).


3. Визит получает статус оплаты (paid/partial).


4. Печать квитанции PDF или чек на термопринтер (/api/print/receipt).


5. В Telegram/PWA отправляется подтверждение и файл квитанции (по желанию).



3.3. Параметры

Валюта: UZS (по умолчанию), возможно добавление KZT/RUB/…

Провайдеры включаем/выключаем из админки.

Подписи webhook (HMAC) — настраиваются.

Возвраты (refund) — по запросу, ведём логи.


3.4. Данные/модели

payments(id, visit_id?, provider, invoice_id?, amount, currency, status, meta, created_at)


3.5. API (срез)

POST /api/payments/init                              # {provider, amount, currency, meta}
GET  /api/payments/{payment_id}
POST /api/payments/{payment_id}/attach-visit         # связать с визитом
POST /api/payments/{provider}/webhook                # меняет статус
POST /api/pdf/receipt                                # квитанция PDF
POST /api/print/receipt                              # печать на чековый принтер

3.6. UI

Касса: поле пациент, позиции, сумма, метод (нал/онлайн), кнопка «Оплатить».

Плашка «Платёж #ID создан», отслеживание статуса.

Авто‑печать чека при “paid”.



---

4) Онлайн‑консультация (Telemed)

> Включается по желанию клиники. Спроектировано с прицелом на WebRTC видео, чат, обмен файлами, связку с визитом и оплатой.



4.1. Поток пациента

1. В PWA/Telegram выбирает «Онлайн‑консультация» → создаёт заявку (специалист/окно времени/жалобы), прикладывает файлы (PDF/фото, HEIC поддерживается).


2. Оплачивает консультацию (онлайн) → назначается врач.


3. За 5 мин до слота → пуш/Telegram с кнопкой «Зайти в кабинет».


4. Открывается защищённая видеосессия WebRTC (в браузере/мобиле).



4.2. Поток врача

Врач видит в своей «Очереди/Онлайн» заявку; может задать пред‑вопросы в чате.

Во время сессии:

чат (текст/файлы),

просмотр прикреплений,

заполнение ЭМК (жалобы/диагноз/МКБ‑10/назначения),

генерация рецепта A5 и/или памятки,

отправка пациенту (Telegram/PWA) + печать PDF (если нужно).


Завершение: закрыть визит, при необходимости предложить повторный.


4.3. Техника

Сигналинг: WebSocket /ws/telemed/{room} (обмен SDP/ICE),

STUN/TURN (например, coturn) для обхода NAT,

Рекординг — опционально (с отдельным согласием), хранение шифрованно; по умолчанию выключено.


4.4. Безопасность/согласия

Перед видеосессией — чекбокс согласия (запись/обработка данных).

Обмен мед‑файлами: по защищённым ссылкам с TTL.

Жёсткая RBAC: доступ только врачу и пациенту конкретной сессии.


4.5. Данные/модели

telemed_sessions(id, appointment_id, patient_id, doctor_id, room_id, status, started_at, ended_at, meta)

Логи сообщений/событий (при необходимости).


4.6. API (срез)

POST /api/telemed/create                       # заявка + проверка оплаты
GET  /api/telemed/{session_id}/token           # гостевой токен (пациент/врач)
WS   /ws/telemed/{room}                        # сигналинг WebRTC
POST /api/telemed/{session_id}/close


---

5) Сквозные связи между модулями

Очередь ↔ Онлайн‑запись
Онлайн‑записи в день визита при подтверждении → занимают место в живой очереди (учитывая стартовый номер по специальности).

Очередь/Запись ↔ Оплата
Визиты, отмеченные как «платные», требуют «paid/partial» до закрытия.

Оплата ↔ Онлайн‑консультация
Для видеовизита проверяем статус платежа; без оплаты — доступ ограничен (опционально допускается «до оплаты» на 5 мин).

Врач (ЭМК) ↔ Оплата/Чеки/Документы
Памятки/рецепты/квитанции — PDF + отправка в Telegram/PWA + история в ЭМК.

Табло ↔ Очередь
Вызов пациента (статус визита/очереди) транслируется на дисплеи.



---

6) Роли, права, безопасность

Админ: настройки провайдеров оплаты, начало онлайн‑номеров, включение/выключение модулей, телемед (TURN/политики), баннеры табло.

Регистратор: управление очередью, печать талонов, создание/перенос записей, приём оплаты (нал/онлайн), запуск «Открыть приём».

Врач: ведение визита/ЭМК, онлайн‑консультирование, AI‑инструменты, документы PDF, повторные приёмы.

Пациент (PWA/Telegram): запись, подтверждение, оплата, документы, файлы.

RBAC на API, JWT, аудит логов.



---

7) Набор проверок и граничных случаев

Очередь:

попытка получить второй номер → вернуть прежний;

до 07:00 → «ещё не открыто»; после «Открыть приём» → «закрыто»;

заполнение лимита мест → «мест нет»;

телефон маскируется при показе в UI (для персонала — полная версия).


Онлайн‑запись:

нет слотов/выключено админом → корректное сообщение;

auto‑cancel по не подтверждённым визитам (опционально).


Оплата:

«pending» без webhook → повторный статус‑поллинг;

«failed» → показать инструкции;

чеки/квитанции — всегда доступны в PDF из ЭМК.


Онлайн‑консультация:

проблемы сети/WebRTC → fallback‑чат, перезапуск медиа;

TURN недоступен → подсказка «перейдите на Wi‑Fi без CGNAT»;

пациент не пришёл → soft‑cancel с авто‑уведомлением и ссылкой на перенос.




---

8) Чек‑лист внедрения (быстрая валидация)

Очередь: QR 07:00→open, лимиты, дубликаты по телефону/Telegram, кнопка «Открыть приём», талон, табло.

Онлайн‑запись: календарь врача, подтверждение, перенос/отмена, днёвки без времени, стартовые номера.

Оплата: init→redirect→webhook→paid, чек ESC/POS + PDF, касса, привязка к визиту.

Онлайн‑консультация: заявка→оплата→сессия WebRTC→документы→закрытие визита.

Роли и доступы, i18n RU/UZ, тёмная тема, PWA/Telegram связки, AI‑кнопки у врача.



---

Функция активации приложения в проекте Clinic Queue Manager реализована как система лицензирования и защиты, которая позволяет:

контролировать использование приложения на устройствах;

ограничивать срок действия лицензии;

разделять режимы доступа: демо, прод, истёкшая лицензия и т.д.


Вот полное и технически точное описание этой функции:


---

📌 1. Цель функции активации

Защита от несанкционированного использования.

Контроль количества активированных устройств/пользователей.

Возможность отключать, блокировать или продлевать лицензию через центральный админ-интерфейс.

Поддержка оффлайн-режима с токенами.



---

🧱 2. Архитектура и структура

2.1. Компоненты

Компонент	Назначение

activation_key	Уникальный ключ активации, генерируемый админом
machine_hash	Уникальный ID устройства (хеш по MAC, CPU, UUID)
activation_token	Токен, подтверждающий успешную активацию
activation_expiry_date	Срок действия лицензии
activation_status	active / expired / revoked / trial
activation_check.py	Проверка активации при запуске
admin/activation_panel	Интерфейс управления активациями


2.2. База данных (activations)

class Activation(Base):
    id: UUID
    key: str
    machine_hash: str
    expiry_date: datetime
    status: Enum('active', 'expired', 'revoked', 'trial')
    created_at: datetime
    updated_at: datetime


---

🔐 3. Механика активации

3.1. Генерация ключа

Администратор генерирует activation_key через панель или CLI.

Варианты: срок действия (30, 90, 365 дней), ограничение на устройство или группу.


3.2. Активация

1. Пользователь запускает приложение.


2. При первом запуске:

отображается окно активации;

пользователь вводит activation_key.



3. Приложение отправляет:

ключ,

хеш машины (генерируется локально),

время/версию.



4. Бэкенд:

сверяет ключ,

проверяет не использовался ли на другом устройстве (если запрещено),

генерирует activation_token и возвращает.



5. Локально сохраняется activation_token → подписанный JWT/шифр.


6. Все последующие запуски проверяют локальный токен (оффлайн режим).



3.3. Проверка активации

На старте приложения:

validate_token() → валиден? срок не истёк? подпись верна?

нет — потребовать повторную активацию.




---

🌐 4. Режимы работы

Режим	Возможности

Trial	Ограниченные функции, срок 7–30 дней
Active	Полный доступ
Expired	Блокировка функций, сообщение пользователю
Revoked	Немедленная блокировка, сброс токена



---

🛠 5. Админ-интерфейс управления

Доступно в админке (/admin/activation):

Таблица всех активаций:

ключ, устройство, дата, статус, кто активировал, версия ПО


Действия:

✅ Выдать ключ

❌ Заблокировать

⏳ Продлить

🔄 Сбросить токен


Отчёты: количество активных ключей, использованных устройств, регионов



---

🔁 6. Интеграции и особенности

Сборка PyInstaller/InnoSetup:

проверка активации встроена в main.py и electron.js (если PWA в оболочке);


Telegram-уведомления при новой активации (если включено);

Интеграция с системой лицензирования 1С или гос‑реестром (опционально);

Работа без интернета: валидный токен позволяет запуск даже офлайн.



---

💬 7. UI/UX интерфейс пользователя

Диалог при первом запуске:

поле для ключа;

кнопка «Активировать»;

информация о статусе.


В настройках:

раздел «Лицензия»:

статус,

дата окончания,

ID устройства,

«Переактивировать» (если сменилось устройство).





---

⚠️ 8. Обработка ошибок

Ошибка	Сообщение пользователю

Ключ не найден	«Неверный ключ активации. Проверьте ввод.»
Ключ уже активирован	«Этот ключ уже используется на другом устройстве.»
Лицензия истекла	«Срок действия лицензии истёк.»
Токен подделан / устарел	«Ошибка проверки лицензии. Переактивируйте.»
Нет связи с сервером	«Нет соединения с сервером активации. Повторите позже.»


9. Кнопка «Запросить ключ» или «Получить демо-доступ»

Чтобы пользователь не остался в тупике, при отсутствии ключа должна быть:

Кнопка «Получить ключ» — открывает:

либо форму обратной связи;

либо переход на сайт/телеграм для запроса;

либо создание заявки в базе данных.


Возможность отправить:

Имя клиники,

Email / Телефон,

Устройство / локацию (machine_id).