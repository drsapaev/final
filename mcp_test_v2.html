<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Test - –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin: 15px 0;
        }
        input, textarea, button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .result.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .result.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .auth-status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .auth-status.success {
            background-color: #d4edda;
            color: #155724;
        }
        .auth-status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .chip {
            display: inline-block;
            padding: 4px 8px;
            background-color: #e9ecef;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
        }
    </style>
</head>
<body>
    <h1>üè• MCP Test - –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</h1>
    <p><strong>–í–µ—Ä—Å–∏—è:</strong> 2.0 (—Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏)</p>
    
    <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
    <div class="container">
        <h2>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
        <div class="section">
            <h3>–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h3>
            <input type="text" id="username" placeholder="Username" value="mcp_test">
            <input type="password" id="password" placeholder="Password" value="test123">
            <button onclick="getAuthToken()">–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
            <div id="authResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <!-- –ê–Ω–∞–ª–∏–∑ –∂–∞–ª–æ–± -->
    <div class="container">
        <h2>ü©∫ –ê–Ω–∞–ª–∏–∑ –∂–∞–ª–æ–±</h2>
        <div class="section">
            <h3>–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∂–∞–ª–æ–±—ã –ø–∞—Ü–∏–µ–Ω—Ç–∞</h3>
            <textarea id="complaintText" placeholder="–í–≤–µ–¥–∏—Ç–µ –∂–∞–ª–æ–±—ã –ø–∞—Ü–∏–µ–Ω—Ç–∞..." rows="3">–°–∏–ª—å–Ω–∞—è –≥–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å –∏ —Ç–æ—à–Ω–æ—Ç–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 2 –¥–Ω–µ–π</textarea>
            <button id="complaintBtn" onclick="analyzeComplaint()">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∂–∞–ª–æ–±—ã</button>
            <div id="complaintResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ú–ö–ë-10 -->
    <div class="container">
        <h2>üìã –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ú–ö–ë-10</h2>
        <div class="section">
            <h3>–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥—ã –ú–ö–ë-10 –ø–æ —Å–∏–º–ø—Ç–æ–º–∞–º</h3>
            <input type="text" id="symptoms" placeholder="–°–∏–º–ø—Ç–æ–º—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)" value="–≥–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å, —Ç–æ—à–Ω–æ—Ç–∞, —Å–≤–µ—Ç–æ–±–æ—è–∑–Ω—å">
            <input type="text" id="diagnosis" placeholder="–î–∏–∞–≥–Ω–æ–∑ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" value="–ú–∏–≥—Ä–µ–Ω—å">
            <button id="icd10Btn" onclick="suggestICD10()">–ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ú–ö–ë-10</button>
            <div id="icd10Result" class="result" style="display: none;"></div>
        </div>
    </div>

    <!-- –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –∞–Ω–∞–ª–∏–∑–æ–≤ -->
    <div class="container">
        <h2>üß™ –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –∞–Ω–∞–ª–∏–∑–æ–≤</h2>
        <div class="section">
            <h3>–ü—Ä–æ–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–æ–≤</h3>
            <textarea id="labResultsText" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON..." rows="5">[
  {
    "name": "–ì–µ–º–æ–≥–ª–æ–±–∏–Ω",
    "value": "120",
    "unit": "–≥/–ª",
    "reference": "120-160"
  },
  {
    "name": "–õ–µ–π–∫–æ—Ü–∏—Ç—ã",
    "value": "15.2",
    "unit": "√ó10‚Åπ/–ª",
    "reference": "4.0-9.0"
  },
  {
    "name": "–°–û–≠",
    "value": "25",
    "unit": "–º–º/—á",
    "reference": "2-15"
  }
]</textarea>
            <button id="labBtn" onclick="interpretLabResults()">–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–∞–ª–∏–∑—ã</button>
            <div id="labResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <!-- –ü–æ–∏—Å–∫ –ú–ö–ë-10 -->
    <div class="container">
        <h2>üîç –ü–æ–∏—Å–∫ –ú–ö–ë-10</h2>
        <div class="section">
            <h3>–ù–∞–π—Ç–∏ –∫–æ–¥—ã –ú–ö–ë-10 –ø–æ –∑–∞–ø—Ä–æ—Å—É</h3>
            <input type="text" id="searchQuery" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞..." value="–º–∏–≥—Ä–µ–Ω—å">
            <button id="searchBtn" onclick="searchICD10()">–ù–∞–π—Ç–∏ –∫–æ–¥—ã</button>
            <div id="searchResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:8000/api/v1';
        let authToken = null;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = async function() {
            try {
                const response = await fetch(`${BASE_URL}/health`, {
                    mode: 'cors',
                    credentials: 'omit'
                });
                if (response.ok) {
                    console.log('‚úÖ Backend —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω');
                    document.body.style.borderTop = '5px solid #28a745';
                } else {
                    console.log('‚ö†Ô∏è Backend —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                    document.body.style.borderTop = '5px solid #ffc107';
                }
            } catch (error) {
                console.log('‚ùå Backend —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', error.message);
                document.body.style.borderTop = '5px solid #dc3545';
            }
        };

        function getAuthHeaders() {
            const headers = {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
            };
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }
            return headers;
        }

        function checkAuth() {
            if (!authToken) {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏!');
                return false;
            }
            return true;
        }

        // –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function getAuthToken() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('authResult');
            
            try {
                const response = await fetch(`${BASE_URL}/auth/minimal-login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    mode: 'cors',
                    credentials: 'omit',
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.access_token;
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω!\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${data.user.username}\n–†–æ–ª—å: ${data.user.role}\n–¢–æ–∫–µ–Ω: ${authToken.substring(0, 50)}...`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${data.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`;
            } finally {
                resultDiv.style.display = 'block';
            }
        }

        // –ê–Ω–∞–ª–∏–∑ –∂–∞–ª–æ–±
        async function analyzeComplaint() {
            if (!checkAuth()) return;
            
            const complaint = document.getElementById('complaintText').value;
            const resultDiv = document.getElementById('complaintResult');
            const btn = document.getElementById('complaintBtn');
            
            btn.disabled = true;
            btn.textContent = '–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º...';
            
            try {
                const response = await fetch(`${BASE_URL}/mcp/complaint/analyze`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        complaint: complaint,
                        patient_age: 45,
                        patient_gender: 'female',
                        urgency_assessment: true
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –∂–∞–ª–æ–±
                    let formattedResult = '‚úÖ –ê–Ω–∞–ª–∏–∑ –∂–∞–ª–æ–± –≤—ã–ø–æ–ª–Ω–µ–Ω!\n\n';
                    
                    if (data.data) {
                        const analysis = data.data;
                        
                        if (analysis.preliminary_diagnosis && analysis.preliminary_diagnosis.length > 0) {
                            formattedResult += 'üîç –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∏–∞–≥–Ω–æ–∑—ã:\n';
                            analysis.preliminary_diagnosis.forEach((diagnosis, index) => {
                                formattedResult += `${index + 1}. ${diagnosis}\n`;
                            });
                            formattedResult += '\n';
                        }
                        
                        if (analysis.examinations && analysis.examinations.length > 0) {
                            formattedResult += 'üî¨ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è:\n';
                            analysis.examinations.forEach((exam, index) => {
                                formattedResult += `${index + 1}. ${exam.name} (${exam.type})\n`;
                                formattedResult += `   –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: ${exam.reason}\n\n`;
                            });
                        }
                        
                        if (analysis.lab_tests && analysis.lab_tests.length > 0) {
                            formattedResult += 'üß™ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ –∞–Ω–∞–ª–∏–∑—ã:\n';
                            analysis.lab_tests.forEach((test, index) => {
                                formattedResult += `${index + 1}. ${test}\n`;
                            });
                            formattedResult += '\n';
                        }
                        
                        if (analysis.consultations && analysis.consultations.length > 0) {
                            formattedResult += 'üë®‚Äç‚öïÔ∏è –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤:\n';
                            analysis.consultations.forEach((consultation, index) => {
                                formattedResult += `${index + 1}. ${consultation}\n`;
                            });
                            formattedResult += '\n';
                        }
                        
                        formattedResult += `‚ö° –°—Ä–æ—á–Ω–æ—Å—Ç—å: ${analysis.urgency || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}\n`;
                        
                        if (analysis.red_flags && analysis.red_flags.length > 0) {
                            formattedResult += '\nüö® –¢—Ä–µ–≤–æ–∂–Ω—ã–µ —Å–∏–º–ø—Ç–æ–º—ã:\n';
                            analysis.red_flags.forEach((flag, index) => {
                                formattedResult += `${index + 1}. ${flag}\n`;
                            });
                        }
                    } else {
                        formattedResult += JSON.stringify(data, null, 2);
                    }
                    
                    resultDiv.textContent = formattedResult;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${data.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`;
            } finally {
                resultDiv.style.display = 'block';
                btn.disabled = false;
                btn.textContent = '–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∂–∞–ª–æ–±—ã';
            }
        }

        // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ú–ö–ë-10
        async function suggestICD10() {
            if (!checkAuth()) return;
            
            const symptoms = document.getElementById('symptoms').value.split(',').map(s => s.trim());
            const diagnosis = document.getElementById('diagnosis').value;
            const resultDiv = document.getElementById('icd10Result');
            const btn = document.getElementById('icd10Btn');
            
            btn.disabled = true;
            btn.textContent = '–ü–æ–ª—É—á–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏...';
            
            try {
                const response = await fetch(`${BASE_URL}/mcp/icd10/suggest`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        symptoms: symptoms,
                        diagnosis: diagnosis,
                        max_suggestions: 5
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞
                    if (data.data && data.data.clinical_recommendations) {
                        // –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç: –¥–µ—Ç–∞–ª—å–Ω—ã–µ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                        resultDiv.innerHTML = `
                            <div style="text-align: left; font-family: monospace; white-space: pre-wrap; background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                                <strong>‚úÖ –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ú–ö–ë-10 –ø–æ–ª—É—á–µ–Ω—ã!</strong>
                                <br><br>
                                ${data.data.clinical_recommendations}
                            </div>
                        `;
                    } else if (data.data && data.data.suggestions) {
                        // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç: —Å–ø–∏—Å–æ–∫ –∫–æ–¥–æ–≤
                        let formattedResult = '‚úÖ –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ú–ö–ë-10 –ø–æ–ª—É—á–µ–Ω—ã!\n\n';
                        formattedResult += 'üìã –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ –∫–æ–¥—ã –ú–ö–ë-10:\n\n';
                        data.data.suggestions.forEach((item, index) => {
                            formattedResult += `${index + 1}. ${item.code} - ${item.name || item.description}\n`;
                            formattedResult += `   –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: ${item.relevance || '–≤—ã—Å–æ–∫–∞—è'}\n\n`;
                        });
                        resultDiv.textContent = formattedResult;
                    } else {
                        resultDiv.textContent = '‚úÖ –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ú–ö–ë-10 –ø–æ–ª—É—á–µ–Ω—ã!\n\n' + JSON.stringify(data, null, 2);
                    }
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${data.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`;
            } finally {
                resultDiv.style.display = 'block';
                btn.disabled = false;
                btn.textContent = '–ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ú–ö–ë-10';
            }
        }

        // –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –∞–Ω–∞–ª–∏–∑–æ–≤
        async function interpretLabResults() {
            if (!checkAuth()) return;
            
            const resultsText = document.getElementById('labResultsText').value;
            const resultDiv = document.getElementById('labResult');
            const btn = document.getElementById('labBtn');
            
            btn.disabled = true;
            btn.textContent = '–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ–º...';
            
            try {
                const results = JSON.parse(resultsText);
                
                const response = await fetch(`${BASE_URL}/mcp/lab/interpret`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        results: results,
                        patient_info: {
                            age: 35,
                            gender: 'female'
                        }
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ –∞–Ω–∞–ª–∏–∑–æ–≤
                    let formattedResult = '‚úÖ –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –∞–Ω–∞–ª–∏–∑–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!\n\n';
                    
                    if (data.data && data.data.ai_interpretation) {
                        const ai = data.data.ai_interpretation;
                        
                        formattedResult += `üìä ${ai.summary}\n\n`;
                        
                        if (ai.abnormal_values && ai.abnormal_values.length > 0) {
                            formattedResult += '‚ö†Ô∏è –û—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç –Ω–æ—Ä–º—ã:\n';
                            ai.abnormal_values.forEach((item, index) => {
                                formattedResult += `${index + 1}. ${item.parameter}: ${item.value}\n`;
                                formattedResult += `   ${item.interpretation}\n`;
                                formattedResult += `   –ö–ª–∏–Ω–∏—á–µ—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ${item.clinical_significance}\n\n`;
                            });
                        }
                        
                        if (ai.possible_conditions && ai.possible_conditions.length > 0) {
                            formattedResult += 'üîç –í–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è:\n';
                            ai.possible_conditions.forEach((condition, index) => {
                                formattedResult += `${index + 1}. ${condition}\n`;
                            });
                            formattedResult += '\n';
                        }
                        
                        if (ai.recommendations && ai.recommendations.length > 0) {
                            formattedResult += 'üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:\n';
                            ai.recommendations.forEach((rec, index) => {
                                formattedResult += `${index + 1}. ${rec}\n`;
                            });
                            formattedResult += '\n';
                        }
                        
                        formattedResult += `üö® –°—Ä–æ—á–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è: ${ai.urgency === '–¥–∞' ? '–¢—Ä–µ–±—É–µ—Ç—Å—è' : '–ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è'}\n`;
                    } else {
                        formattedResult += JSON.stringify(data, null, 2);
                    }
                    
                    resultDiv.textContent = formattedResult;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${data.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
            } finally {
                resultDiv.style.display = 'block';
                btn.disabled = false;
                btn.textContent = '–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–∞–ª–∏–∑—ã';
            }
        }

        // –ü–æ–∏—Å–∫ –ú–ö–ë-10
        async function searchICD10() {
            if (!checkAuth()) return;
            
            const query = document.getElementById('searchQuery').value;
            const resultDiv = document.getElementById('searchResult');
            const btn = document.getElementById('searchBtn');
            
            btn.disabled = true;
            btn.textContent = '–ò—â–µ–º...';
            
            try {
                const response = await fetch(`${BASE_URL}/mcp/icd10/search?query=${encodeURIComponent(query)}`, {
                    headers: getAuthHeaders()
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ú–ö–ë-10
                    let formattedResult = '‚úÖ –ü–æ–∏—Å–∫ –ú–ö–ë-10 –≤—ã–ø–æ–ª–Ω–µ–Ω!\n\n';
                    
                    if (data.data && data.data.results) {
                        formattedResult += `üîç –ù–∞–π–¥–µ–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: ${data.data.total_found}\n`;
                        formattedResult += `üìù –ó–∞–ø—Ä–æ—Å: "${data.data.query}"\n\n`;
                        
                        if (data.data.results.length > 0) {
                            formattedResult += 'üìã –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫–æ–¥—ã:\n\n';
                            data.data.results.forEach((item, index) => {
                                formattedResult += `${index + 1}. ${item.code} - ${item.description}\n`;
                                formattedResult += `   –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${item.category}\n`;
                                formattedResult += `   –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ: ${Math.round((item.match_score || 1) * 100)}%\n\n`;
                            });
                        } else {
                            formattedResult += '‚ùå –ö–æ–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã\n';
                        }
                    } else {
                        formattedResult += JSON.stringify(data, null, 2);
                    }
                    
                    resultDiv.textContent = formattedResult;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${data.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`;
            } finally {
                resultDiv.style.display = 'block';
                btn.disabled = false;
                btn.textContent = '–ù–∞–π—Ç–∏ –∫–æ–¥—ã';
            }
        }
    </script>
</body>
</html>
